name: Build and Push Docker Image

on:
  push:
    branches:
      - master
    tags:
      - 'v*'

env:
  REGISTRY: docker.io
  IMAGE_NAME: a7413498/${{ github.event.repository.name }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 1. 检出代码
      - name: 检出代码
        uses: actions/checkout@v4

      # 2. 设置Docker Buildx
      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. 登录Docker Hub
      - name: 登录Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4. 提取Docker元数据
      - name: 提取Docker元数据
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix=sha-,format=long
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      # 5. 构建并推送Docker镜像
      - name: 构建并推送Docker镜像
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 6. 企业微信通知 - 成功
      - name: 企业微信通知 - 构建成功
        if: success()
        continue-on-error: true
        env:
          WECHAT_CORP_ID: ${{ secrets.WECHAT_CORP_ID }}
          WECHAT_CORP_SECRET: ${{ secrets.WECHAT_CORP_SECRET }}
          WECHAT_AGENT_ID: ${{ secrets.WECHAT_AGENT_ID }}
          WECHAT_TO_USER: ${{ secrets.WECHAT_TO_USER }}
          WECHAT_API_URL: ${{ secrets.WECHAT_API_URL }}
        run: |
          if [ -z "$WECHAT_CORP_ID" ] || [ -z "$WECHAT_CORP_SECRET" ] || [ -z "$WECHAT_AGENT_ID" ] || [ -z "$WECHAT_TO_USER" ]; then
            echo "未配置企业微信通知，跳过"
            exit 0
          fi

          case "$WECHAT_AGENT_ID" in
            (*[!0-9]*)
              echo "企业微信 WECHAT_AGENT_ID 非数字，跳过"
              exit 0
              ;;
          esac

          if [ -z "$WECHAT_API_URL" ]; then WECHAT_API_URL="https://qyapi.weixin.qq.com"; fi
          WECHAT_API_URL="${WECHAT_API_URL%/}"

          ACCESS_TOKEN="$(
            curl -s "${WECHAT_API_URL}/cgi-bin/gettoken?corpid=${WECHAT_CORP_ID}&corpsecret=${WECHAT_CORP_SECRET}" \
              | python3 -c 'import json,sys; print(json.load(sys.stdin).get("access_token",""))' 2>/dev/null || true
          )"

          if [ -z "$ACCESS_TOKEN" ]; then
            echo "企业微信 access_token 获取失败，跳过"
            exit 0
          fi

          TAGS="${{ steps.meta.outputs.tags }}"
          TAGS_ONE_LINE=$(echo "$TAGS" | tr '\n' ',' | sed 's/,$//')
          COMMIT_MESSAGE="$(git log -1 --pretty=%s 2>/dev/null || true)"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          CONTENT="$(cat <<EOF
          ✅ Docker 镜像构建成功
          项目: ${{ github.event.repository.name }}
          分支: ${{ github.ref_name }}
          提交: ${GITHUB_SHA:0:7}
          提交信息: ${COMMIT_MESSAGE}
          提交者: ${{ github.actor }}
          镜像: ${TAGS_ONE_LINE}
          提交链接: ${COMMIT_URL}
          详情: ${RUN_URL}
          EOF
          )"
          CONTENT="$(printf '%s\n' "${CONTENT}" | sed 's/^[[:space:]]\\+//')"

          PAYLOAD="$(CONTENT="$CONTENT" python3 -c 'import json,os; print(json.dumps({"touser": os.environ["WECHAT_TO_USER"], "msgtype": "text", "agentid": int(os.environ["WECHAT_AGENT_ID"]), "text": {"content": os.environ["CONTENT"]}}, ensure_ascii=False))')"

          curl -s -X POST "${WECHAT_API_URL}/cgi-bin/message/send?access_token=${ACCESS_TOKEN}" \
            -H 'Content-Type: application/json' \
            -d "${PAYLOAD}"

      # 7. 企业微信通知 - 失败
      - name: 企业微信通知 - 构建失败
        if: failure()
        continue-on-error: true
        env:
          WECHAT_CORP_ID: ${{ secrets.WECHAT_CORP_ID }}
          WECHAT_CORP_SECRET: ${{ secrets.WECHAT_CORP_SECRET }}
          WECHAT_AGENT_ID: ${{ secrets.WECHAT_AGENT_ID }}
          WECHAT_TO_USER: ${{ secrets.WECHAT_TO_USER }}
          WECHAT_API_URL: ${{ secrets.WECHAT_API_URL }}
        run: |
          if [ -z "$WECHAT_CORP_ID" ] || [ -z "$WECHAT_CORP_SECRET" ] || [ -z "$WECHAT_AGENT_ID" ] || [ -z "$WECHAT_TO_USER" ]; then
            echo "未配置企业微信通知，跳过"
            exit 0
          fi

          case "$WECHAT_AGENT_ID" in
            (*[!0-9]*)
              echo "企业微信 WECHAT_AGENT_ID 非数字，跳过"
              exit 0
              ;;
          esac

          if [ -z "$WECHAT_API_URL" ]; then WECHAT_API_URL="https://qyapi.weixin.qq.com"; fi
          WECHAT_API_URL="${WECHAT_API_URL%/}"

          ACCESS_TOKEN="$(
            curl -s "${WECHAT_API_URL}/cgi-bin/gettoken?corpid=${WECHAT_CORP_ID}&corpsecret=${WECHAT_CORP_SECRET}" \
              | python3 -c 'import json,sys; print(json.load(sys.stdin).get("access_token",""))' 2>/dev/null || true
          )"

          if [ -z "$ACCESS_TOKEN" ]; then
            echo "企业微信 access_token 获取失败，跳过"
            exit 0
          fi

          COMMIT_MESSAGE="$(git log -1 --pretty=%s 2>/dev/null || true)"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          CONTENT="$(cat <<EOF
          ❌ Docker 镜像构建失败
          项目: ${{ github.event.repository.name }}
          分支: ${{ github.ref_name }}
          提交: ${GITHUB_SHA:0:7}
          提交信息: ${COMMIT_MESSAGE}
          提交者: ${{ github.actor }}
          提交链接: ${COMMIT_URL}
          详情: ${RUN_URL}
          EOF
          )"
          CONTENT="$(printf '%s\n' "${CONTENT}" | sed 's/^[[:space:]]\\+//')"

          PAYLOAD="$(CONTENT="$CONTENT" python3 -c 'import json,os; print(json.dumps({"touser": os.environ["WECHAT_TO_USER"], "msgtype": "text", "agentid": int(os.environ["WECHAT_AGENT_ID"]), "text": {"content": os.environ["CONTENT"]}}, ensure_ascii=False))')"

          curl -s -X POST "${WECHAT_API_URL}/cgi-bin/message/send?access_token=${ACCESS_TOKEN}" \
            -H 'Content-Type: application/json' \
            -d "${PAYLOAD}"
