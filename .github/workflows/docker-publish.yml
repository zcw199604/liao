name: Build and Push Docker Image

on:
  push:
    branches:
      - master
    tags:
      - 'v*'

env:
  REGISTRY: docker.io
  IMAGE_NAME: a7413498/liao

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 1. 检出代码
      - name: 检出代码
        uses: actions/checkout@v4

      # 2. 设置Docker Buildx
      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. 登录Docker Hub
      - name: 登录Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4. 提取Docker元数据
      - name: 提取Docker元数据
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      # 5. 构建并推送Docker镜像
      - name: 构建并推送Docker镜像
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 6. 企业微信通知 - 成功
      - name: 企业微信通知 - 构建成功
        if: success()
        env:
          WECHAT_CORP_ID: ${{ secrets.WECHAT_CORP_ID }}
        run: |
          if [ -z "$WECHAT_CORP_ID" ]; then
            echo "未配置企业微信通知，跳过"
            exit 0
          fi
          WECHAT_API_URL="${{ secrets.WECHAT_API_URL }}"
          if [ -z "$WECHAT_API_URL" ]; then
            WECHAT_API_URL="https://qyapi.weixin.qq.com"
          fi
          ACCESS_TOKEN=$(curl -s "${WECHAT_API_URL}/cgi-bin/gettoken?corpid=${{ secrets.WECHAT_CORP_ID }}&corpsecret=${{ secrets.WECHAT_CORP_SECRET }}" | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)
          curl -X POST "${WECHAT_API_URL}/cgi-bin/message/send?access_token=${ACCESS_TOKEN}" \
            -H 'Content-Type: application/json' \
            -d "{
              \"touser\": \"${{ secrets.WECHAT_TO_USER }}\",
              \"msgtype\": \"markdown\",
              \"agentid\": ${{ secrets.WECHAT_AGENT_ID }},
              \"markdown\": {
                \"content\": \"## ✅ Docker 镜像构建成功\n>项目: **liao**\n>分支: \`${{ github.ref_name }}\`\n>提交: [\`${GITHUB_SHA:0:7}\`](${{ github.event.head_commit.url }})\n>提交者: ${{ github.actor }}\n>镜像: \`${{ env.IMAGE_NAME }}:${{ github.ref_name }}\`\n\n[查看详情](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\"
              }
            }"

      # 7. 企业微信通知 - 失败
      - name: 企业微信通知 - 构建失败
        if: failure()
        env:
          WECHAT_CORP_ID: ${{ secrets.WECHAT_CORP_ID }}
        run: |
          if [ -z "$WECHAT_CORP_ID" ]; then
            echo "未配置企业微信通知，跳过"
            exit 0
          fi
          WECHAT_API_URL="${{ secrets.WECHAT_API_URL }}"
          if [ -z "$WECHAT_API_URL" ]; then
            WECHAT_API_URL="https://qyapi.weixin.qq.com"
          fi
          ACCESS_TOKEN=$(curl -s "${WECHAT_API_URL}/cgi-bin/gettoken?corpid=${{ secrets.WECHAT_CORP_ID }}&corpsecret=${{ secrets.WECHAT_CORP_SECRET }}" | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)
          curl -X POST "${WECHAT_API_URL}/cgi-bin/message/send?access_token=${ACCESS_TOKEN}" \
            -H 'Content-Type: application/json' \
            -d "{
              \"touser\": \"${{ secrets.WECHAT_TO_USER }}\",
              \"msgtype\": \"markdown\",
              \"agentid\": ${{ secrets.WECHAT_AGENT_ID }},
              \"markdown\": {
                \"content\": \"## ❌ Docker 镜像构建失败\n>项目: **liao**\n>分支: \`${{ github.ref_name }}\`\n>提交: [\`${GITHUB_SHA:0:7}\`](${{ github.event.head_commit.url }})\n>提交者: ${{ github.actor }}\n>失败原因: 请查看日志\n\n<font color=\\\"warning\\">[立即查看失败日志](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})</font>\"
              }
            }"
