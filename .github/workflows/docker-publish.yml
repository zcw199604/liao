name: Build and Push Docker Image

on:
  push:
    branches:
      - master
    tags:
      - 'v*'

env:
  REGISTRY: docker.io
  IMAGE_NAME: a7413498/${{ github.event.repository.name }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 1. 检出代码
      - name: 检出代码
        uses: actions/checkout@v4

      # 2. 设置Docker Buildx
      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. 登录Docker Hub
      - name: 登录Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4. 提取Docker元数据
      - name: 提取Docker元数据
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix=sha-,format=long
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      # 5. 构建并推送Docker镜像
      - name: 构建并推送Docker镜像
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 6. 企业微信通知 - 成功
      - name: 企业微信通知 - 构建成功
        if: success()
        env:
          WECHAT_CORP_ID: ${{ secrets.WECHAT_CORP_ID }}
        run: |
          if [ -z "$WECHAT_CORP_ID" ]; then
            echo "未配置企业微信通知，跳过"
            exit 0
          fi
          WECHAT_API_URL="${{ secrets.WECHAT_API_URL }}"
          if [ -z "$WECHAT_API_URL" ]; then
            WECHAT_API_URL="https://qyapi.weixin.qq.com"
          fi
          ACCESS_TOKEN=$(curl -s "${WECHAT_API_URL}/cgi-bin/gettoken?corpid=${{ secrets.WECHAT_CORP_ID }}&corpsecret=${{ secrets.WECHAT_CORP_SECRET }}" | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)

          PROJECT="${{ github.event.repository.name }}"
          BRANCH="${{ github.ref_name }}"
          SHORT_SHA="${GITHUB_SHA:0:7}"
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          if [ -z "${COMMIT_MESSAGE}" ]; then
            COMMIT_MESSAGE="$(git log -1 --pretty=%s 2>/dev/null || true)"
          fi
          COMMIT_MESSAGE="$(printf '%s' "${COMMIT_MESSAGE}" | tr -d '\r\n')"
          IMAGE_TAGS="$(printf '%s' "${{ steps.meta.outputs.tags }}" | tr '\n' ',' | sed 's/,$//')"

          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          CONTENT="✅ Docker 镜像构建成功
          项目: ${PROJECT}
          分支: ${BRANCH}
          提交: ${SHORT_SHA}
          提交信息: ${COMMIT_MESSAGE}
          提交者: ${{ github.actor }}
          镜像: ${IMAGE_TAGS}
          提交链接: ${COMMIT_URL}
          详情: ${RUN_URL}"
          CONTENT="$(printf '%s\n' "${CONTENT}" | sed 's/^[[:space:]]\\+//')"

          TOUSER="${{ secrets.WECHAT_TO_USER }}"
          AGENTID="${{ secrets.WECHAT_AGENT_ID }}"
          export TOUSER AGENTID CONTENT
          PAYLOAD="$(node -e 'const p={touser:process.env.TOUSER,msgtype:\"text\",agentid:Number(process.env.AGENTID),text:{content:process.env.CONTENT}};process.stdout.write(JSON.stringify(p));')"

          curl -s -X POST "${WECHAT_API_URL}/cgi-bin/message/send?access_token=${ACCESS_TOKEN}" \
            -H 'Content-Type: application/json' \
            -d "${PAYLOAD}"

      # 7. 企业微信通知 - 失败
      - name: 企业微信通知 - 构建失败
        if: failure()
        env:
          WECHAT_CORP_ID: ${{ secrets.WECHAT_CORP_ID }}
        run: |
          if [ -z "$WECHAT_CORP_ID" ]; then
            echo "未配置企业微信通知，跳过"
            exit 0
          fi
          WECHAT_API_URL="${{ secrets.WECHAT_API_URL }}"
          if [ -z "$WECHAT_API_URL" ]; then
            WECHAT_API_URL="https://qyapi.weixin.qq.com"
          fi
          ACCESS_TOKEN=$(curl -s "${WECHAT_API_URL}/cgi-bin/gettoken?corpid=${{ secrets.WECHAT_CORP_ID }}&corpsecret=${{ secrets.WECHAT_CORP_SECRET }}" | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)

          PROJECT="${{ github.event.repository.name }}"
          BRANCH="${{ github.ref_name }}"
          SHORT_SHA="${GITHUB_SHA:0:7}"
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          if [ -z "${COMMIT_MESSAGE}" ]; then
            COMMIT_MESSAGE="$(git log -1 --pretty=%s 2>/dev/null || true)"
          fi
          COMMIT_MESSAGE="$(printf '%s' "${COMMIT_MESSAGE}" | tr -d '\r\n')"

          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          CONTENT="❌ Docker 镜像构建失败
          项目: ${PROJECT}
          分支: ${BRANCH}
          提交: ${SHORT_SHA}
          提交信息: ${COMMIT_MESSAGE}
          提交者: ${{ github.actor }}
          详情: ${RUN_URL}"
          CONTENT="$(printf '%s\n' "${CONTENT}" | sed 's/^[[:space:]]\\+//')"

          TOUSER="${{ secrets.WECHAT_TO_USER }}"
          AGENTID="${{ secrets.WECHAT_AGENT_ID }}"
          export TOUSER AGENTID CONTENT
          PAYLOAD="$(node -e 'const p={touser:process.env.TOUSER,msgtype:\"text\",agentid:Number(process.env.AGENTID),text:{content:process.env.CONTENT}};process.stdout.write(JSON.stringify(p));')"

          curl -s -X POST "${WECHAT_API_URL}/cgi-bin/message/send?access_token=${ACCESS_TOKEN}" \
            -H 'Content-Type: application/json' \
            -d "${PAYLOAD}"
