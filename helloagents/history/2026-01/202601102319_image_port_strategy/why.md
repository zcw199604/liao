# 变更提案: 全局图片端口策略配置（DB + Settings 面板）

## 需求背景
当前前端在多处将上游媒体端口写死（图片 `9006`、视频 `8006`）。当上游实际可用端口与固定值不一致时，会出现“消息里收到图片但无法打开/历史记录图片打不开”等问题。

同时，后端已有“可用端口探测”逻辑（请求 `useripaddressv23.js`），但该方式仅能判断端口可达，不保证目标媒体文件真实可访问。

## 产品分析

### 目标用户与场景
- **用户群体:** 使用本项目进行匿名聊天的普通用户；需要在聊天、历史记录中稳定查看图片/视频。
- **使用场景:** 收到 WebSocket 私信里的媒体消息、打开与某用户的历史聊天记录、预览并重新上传历史媒体。
- **核心痛点:** 端口策略不可控且不可配置；固定端口失效时用户体验直接受损。

### 价值主张与成功指标
- **价值主张:** 提供“全局可配置”的图片端口解析策略，兼顾稳定性与兼容性。
- **成功指标:** 在端口变化/不一致场景下，聊天与历史图片的打开成功率显著提升；配置切换无需改代码即可生效。

### 人文关怀
配置对所有用户共用，避免普通用户在未知原因下反复遇到“图片打不开”的挫败感；同时提供清晰的 UI 文案减少误操作。

## 变更内容
1. 新增全局系统配置（存储到数据库），提供图片端口选择策略：`固定` / `可用端口探测` / `真实图片请求`。
2. 前端 Settings 面板新增可视化切换与保存（写入 DB），并在 WebSocket/历史消息/缓存图片等入口接入配置策略。
3. “真实图片请求”模式：对候选端口发起真实媒体请求并做最小大小校验（阈值可配置），避免仅“端口可达”导致误判。

## 影响范围
- **模块:**
  - Go 后端：schema/配置服务/端口解析 API
  - 前端：Settings UI、消息解析与媒体 URL 拼接
- **文件:**
  - 后端：`internal/app/*`、`internal/app/schema.go`
  - 前端：`frontend/src/components/settings/*`、`frontend/src/stores/*`、`frontend/src/composables/*`、`frontend/src/api/*`
  - 知识库：`helloagents/wiki/*`、`helloagents/CHANGELOG.md`
- **API:**
  - 新增系统配置读写 API
  - 新增图片端口解析 API（用于“探测/真实请求”模式）
- **数据:**
  - 新增 `system_config` 表（全局 Key-Value）

## 核心场景

### 需求: 全局配置端口策略
**模块:** 系统设置 / 媒体
用户在 Settings 面板选择图片端口策略并保存到 DB，全站（所有用户）生效。

#### 场景: 切换为固定模式
在固定模式下，图片使用固定端口；视频保持现有固定逻辑不变。
- 预期结果: 聊天与历史记录中的图片 URL 使用固定图片端口；视频仍使用固定视频端口。

#### 场景: 切换为可用端口探测模式
使用上游同类思路（请求 `useripaddressv23.js`）进行“端口可达”探测。
- 预期结果: 图片 URL 使用探测得到的端口（不改变视频端口逻辑）。

#### 场景: 切换为真实图片请求模式
对候选端口使用真实媒体 URL 进行探测，并按最小大小阈值判定。
- 预期结果: 图片 URL 使用能真实返回媒体内容的端口；避免返回 HTML/占位页误判。

### 需求: WS / 历史记录图片可打开
**模块:** WebSocket / 聊天 UI
当收到媒体消息或加载聊天历史时，图片 URL 按全局策略生成并可访问。

#### 场景: 收到 WS 媒体消息
收到 `[path]` 格式媒体消息，前端按策略得到图片端口并拼接 URL。
- 预期结果: 图片可直接预览；视频保持现有端口逻辑。

#### 场景: 打开与某用户的历史聊天记录
加载 `contents_list` 后，将媒体消息解析为可打开的图片/视频链接。
- 预期结果: 历史图片可打开；端口来源受全局配置控制。

## 风险评估
- **风险:** “真实图片请求”会对候选端口发起额外请求，可能带来一定延迟。
  - **缓解:** 使用 Range/最小读取 + 超时控制 + 结果缓存，避免重复扫描。
- **风险:** 端口策略切换后，前端本地缓存的 URL 可能仍使用旧端口。
  - **缓解:** 在前端统一走“按策略生成 URL”路径，并对解析结果进行缓存/刷新。
