# 变更提案: mtPhoto 相册接入与导入上传

## 需求背景
当前系统已具备「所有上传图片（全站图片库）」与「聊天历史图片」能力，但无法直接复用已有的 mtPhoto 相册资产。
本变更希望在现有“上传菜单/系统设置”入口中增加 mtPhoto 相册浏览能力，并支持将相册内图片/视频一键导入，复用现有“上传到上游 + 加入已上传列表”的工作流。

## 产品分析

### 目标用户与场景
- **用户群体:** 需要频繁从存量相册选择素材并发送到聊天的运营/使用者
- **使用场景:** 在聊天中快速从相册挑选图片/视频 → 预览确认 → 一键上传到上游并发送
- **核心痛点:** 需要在外部系统和当前系统之间反复切换、手动下载再上传，效率低且易出错

### 价值主张与成功指标
- **价值主张:** 将 mtPhoto 相册“原地接入”到当前系统，降低素材获取与发送成本
- **成功指标:**
  - 打开相册并展示首屏缩略图的时间可接受（无明显卡顿）
  - 大相册可稳定滚动加载（无限滚动/懒加载）
  - 导入上传成功后，素材可立即出现在「已上传的文件」中并可发送

### 人文关怀
- 账号凭证仅通过环境变量配置，避免在前端/日志中暴露敏感信息
- 访问与展示仅用于素材选择，不增加对用户隐私的额外采集

## 变更内容
1. **后端对接 mtPhoto：** 登录/续期、相册与媒体查询、缩略图代理、按 MD5 获取本地路径、导入上传接口。
2. **前端新增 mtPhoto 相册入口：** 上传菜单新增按钮、系统设置新增按钮；新增相册/媒体展示 Modal。
3. **导入上传链路：** 点击媒体 → 解析本地路径 → 上传到上游 → 加入「已上传的文件」与「全站图片库」可见数据源。

## 影响范围
- **模块:** `internal/app`、`internal/config`、`frontend/src`
- **文件:** 新增/修改后端 mtPhoto 模块与前端相册 Modal/Store/API
- **API:** 新增 mtPhoto 相关接口（相册列表、相册媒体分页、缩略图代理、文件路径解析、导入上传）
- **数据:** 不新增数据表（复用 `media_file`、`media_send_log`、缓存图片机制）

## 核心场景

### 需求: 展示 mtPhoto 相册列表
**模块:** 前端媒体库 / 后端 mtPhoto 代理
用户可在系统内查看 mtPhoto 的相册列表（名称、封面、数量等）。

#### 场景: 从上传菜单进入
在聊天室点击上传菜单中的 mtPhoto 相册入口后打开相册列表。
- 展示相册网格列表（封面缩略图）
- 支持返回关闭

#### 场景: 从系统设置进入
在系统设置中点击 mtPhoto 相册入口后打开相册列表。
- 与上传菜单一致的展示与交互

### 需求: 展示相册内媒体（图片/视频）
**模块:** 前端媒体库 / 后端 mtPhoto 代理
用户进入某相册后可查看相册内图片/视频列表，且在大相册下具备可用的滚动加载体验。

#### 场景: 无限滚动加载更多
滚动到列表底部附近时，按页请求下一批媒体元数据并追加渲染。
- 首屏快速展示
- 继续滚动可持续加载，直到无更多数据

### 需求: 预览媒体
**模块:** 前端媒体预览 / 后端文件路径解析
点击缩略图可打开预览，支持图片与视频。

#### 场景: 点击缩略图打开预览
- 图片可预览放大/拖动（复用现有预览组件能力）
- 视频可播放预览

### 需求: 导入并上传到上游
**模块:** 后端导入上传 / 前端上传工作流
在预览中点击“上传”后，系统从 mtPhoto 解析本地文件路径并将文件上传到上游，成功后加入「已上传的文件」。

#### 场景: 在预览中点击“上传”
- 通过 mtPhoto 的 `filesInMD5` 获取本地路径
- 后端读取本地文件并上传到上游
- 成功后前端提示并将该媒体加入「已上传的文件」

## 风险评估
- **风险:** mtPhoto refresh 接口未在现有文档中体现
  - **缓解:** 采用“过期/401 自动重新登录 + 单次重试”策略，保证稳定性
- **风险:** 本地路径安全（路径遍历/越权读取）
  - **缓解:** 严格限制仅允许 `/lsp/` 前缀；对路径做 clean 并拒绝包含 `..` 的路径；必要时加固现有 `/lsp/*` 静态服务的路径校验
- **风险:** 大相册性能与网络压力
  - **缓解:** 后端对相册媒体做分页切片与短 TTL 缓存；前端无限滚动 + 图片 `loading="lazy"`
- **风险:** 凭证泄露与日志污染
  - **缓解:** 仅通过环境变量注入；严禁在日志中输出 token/auth_code/密码等敏感字段

