# 变更提案: Go 文件功能测试补齐

## 需求背景

当前 Go 服务已实现媒体上传/查重/缓存/删除/重传等“文件功能”，但仓库中尚无对应的 Go 测试用例（`*_test.go`）。缺少测试会导致：
- 文件落盘、路径归一化、去重逻辑（MD5/pHash）等边界行为难以回归验证；
- 上游上传代理、端口探测等逻辑在本地/CI 环境中容易出现隐性失败或慢测试；
- 后续迭代难以定位“文件功能”回归来源。

本变更目标是在不依赖外部 MySQL/上游服务的前提下，为 Go 服务的文件相关能力补齐可重复执行的单元/接口层测试，作为稳定性与兼容性的质量护栏。

## 变更内容

1. 为文件存储（落盘/读取/删除/MD5）增加单元测试。
2. 为媒体上传相关的关键纯函数与服务方法增加单元测试（路径归一化、本地 URL 转换等）。
3. 为媒体查重（`/api/checkDuplicateMedia`）增加 handler 测试，覆盖 MD5 命中、pHash 不支持、pHash 相似命中等路径。
4. 为媒体上传（`/api/uploadMedia`）增加 handler 测试，使用本地 `httptest` 上游模拟与可控端口探测，覆盖成功落盘与返回增强逻辑。

## 影响范围

- **模块:** Media（文件存储/上传/查重/缓存/删除）
- **文件:** `internal/app/*`（新增 `*_test.go`，以及少量为可测试性做的最小改动）
- **API:** 无变更（仅新增测试验证现有行为）
- **数据:** 无变更（测试使用 mock DB，不依赖真实 MySQL）

## 核心场景

### 需求: 文件落盘与读取删除
**模块:** Media
对上传文件进行本地保存、读取、删除，并确保路径格式与 `GET /upload/**` 的访问规则一致。

#### 场景: 保存并读取校验
- 保存返回的 `localPath` 可被读取到原始字节
- 删除后再次读取返回“文件不存在”

### 需求: 媒体查重（MD5 + pHash）
**模块:** Media
上传文件后执行查重逻辑：MD5 精确匹配优先；无命中且可计算 pHash 时按阈值查询相似项；不可计算 pHash 时返回“无命中”。

#### 场景: MD5 命中直接返回
- 返回 `matchType=md5` 且 items 非空

#### 场景: pHash 不支持时返回 none
- 返回 `matchType=none` 且包含 reason

#### 场景: pHash 相似命中
- 返回 `matchType=phash` 且 items 包含 similarity/distance

### 需求: 上传媒体成功路径（含返回增强）
**模块:** Media
上传媒体时：本地落盘 → 代理上游上传 → state=OK 时增强返回（port/localFilename）并写入缓存。

#### 场景: 成功上传并增强返回
- HTTP 200，响应包含 `state=OK`、`msg`、`port`、`localFilename`
- 缓存中包含对应 `localPath`

## 风险评估

- **风险:** 引入测试依赖（如 sqlmock）与少量可测试性改动可能影响编译/行为。
- **缓解:** 仅新增测试依赖（test-only）与默认行为不变的注入点；以 `go test ./...` 作为验收。

