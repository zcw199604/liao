# 变更提案: 视频抽帧（关键帧/固定FPS/逐帧）与任务管理

## 需求背景
当前项目已具备媒体上传（本地落盘到 `./upload`）与 mtPhoto 相册接入能力，但缺少“从视频中提取图片”的生产力工具。实际使用中常见需求包括：
- 从视频中快速挑选代表性画面用于聊天发送/留存
- 对视频按固定间隔抽帧用于内容回顾与筛选
- 对短视频进行逐帧导出（调试、素材筛选等）

本需求希望在现有媒体体系内新增“视频抽帧任务”，并提供可视化任务管理与帧图预览能力。

## 产品分析

### 目标用户与场景
- **用户群体:** 需要在聊天/媒体库中高频处理图片与视频的用户；使用 mtPhoto 相册作为素材库的用户
- **使用场景:**
  - 在“全站上传库”中选中一段视频，抽取关键帧用于快速浏览与挑选
  - 在 mtPhoto 相册中找到视频素材，抽帧后挑图/下载/复用
  - 对短视频逐帧导出以获取精确帧图
- **核心痛点:** 目前只能播放视频，无法快速产出可预览/可复用的图片集合；缺少任务化、可中止、可续跑的处理链路

### 价值主张与成功指标
- **价值主张:** 将“视频→图片”转化为可管理的异步任务，生成可直接预览的帧图目录，降低挑图成本
- **成功指标:**
  - 创建任务到开始处理的时间可接受（本地视频秒级启动；mtPhoto 允许启动前缓存下载）
  - 任务进度可见、可终止、可继续
  - 帧图预览体验流畅（分页/增量加载；必要时引入缩略图与虚拟滚动）

### 人文关怀
- 任务生成帧图可能占用较大磁盘空间，应提供明显的风险提示与上限约束（以 `maxFrames` 为核心硬约束）
- 对移动端与弱网环境，尽量避免多层弹窗堆叠与一次性加载大量图片

## 变更内容
1. 新增“视频抽帧任务”后端能力：创建/查询/预览/继续/终止/删除
2. 支持输入源：
   - 新上传/本地上传库（`/upload/videos/**`）
   - mtPhoto 相册视频（通过 md5 → 解析本地路径，必要时先缓存到本地）
3. 抽帧模式支持：
   - 关键帧（I 帧 / 场景变化阈值）
   - 固定 FPS
   - 每一帧（逐帧）
   - 通用约束：时间区间（start/end）与最大帧数上限（maxFrames）
4. 前端新增抽帧入口与任务中心：
   - 在视频预览处提供“抽帧”入口
   - 任务列表/详情与帧图预览（返回宽高，默认与视频一致）
5. 部署：运行时镜像新增 `ffmpeg/ffprobe`

## 影响范围
- **模块:**
  - Go 后端：`internal/app`（新增 handlers/service；路由新增；schema 变更）
  - Docker 镜像：安装 ffmpeg
  - Vue 前端：新增抽帧 UI（入口、创建表单、任务中心、预览）
- **API:** 新增 `/api/*VideoExtract*` 与 `/api/probeVideo` 等接口
- **数据:** 新增抽帧任务/帧索引相关表

## 核心场景

### 需求: 创建抽帧任务
**模块:** 前端（MediaPreview/任务创建）+ 后端（任务创建/执行）

#### 场景: 从上传库视频创建任务
用户在“全站上传库”预览一个视频，点击“抽帧”，选择模式与参数后提交：
- 创建异步任务并开始处理
- 任务关联本地输出目录（可预览）
- 返回视频宽高与时长等 probe 信息用于渲染

#### 场景: 从 mtPhoto 相册视频创建任务
用户在 mtPhoto 相册预览视频，点击“抽帧”，提交后：
- 若视频不在本地可直接访问，则先缓存到本地（任务状态可体现“准备中/下载中”）
- 开始抽帧，产物落地并可预览

### 需求: 任务进度与实时信息
**模块:** 前端（任务详情）+ 后端（进度采集/状态查询）

#### 场景: 运行中查看进度并随时终止
- 前端显示进度条、已输出帧数、当前 out_time/frame/speed 等信息（轮询或 SSE）
- 用户可点击“终止”，任务停止并保留已生成产物

### 需求: 任务预览与分页加载
**模块:** 前端（预览网格）+ 后端（帧列表分页）

#### 场景: 点击任务查看目录下帧图
- 以网格/瀑布流展示帧图（增量分页加载）
- 点击帧图可用通用预览组件查看大图

### 需求: 限制体现与继续抽帧
**模块:** 前端（Continue 表单）+ 后端（续跑游标/追加写入）

#### 场景: 达到 maxFrames 或 endSec 后暂停并继续
- 任务因 `maxFrames` 或 `endSec` 停止时，状态体现“因限制暂停”
- 用户可对同一任务执行“继续”：扩展 endSec 或增加 maxFrames，继续追加写入同一目录，且避免重复帧

## 风险评估
- **风险:** 大量帧图导致前端渲染卡顿、后端磁盘占用激增
  - **缓解:** 强制 `maxFrames`；前端分页/必要时虚拟滚动；可选缩略图策略；提供明显风险提示
- **风险:** mtPhoto 视频可能需要先缓存下载导致启动慢
  - **缓解:** 任务状态拆分“准备中/运行中”；UI 提示“远程视频需缓存”
- **风险:** 外部进程调用的安全风险（命令注入/路径遍历）
  - **缓解:** 严禁 `sh -c` 拼接；参数列表化；输出目录受控；严格校验 localPath/md5
