# 变更提案: 聊天体验优化（乐观发送 / 骨架屏 / 虚拟滚动 / 媒体组件化）

## 需求背景

当前聊天体验在以下场景存在明显“延迟感”和“视觉跳动”：

1. **发送延迟感**：`useMessage.ts` 的 `sendText` 仅通过 WebSocket 发送，界面需等待服务端回显后才渲染消息；网络抖动时点击发送会明显卡顿。
2. **加载跳动**：历史记录/列表加载阶段使用 Spinner，加载完成后内容突然出现，造成布局抖动。
3. **长对话卡顿**：`MessageList.vue` 通过 `v-for` 渲染全部消息，几千条记录时 DOM 过多导致滚动不流畅、内存升高。
4. **媒体体验不一致**：图片/视频在加载过程中缺少占位与兜底策略，容易出现布局突然撑开、加载失败时显示默认丑图标等问题。

<!-- ⚠️ 触发 G8：产品设计原则 -->
## 产品分析

### 目标用户与场景
- **用户群体:** 高频私聊用户、弱网/移动网络用户、历史记录较长的重度用户
- **使用场景:** 发送文本/图片/视频、快速连续对话、进入聊天页面查看历史、侧边栏切换会话
- **核心痛点:** 点击发送后“没反应”、加载时“闪一下”、长列表“越用越卡”、媒体加载“抖动/失败体验差”

### 价值主张与成功指标
- **价值主张:** 让“发送像已完成一样快”，让“加载像已准备好一样稳”，让“再长的聊天也能丝滑滚动”
- **成功指标:**
  - 发送点击后 **≤100ms** 显示本地气泡（乐观 UI）
  - 回显到达后 **自动从 sending → sent**；超时/失败可重试
  - 首次加载与切换列表的 **布局跳动（CLS 体感）显著下降**
  - 超长对话（数千条）滚动保持稳定帧率，内存占用可控

### 人文关怀
- 视觉反馈清晰：发送/失败状态明确可见，避免用户反复点击导致重复发送
- 动效克制：骨架屏使用低强度脉冲，不影响阅读与注意力（可结合系统“减少动态效果”偏好做降级）
- 错误可恢复：媒体 404/加载失败给出可理解的兜底提示与可操作入口

## 变更内容
1. **乐观发送（Optimistic UI）**：发送时立即插入本地消息（`sending`），回显到达后标记 `sent`，超时/失败标记 `failed` 并提供重试。
2. **骨架屏加载（Skeleton Loading）**：在加载历史记录与侧边栏/收藏列表时使用骨架屏替代 Spinner，降低视觉跳动。
3. **消息列表虚拟滚动（Virtual Scrolling）**：仅渲染视口内消息，避免超长 DOM 导致卡顿。
4. **媒体组件化（ChatMedia）**：为图片/视频提供加载占位、懒加载、自适应宽高比与错误兜底，统一渲染体验。

## 影响范围
- **模块:**
  - `frontend`：`chat-ui`、`message-store`、`websocket`、`media`
- **文件（预估）:**
  - `frontend/src/composables/useMessage.ts`
  - `frontend/src/composables/useWebSocket.ts`
  - `frontend/src/stores/message.ts`
  - `frontend/src/types/message.ts`
  - `frontend/src/components/chat/MessageList.vue`
  - `frontend/src/components/chat/ChatSidebar.vue`
  - `frontend/src/components/settings/GlobalFavorites.vue`
  - `frontend/src/components/chat/MessageBubble.vue`（如需保持一致）
  - `frontend/src/components/chat/ChatMedia.vue`（新增）
  - `frontend/src/components/common/Skeleton.vue`（新增）
  - `frontend/package.json`（新增依赖）
- **API:**
  - WebSocket 协议保持不变（不改后端），前端通过“内容+时间窗口+队列顺序”做回显合并（可预留后续 `clientMsgId` 升级路径）
- **数据:** 无持久化数据结构变更

## 核心场景

### 需求: 乐观发送 Optimistic Send
**模块:** `chat-ui` / `message-store` / `websocket`

在发送调用发生时立即插入本地消息并反馈状态，避免等待服务端回显导致的“延迟感”。

#### 场景: 文本发送即时渲染 + 回显确认
条件：WebSocket 已连接；用户在聊天页发送文本。
- 预期结果：点击发送后立刻出现本地气泡（`sending`）。
- 预期结果：收到服务端回显后，气泡状态更新为 `sent`，并补全 `tid/time` 等字段。

#### 场景: 发送失败/超时后重试
条件：弱网/断网/服务端未回显导致超时。
- 预期结果：超时后状态变为 `failed`，展示“重试”入口。
- 预期结果：点击重试会重新发送，并将状态回到 `sending`；成功后变为 `sent`。

#### 场景: 媒体消息（图片/视频）即时渲染 + 回显确认
条件：用户发送已上传的图片/视频。
- 预期结果：立即渲染媒体气泡（带加载占位/懒加载），状态 `sending`。
- 预期结果：回显到达后状态 `sent`；若失败显示兜底与重试。

### 需求: 骨架屏加载 Skeleton Loading
**模块:** `chat-ui` / `user-history`

用骨架屏替代 Spinner，减少“加载完成突然弹出”的抖动。

#### 场景: 首次加载聊天历史
条件：进入聊天页且本地无缓存消息，需要拉取历史。
- 预期结果：消息区域显示若干“消息气泡骨架”占位，布局稳定。
- 预期结果：数据到达后平滑替换为真实消息，不出现明显跳动。

#### 场景: 加载侧边栏/收藏列表
条件：侧边栏首次打开或列表首次加载。
- 预期结果：列表显示若干“头像 + 昵称 + 摘要”的骨架条目，占位高度稳定。

### 需求: 消息列表虚拟滚动 Virtual Scrolling
**模块:** `chat-ui`

长对话仅渲染可视区域，避免 DOM 膨胀。

#### 场景: 超长对话滚动保持流畅
条件：历史消息达到几千条。
- 预期结果：滚动不卡顿，内存占用稳定；新消息到达时仍保持现有“新消息/回到底部”交互。

### 需求: 媒体组件化 ChatMedia
**模块:** `chat-ui` / `media`

统一图片/视频渲染体验，降低抖动并增强失败兜底。

#### 场景: 图片加载占位 + 懒加载 + 错误兜底
条件：消息中包含图片，且图片加载较慢/失败。
- 预期结果：未加载完成前显示灰色脉冲占位，避免布局突然撑开。
- 预期结果：滚动到可视区域后才发起网络请求（懒加载）。
- 预期结果：404/失败时显示自定义占位与文案（非浏览器默认破图标）。

## 风险评估
- **风险:** 回显合并错配（短时间重复发送相同内容）  
  **缓解:** 使用“同会话 + 同类型 + 归一化内容/媒体路径 + 时间窗口 + 队列顺序（取最早 pending）”匹配；保留未匹配回显为新消息；后续可升级后端支持 `clientMsgId`。
- **风险:** 引入 `vue-virtual-scroller` 增加依赖与样式  
  **缓解:** 锁定版本、在 `npm run build` 与 `vitest` 验证；若出现兼容问题可回退到非虚拟模式（可选 Feature Flag）。
- **风险:** 虚拟滚动与“自动滚动/新消息提示”耦合导致交互回归  
  **缓解:** 抽象滚动控制接口（scrollToBottom/scrollToTop/isAtBottom），为虚拟列表单测关键交互。
