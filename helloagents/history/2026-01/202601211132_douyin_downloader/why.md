# 变更提案: 抖音作品抓取与下载对接（TikTokDownloader Web API）

## 需求背景
当前项目已沉淀 TikTokDownloader Web API（FastAPI）相关知识库，但应用侧尚未对接该服务，无法在系统内完成“抖音分享链接解析 → 作品详情抓取 → 下载/导入上传”的闭环。

本次需要在现有 Go 后端 + Vue 前端基础上接入该服务，面向用户提供抖音作品下载能力，并与现有“媒体预览/上传/媒体库”工作流协同。

## 产品分析

### 目标用户与场景
- **用户群体:** 需要在聊天/素材场景中快速获取抖音作品素材的使用者
- **使用场景:** 复制抖音分享文本/短链/URL/作品ID → 在系统内解析并预览 → 下载到本地 →（可选）导入上传到系统媒体库并用于发送
- **核心痛点:** 解析与下载分散在外部工具；文件命名不一致；重复素材管理困难；导入上传流程割裂

### 价值主张与成功指标
- **价值主张:** 在系统内一站式完成抖音作品的抓取、预览、下载与可选导入上传
- **成功指标:**
  - 支持多种输入形态（分享文本/短链/完整URL/作品ID）解析成功
  - 视频/图集均可预览与下载（优先无水印/最高画质）
  - 下载文件名与作品标题一致（图集按序号追加）
  - 导入上传具备 MD5 去重，避免重复写入与重复上传

### 人文关怀
不在服务端持久化用户 Cookie/代理等敏感配置，默认仅在客户端本地保存；对外部服务异常提供清晰提示，避免用户误以为数据丢失。

## 变更内容
1. 新增抖音解析与详情抓取 API：统一接收输入并调用 TikTokDownloader Web API（/douyin/share + /douyin/detail）。
2. 新增抖音媒体下载 API：根据解析结果为前端提供带文件名的下载流（用于本地下载）。
3. 新增抖音媒体导入上传 API：由后端拉取媒体并复用现有上传到上游与媒体库记录流程，按 MD5 去重。
4. 前端新增“抖音下载”入口与弹窗：支持配置 proxy/cookie、解析预览、下载与一键导入上传。

## 影响范围
- **模块:**
  - 后端：新增外部服务对接（TikTokDownloader）、新增 douyin 相关 handler
  - 前端：新增媒体下载入口与弹窗、API 调用
  - 知识库：新增抖音下载模块文档并更新 API 手册/变更记录
- **文件:** 预计涉及 `internal/app/*`、`internal/config/*`、`frontend/src/*`、`helloagents/wiki/*`、`README.md`
- **API:**
  - `POST /api/douyin/detail`
  - `GET /api/douyin/download`
  - `POST /api/douyin/import`
- **数据:** 复用现有 `media_file` 记录（按 MD5 去重逻辑复用 `MediaUploadService`）

## 核心场景

### 需求: 解析与详情抓取
**模块:** douyin-downloader
输入分享文本/短链/URL/作品ID，解析出 `detail_id` 并抓取作品详情（视频/图集），返回可预览与下载的信息。

#### 场景: 解析短链/分享文本
用户粘贴 `https://v.douyin.com/.../` 或包含该链接的分享文本。
- 预期结果：后端通过 `/douyin/share` 获取重定向 URL，并提取 `detail_id` 后拉取详情。

#### 场景: 解析完整 URL/作品ID
用户输入 `https://www.douyin.com/video/<id>` / `.../note/<id>` / `modal_id=<id>` 或直接输入数字 ID。
- 预期结果：直接提取 `detail_id` 并拉取详情。

### 需求: 下载到本地（流式）
**模块:** douyin-downloader + MediaPreview
用户在预览中点击“下载”，应从本服务获取下载流并使用作品标题作为文件名。

#### 场景: 视频下载
- 预期结果：返回 `Content-Disposition` 文件名为作品标题（`.mp4`），优先最高画质/无水印。

#### 场景: 图集下载
- 预期结果：单张按 `标题_01.jpg` 规则命名；预览支持左右切换与逐张下载。

### 需求: 可选导入上传到系统媒体库
**模块:** douyin-downloader + media
用户确认后将媒体导入上传到上游并加入“已上传的文件”，用于发送。

#### 场景: 导入上传并去重
- 预期结果：后端下载媒体并计算 MD5；若当前用户已有相同 MD5 的媒体记录则直接复用（不重复写文件/不重复上传）。

### 需求: proxy/cookie 配置
**模块:** 前端配置 + 后端透传
proxy/cookie 可由页面填写（本地保存）或服务端通过环境变量提供默认值。

#### 场景: 页面配置优先
- 预期结果：请求时优先使用页面填写值；未填写时使用服务端默认值（如有）。

## 风险评估
- **风险:** 外部下载链接可被滥用造成 SSRF/内网探测
  - **缓解:** 下载/导入仅允许使用服务端缓存的解析结果（key+index），不接受任意 URL 直传
- **风险:** 抖音 Cookie 属于敏感信息
  - **缓解:** 服务端不落库；前端仅本地存储（localStorage），并提供清除入口（关闭弹窗时不强制清除，用户可自行管理）
- **风险:** 大文件下载导致超时/资源占用
  - **缓解:** 设置合理超时与流式转发；导入上传走服务端下载并复用现有上传链路
