# 变更提案: 修复切换身份后 WS 仍绑定旧用户

## 需求背景
当前前端 WebSocket 采用全局单例连接。用户从身份 A 切换到身份 B 时，如果旧 WS 未正确断开，`connect()` 会因为“已连接/正在连接”而直接返回，导致浏览器仍使用身份 A 的下游会话。

Go 后端的下游会话绑定逻辑按首次 `act=sign` 绑定到某个 `userId`，后续消息按 payload 内的 `id` 转发到上游。这会产生典型异常：
- 身份 B 发起“开始匹配”等请求会被转发到上游，但 B 没有下游订阅 → 页面看起来“无响应”
- 页面仍持续收到发给身份 A 的消息（因为 WS 会话仍注册在 A 下）

## 变更内容
1. 前端在 `connect()` 时检测身份是否变化：若当前 WS 绑定用户与 `userStore.currentUser.id` 不一致，则视为切换身份，先断开旧连接再建立新连接并重新发送 `sign`。
2. 修复 `disconnect(true)` 在无 WS 实例时遗留“手动关闭标记”的问题，避免后续连接异常不重连。
3. 补充单元测试覆盖“身份切换触发下游 WS 重建并重新 sign”的场景。

## 影响范围
- **模块:** chat-ui（WebSocket 连接管理）
- **文件:**
  - `frontend/src/composables/useWebSocket.ts`
  - `frontend/src/__tests__/useWebSocket.test.ts`
  - `helloagents/wiki/modules/chat-ui.md`
  - `helloagents/CHANGELOG.md`
- **API:** 无变更
- **数据:** 无变更

## 核心场景

### 需求: 切换身份后正确绑定下游 WS
**模块:** chat-ui
切换身份时，下游 WS 必须与当前身份一致，确保匹配与消息路由正确。

#### 场景: A → B 后开始匹配
- **前置:** 已以身份 A 建立 WS 并完成 `sign`
- **操作:** 切换到身份 B 后进入列表/聊天页并点击开始匹配
- **预期结果:**
  - 前端重建浏览器 → Go 的 WS，并发送身份 B 的 `sign`
  - 身份 B 能收到匹配成功/系统消息等响应
  - 不再收到发给身份 A 的消息

#### 场景: A → B → A（上游复用）
- **前置:** 身份 A 的上游连接仍在 Go 侧延迟关闭窗口内（默认 80s）
- **操作:** 切换到身份 B 后很快切回身份 A
- **预期结果:**
  - 仅重建浏览器 → Go 的 WS
  - Go 侧复用既有身份 A 的上游连接（不强制重连上游）

## 风险评估
- **风险:** 切换身份时短暂断开 WS，连续匹配/输入状态会被中断
- **缓解:** 前端仅在检测到身份不一致时重建连接；其他情况仍复用现有连接

