# 技术设计: 修复切换身份后 WS 仍绑定旧用户

## 技术方案

### 核心技术
- Vue 3 + Pinia
- 浏览器 WebSocket

### 实现要点
- 在 `frontend/src/composables/useWebSocket.ts` 增加“当前 WS 绑定身份”的状态记录。
- `connect()` 在发现“WS 已连接/正在连接，但绑定身份 != 当前身份”时：
  - 先手动断开旧连接（仅浏览器 → Go）
  - 再建立新连接并发送新身份的 `sign`
- 修复 `disconnect(true)` 在 `ws == null` 时不应遗留“手动关闭标记”，避免影响后续自动重连逻辑。
- 为避免快速切换导致旧连接事件覆盖新连接状态，引入轻量的连接代际标识（generation），在事件回调中忽略过期连接的副作用更新。

## API 设计
无变更。

## 数据模型
无变更。

## 安全与性能
- **安全:** 不引入新的鉴权方式；WS token 仍通过 query 参数校验；仅前端连接生命周期调整
- **性能:** 仅在身份不一致时才重建 WS；Go 侧上游连接仍按既有延迟关闭策略复用

## 测试与部署
- **测试:** 运行 `cd frontend && npm test`，新增用例覆盖身份切换重连与重新 sign
- **部署:** 前端构建产物不变；无需新增配置项

