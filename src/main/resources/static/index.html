<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>匿名匹配</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #0f0f13; color: #e0e0e0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow: hidden; }
        .page-container { height: 100vh; display: flex; flex-direction: column; position: relative;}
        
        /* 隐藏滚动条 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 列表区域 */
        .list-area { flex: 1; overflow-y: auto; padding-bottom: 90px; } /* 底部留白给按钮 */
        
        /* 聊天区域 */
        .chat-area { flex: 1; overflow-y: auto; padding: 15px; background-color: #0f0f13; }
        
        /* 匹配按钮特效 */
        .match-btn-container {
            position: absolute; bottom: 80px; left: 0; right: 0; 
            display: flex; justify-content: center; z-index: 10;
            pointer-events: none; /* 让容器不挡点击，只让按钮挡 */
        }
        .match-btn {
            pointer-events: auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
            transition: transform 0.2s;
        }
        .match-btn:active { transform: scale(0.95); }

        /* 气泡样式 (无头像) */
        .msg-bubble {
            padding: 12px 16px;
            border-radius: 16px;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 15px;
            line-height: 1.5;
        }
        .msg-left { 
            background-color: #27272a; 
            color: #eee; 
            border-bottom-left-radius: 2px; 
            align-self: flex-start; /* 左对齐 */
        }
        .msg-right { 
            background-color: #4f46e5; /* Indigo-600 */
            color: white; 
            border-bottom-right-radius: 2px; 
            align-self: flex-end; /* 右对齐 */
            margin-left: auto; /* 强制靠右 */
        }
        
        /* 加载动画 */
        .radar-spinner {
            width: 20px; height: 20px; border: 2px solid #fff; 
            border-top-color: transparent; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* 占位图标颜色类 */
        .bg-color-1 { background-color: #3b82f6; }
        .bg-color-2 { background-color: #10b981; }
        .bg-color-3 { background-color: #f59e0b; }
        .bg-color-4 { background-color: #ec4899; }
        .bg-color-5 { background-color: #8b5cf6; }

        /* 身份选择页样式 */
        .identity-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .identity-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .identity-card:active {
            transform: scale(0.98);
        }
        .identity-card.selected {
            border-color: #6366f1;
            background-color: rgba(99, 102, 241, 0.1);
        }
    </style>
</head>
<body>

<div id="app" class="h-full">

    <!-- === Toast 弹窗 === -->
    <div v-if="toastMessage" class="fixed top-16 left-1/2 -translate-x-1/2 z-[100] px-4 py-2 bg-[#27272a] text-white text-sm rounded-full shadow-lg animate-pulse">
        {{ toastMessage }}
    </div>

    <!-- === 媒体预览弹窗 === -->
    <div v-if="showMediaPreview" class="fixed inset-0 z-[85] bg-black/80 flex items-center justify-center" @click="closeMediaPreview">
        <div class="relative flex flex-col items-center gap-4 max-w-[92vw]" @click.stop>
            <img v-if="previewMediaType === 'image'" :src="previewMediaUrl"
                class="max-w-[92vw] rounded-lg shadow-2xl object-contain"
                :class="previewMediaCanUpload ? 'max-h-[80vh]' : 'max-h-[92vh]'" alt="预览图片">
            <video v-if="previewMediaType === 'video'" :src="previewMediaUrl" controls
                class="max-w-[92vw] rounded-lg shadow-2xl bg-black"
                :class="previewMediaCanUpload ? 'max-h-[80vh]' : 'max-h-[92vh]'"></video>
            <button v-if="previewMediaCanUpload" @click="confirmPreviewUpload"
                class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:opacity-90 transition">
                上传/重新上传
            </button>
            <button @click="closeMediaPreview" class="absolute -top-3 -right-3 w-8 h-8 flex items-center justify-center bg-black/70 text-white rounded-full">
                <i class="fas fa-times text-sm"></i>
            </button>
        </div>
    </div>

    <!-- === 登录页面 === -->
    <div v-if="showLoginPage" class="fixed inset-0 z-[200] bg-[#0f0f13] flex items-center justify-center">
        <div class="w-full max-w-md px-6">
            <!-- Logo/标题 -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-white mb-2">匿名匹配</h1>
                <p class="text-gray-400 text-sm">请输入访问码以继续</p>
            </div>

            <!-- 登录表单 -->
            <div class="bg-[#1a1a1f] rounded-2xl p-8 shadow-xl">
                <div class="mb-6">
                    <label class="block text-gray-300 text-sm font-medium mb-2">访问码</label>
                    <input
                        v-model="loginAccessCode"
                        type="password"
                        placeholder="请输入访问码"
                        @keyup.enter="handleLogin"
                        class="w-full px-4 py-3 bg-[#27272a] text-white rounded-lg border border-gray-700 focus:border-indigo-500 focus:outline-none transition"
                        :disabled="loginLoading"
                    />
                </div>

                <button
                    @click="handleLogin"
                    :disabled="loginLoading || !loginAccessCode"
                    class="w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg font-medium hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed transition"
                >
                    <span v-if="!loginLoading">登录</span>
                    <span v-else class="flex items-center justify-center">
                        <span class="radar-spinner mr-2"></span>
                        登录中...
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- === 身份选择页面 === -->
    <div v-if="showIdentityPicker" class="page-container">
        <!-- 顶部标题 -->
        <div class="pt-8 pb-4 px-4 text-center">
            <h1 class="text-2xl font-bold text-white mb-2">选择身份</h1>
            <p class="text-sm text-gray-400">选择一个身份开始聊天，或创建新身份</p>
        </div>

        <!-- 操作按钮区 -->
        <div class="flex gap-3 px-4 mb-4">
            <button @click="quickCreateIdentity" :disabled="identityLoading"
                class="flex-1 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-medium shadow-lg disabled:opacity-50">
                <i class="fas fa-bolt mr-2"></i>快速进入
            </button>
            <button @click="showCreateForm = true"
                class="flex-1 py-3 bg-[#27272a] text-white rounded-xl font-medium border border-gray-700">
                <i class="fas fa-plus mr-2"></i>创建身份
            </button>
        </div>

        <!-- 身份列表 -->
        <div class="list-area no-scrollbar px-4">
            <!-- 加载中 -->
            <div v-if="identityLoading" class="flex flex-col items-center justify-center mt-20">
                <div class="radar-spinner"></div>
                <p class="text-gray-500 text-sm mt-4">加载中...</p>
            </div>

            <!-- 身份卡片列表 -->
            <div v-else-if="identityList && identityList.length > 0">
                <div v-for="identity in identityList" :key="identity.id"
                    @click="selectIdentity(identity)"
                    class="identity-card flex items-center p-4 mb-3 bg-[#18181b] rounded-2xl border border-transparent">

                    <!-- 头像 -->
                    <div :class="getColorClass(identity.id)"
                        class="w-14 h-14 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg shrink-0">
                        {{ identity.name.charAt(0) }}
                    </div>

                    <!-- 信息 -->
                    <div class="ml-4 flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-bold text-lg text-white">{{ identity.name }}</span>
                            <span class="px-2 py-0.5 text-xs rounded-full"
                                :class="identity.sex === '男' ? 'bg-blue-500/20 text-blue-400' : 'bg-pink-500/20 text-pink-400'">
                                {{ identity.sex }}
                            </span>
                        </div>
                        <p class="text-xs text-gray-500">ID: {{ identity.id.substring(0, 8) }}...</p>
                        <p v-if="identity.lastUsedAt" class="text-xs text-gray-600 mt-1">
                            最后使用: {{ identity.lastUsedAt }}
                        </p>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="flex items-center gap-2">
                        <button @click.stop="showDeleteConfirm(identity)"
                            class="w-8 h-8 flex items-center justify-center text-red-500 hover:bg-red-500/10 rounded-lg transition">
                            <i class="fas fa-trash-alt text-sm"></i>
                        </button>
                        <i class="fas fa-chevron-right text-gray-600"></i>
                    </div>
                </div>
            </div>

            <!-- 空状态 -->
            <div v-else class="flex flex-col items-center justify-center mt-20 text-gray-600">
                <i class="fas fa-user-plus text-5xl mb-4 opacity-50"></i>
                <p class="text-sm">还没有身份，点击上方按钮创建</p>
            </div>
        </div>

        <!-- 创建身份弹窗 -->
        <div v-if="showCreateForm" class="fixed inset-0 z-[80] bg-black/60 flex items-center justify-center" @click="showCreateForm = false">
            <div class="w-80 bg-[#18181b] rounded-2xl p-6 shadow-2xl" @click.stop>
                <h3 class="text-lg font-bold text-white mb-4 text-center">创建新身份</h3>

                <div class="space-y-4">
                    <!-- 名字输入 -->
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">名字</label>
                        <input v-model="newIdentity.name" type="text" placeholder="输入名字"
                            class="w-full bg-[#27272a] text-white px-4 py-3 rounded-xl border border-gray-700 focus:border-indigo-500 focus:outline-none">
                    </div>

                    <!-- 性别选择 -->
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">性别</label>
                        <div class="flex gap-3">
                            <button @click="newIdentity.sex = '男'"
                                :class="newIdentity.sex === '男' ? 'bg-blue-600 border-blue-600' : 'bg-[#27272a] border-gray-700'"
                                class="flex-1 py-3 rounded-xl border text-white font-medium">
                                <i class="fas fa-mars mr-2"></i>男
                            </button>
                            <button @click="newIdentity.sex = '女'"
                                :class="newIdentity.sex === '女' ? 'bg-pink-600 border-pink-600' : 'bg-[#27272a] border-gray-700'"
                                class="flex-1 py-3 rounded-xl border text-white font-medium">
                                <i class="fas fa-venus mr-2"></i>女
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 按钮 -->
                <div class="flex gap-3 mt-6">
                    <button @click="showCreateForm = false"
                        class="flex-1 py-3 bg-[#27272a] text-gray-400 rounded-xl border border-gray-700">
                        取消
                    </button>
                    <button @click="createIdentity" :disabled="!newIdentity.name || !newIdentity.sex"
                        class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                        创建
                    </button>
                </div>
            </div>
        </div>

        <!-- 删除确认对话框 -->
        <div v-if="deleteConfirmIdentity" class="fixed inset-0 z-[90] bg-black/60 flex items-center justify-center" @click="deleteConfirmIdentity = null">
            <div class="w-80 bg-[#18181b] rounded-2xl p-6 shadow-2xl" @click.stop>
                <div class="text-center mb-4">
                    <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-3"></i>
                    <h3 class="text-lg font-bold text-white mb-2">确认删除</h3>
                    <p class="text-sm text-gray-400">确定要删除身份 <span class="text-white font-medium">{{ deleteConfirmIdentity.name }}</span> 吗？</p>
                    <p class="text-xs text-gray-500 mt-1">此操作无法撤销</p>
                </div>

                <!-- 按钮 -->
                <div class="flex gap-3">
                    <button @click="deleteConfirmIdentity = null"
                        class="flex-1 py-3 bg-[#27272a] text-gray-400 rounded-xl border border-gray-700">
                        取消
                    </button>
                    <button @click="confirmDeleteIdentity"
                        class="flex-1 py-3 bg-red-600 text-white rounded-xl font-medium">
                        删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- === 用户配置抽屉 === -->
    <div v-if="showSettings" class="fixed inset-0 z-[70] bg-black/50" @click="showSettings = false">
        <div class="absolute right-0 top-0 bottom-0 w-80 bg-[#18181b] shadow-2xl overflow-y-auto" @click.stop>
            <!-- 头部 -->
            <div class="h-14 flex items-center justify-between px-4 border-b border-gray-800">
                <h2 class="text-lg font-bold">{{ settingsMode === 'identity' ? '身份信息' : '系统设置' }}</h2>
                <div class="flex items-center gap-2">
                    <button v-if="settingsMode === 'identity' && !editMode" @click="editMode = true; initEditMode()" class="px-3 py-1 bg-indigo-600 text-white text-sm rounded-lg">
                        编辑
                    </button>
                    <button v-else-if="settingsMode === 'identity' && editMode" @click="saveUserInfo" :disabled="waitingForResponse" class="px-3 py-1 bg-green-600 text-white text-sm rounded-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                        <span v-if="waitingForResponse" class="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
                        <span>{{ waitingForResponse ? '保存中...' : '保存' }}</span>
                    </button>
                    <button @click="showSettings = false; editMode = false; waitingForResponse = false" class="w-10 h-10 flex items-center justify-center text-gray-400">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- 身份信息内容 -->
            <div v-if="settingsMode === 'identity'" class="p-6 space-y-6">
                <!-- 头像占位 -->
                <div class="flex justify-center">
                    <div class="w-24 h-24 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-3xl font-bold shadow-lg">
                        {{ currentUser.name.charAt(0) }}
                    </div>
                </div>

                <!-- 用户信息列表 -->
                <div class="space-y-4">
                    <!-- 用户名 -->
                    <div class="bg-[#27272a] rounded-xl p-4">
                        <div class="text-xs text-gray-500 mb-2">用户名</div>
                        <input
                            v-if="editMode"
                            v-model="editUserInfo.name"
                            type="text"
                            class="w-full bg-[#18181b] text-white px-3 py-2 rounded-lg border border-gray-700 focus:border-indigo-500 focus:outline-none"
                            placeholder="输入用户名"
                        />
                        <div v-else class="text-base text-white font-medium">{{ currentUser.name }}</div>
                    </div>

                    <!-- 用户ID -->
                    <div class="bg-[#27272a] rounded-xl p-4">
                        <div class="text-xs text-gray-500 mb-2">用户ID</div>
                        <input
                            v-if="editMode"
                            v-model="editUserInfo.id"
                            type="text"
                            class="w-full bg-[#18181b] text-white px-3 py-2 rounded-lg border border-gray-700 focus:border-indigo-500 focus:outline-none font-mono text-sm"
                            placeholder="输入用户ID"
                        />
                        <div v-else class="text-base text-white font-mono text-sm break-all">{{ currentUser.id }}</div>
                    </div>

                    <!-- 性别 -->
                    <div class="bg-[#27272a] rounded-xl p-4">
                        <div class="text-xs text-gray-500 mb-2">性别</div>
                        <select
                            v-if="editMode"
                            v-model="editUserInfo.sex"
                            class="w-full bg-[#18181b] text-white px-3 py-2 rounded-lg border border-gray-700 focus:border-indigo-500 focus:outline-none"
                        >
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                        <div v-else class="text-base text-white">{{ currentUser.sex }}</div>
                    </div>

                    <!-- IP地址（不可修改） -->
                    <div class="bg-[#27272a] rounded-xl p-4">
                        <div class="text-xs text-gray-500 mb-1">IP地址</div>
                        <div class="text-base text-white">{{ currentUser.ip }}</div>
                    </div>

                    <!-- 地区（不可修改） -->
                    <div class="bg-[#27272a] rounded-xl p-4">
                        <div class="text-xs text-gray-500 mb-1">地区</div>
                        <div class="text-base text-white">{{ currentUser.address }}</div>
                    </div>
                </div>

                <!-- 连接状态 -->
                <div class="bg-[#27272a] rounded-xl p-4 flex items-center justify-between">
                    <span class="text-sm text-gray-400">WebSocket 状态</span>
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full" :class="wsConnected ? 'bg-green-500' : 'bg-red-500'"></span>
                        <span class="text-sm" :class="wsConnected ? 'text-green-500' : 'text-red-500'">
                            {{ wsConnected ? '已连接' : '未连接' }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- 系统设置内容 -->
            <div v-if="settingsMode === 'system'" class="p-6 space-y-6">
                <!-- WebSocket连接管理 -->
                <div class="bg-[#27272a] rounded-xl p-4">
                    <h3 class="text-white font-medium mb-4 flex items-center gap-2">
                        <i class="fas fa-network-wired text-blue-400"></i>
                        <span>连接管理</span>
                    </h3>

                    <div class="space-y-3">
                        <!-- 连接统计 -->
                        <div class="bg-[#18181b] rounded-lg p-3 space-y-2">
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-400">总连接数</span>
                                <span class="text-white font-mono">{{ connectionStats.active || 0 }}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-400">上游连接</span>
                                <span class="text-green-400 font-mono">{{ connectionStats.upstream || 0 }}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-400">下游连接</span>
                                <span class="text-blue-400 font-mono">{{ connectionStats.downstream || 0 }}</span>
                            </div>
                        </div>

                        <!-- 断开所有连接按钮 -->
                        <button @click="confirmDisconnectAll"
                            :disabled="disconnectAllLoading"
                            class="w-full py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-medium transition disabled:opacity-50 flex items-center justify-center gap-2">
                            <i class="fas fa-power-off"></i>
                            <span>{{ disconnectAllLoading ? '断开中...' : '断开所有连接' }}</span>
                        </button>

                        <p class="text-xs text-gray-500 text-center">
                            此操作会断开所有客户端和上游服务器的连接
                        </p>
                    </div>
                </div>

                <!-- 媒体管理 -->
                <div class="bg-[#27272a] rounded-xl p-4">
                    <h3 class="text-white font-medium mb-4 flex items-center gap-2">
                        <i class="fas fa-images text-purple-400"></i>
                        <span>媒体管理</span>
                    </h3>

                    <div class="space-y-3">
                        <!-- 统计信息 -->
                        <div class="bg-[#18181b] rounded-lg p-3">
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-400">总上传数</span>
                                <span class="text-white font-mono">{{ allUploadTotal || 0 }} 张</span>
                            </div>
                        </div>

                        <!-- 管理按钮 -->
                        <button @click="openMediaManagementModal"
                            class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-medium transition flex items-center justify-center gap-2">
                            <i class="fas fa-cog"></i>
                            <span>管理已上传图片</span>
                        </button>

                        <p class="text-xs text-gray-500 text-center">
                            可以删除不需要的图片
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === 历史聊天图片弹出框 === -->
    <div v-if="showHistoryImageModal" class="fixed inset-0 z-[75] bg-black/70 flex items-center justify-center" @click="closeHistoryImageModal">
        <div class="w-[90%] max-w-2xl h-[70vh] bg-[#18181b] rounded-2xl shadow-2xl flex flex-col" @click.stop>
            <!-- 头部 -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-800">
                <div class="flex items-center gap-2">
                    <i class="fas fa-history text-green-500"></i>
                    <h3 class="text-lg font-bold text-white">
                        与 {{ currentChatUser?.name }} 的聊天历史图片
                    </h3>
                </div>
                <button @click="closeHistoryImageModal" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-white transition rounded-lg hover:bg-[#27272a]">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- 加载状态 -->
            <div v-if="historyImageLoading" class="flex-1 flex items-center justify-center">
                <div class="text-center">
                    <div class="radar-spinner mx-auto mb-3"></div>
                    <p class="text-gray-500 text-sm">加载中...</p>
                </div>
            </div>

            <!-- 图片网格 -->
            <div v-else-if="chatHistoryImages && chatHistoryImages.length > 0"
                 class="flex-1 overflow-y-auto p-6 no-scrollbar">
                <div class="grid grid-cols-3 sm:grid-cols-4 gap-4">
                    <div v-for="(media, idx) in chatHistoryImages" :key="'modal-history-' + idx"
                        @click="previewUploadMedia(media)"
                        class="aspect-square rounded-xl overflow-hidden cursor-pointer border-2 border-gray-700 hover:border-green-500 transition-all hover:scale-105 relative group">
                        <img v-if="media.type === 'image'"
                             :src="media.url"
                             class="w-full h-full object-cover">
                        <video v-if="media.type === 'video'"
                               :src="media.url"
                               class="w-full h-full object-cover"></video>

                        <!-- 视频播放图标 -->
                        <div v-if="media.type === 'video'"
                             class="absolute inset-0 flex items-center justify-center bg-black/40 group-hover:bg-black/60 transition">
                            <i class="fas fa-play-circle text-white text-4xl"></i>
                        </div>

                        <!-- 悬停提示 -->
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition flex items-end justify-center pb-3">
                            <span class="text-white text-xs font-medium">
                                <i class="fas fa-search-plus mr-1"></i>点击预览
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 空状态 -->
            <div v-else class="flex-1 flex items-center justify-center">
                <div class="text-center text-gray-500">
                    <i class="fas fa-image text-5xl mb-4 opacity-30"></i>
                    <p>暂无聊天历史图片</p>
                </div>
            </div>

            <!-- 底部提示 -->
            <div class="px-6 py-4 border-t border-gray-800 text-center text-xs text-gray-500">
                点击图片/视频预览，在预览中可上传/重新上传，再在上方"已上传的文件"中点击发送
            </div>
        </div>
    </div>

    <!-- === 所有上传图片弹出框 === -->
    <div v-if="showAllUploadImageModal" class="fixed inset-0 z-[75] bg-black/70 flex items-center justify-center" @click="closeAllUploadImageModal">
        <div class="w-[90%] max-w-2xl h-[70vh] bg-[#18181b] rounded-2xl shadow-2xl flex flex-col" @click.stop>
            <!-- 头部 -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-800">
                <div class="flex items-center gap-2">
                    <i class="fas fa-images" :class="managementMode ? 'text-purple-500' : 'text-blue-500'"></i>
                    <h3 class="text-lg font-bold text-white">
                        {{ managementMode ? '管理已上传图片' : '所有上传图片' }}
                    </h3>
                    <span class="text-xs text-gray-500 ml-2">(共 {{ allUploadTotal }} 张)</span>
                </div>

                <!-- 管理模式下的操作按钮 -->
                <div v-if="managementMode" class="flex items-center gap-2">
                    <button @click="toggleSelectionMode"
                        :class="selectionMode ? 'bg-purple-600' : 'bg-gray-700'"
                        class="px-3 py-1.5 text-white text-sm rounded-lg transition flex items-center gap-1">
                        <i :class="selectionMode ? 'fas fa-check-square' : 'far fa-square'"></i>
                        <span>{{ selectionMode ? '取消选择' : '选择' }}</span>
                    </button>

                    <button @click="triggerUploadInModal"
                        class="px-3 py-1.5 bg-indigo-600 text-white text-sm rounded-lg transition hover:bg-indigo-700 flex items-center gap-1">
                        <i class="fas fa-upload"></i>
                        <span>上传</span>
                    </button>
                </div>

                <button @click="closeAllUploadImageModal" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-white transition rounded-lg hover:bg-[#27272a]">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- 加载状态 -->
            <div v-if="allUploadLoading && allUploadImages.length === 0" class="flex-1 flex items-center justify-center">
                <div class="text-center">
                    <div class="radar-spinner mx-auto mb-3"></div>
                    <p class="text-gray-500 text-sm">加载中...</p>
                </div>
            </div>

            <!-- 图片网格（带滚动加载） -->
            <div v-else-if="allUploadImages && allUploadImages.length > 0"
                 class="flex-1 overflow-y-auto p-6 no-scrollbar"
                 @scroll="handleAllUploadScroll"
                 ref="allUploadScrollContainer">
                <div class="grid grid-cols-3 sm:grid-cols-4 gap-4">
                    <div v-for="(media, idx) in allUploadImages" :key="'all-upload-' + idx"
                        class="aspect-square rounded-xl overflow-hidden cursor-pointer border-2 transition-all relative group"
                        :class="[
                            selectedImages.includes(media.url) ? 'border-purple-500' : 'border-gray-700',
                            deletingImages.has(media.url) ? 'opacity-50' : 'hover:border-blue-500 hover:scale-105'
                        ]"
                        @click="handleImageClick(media)">

                        <!-- 多选复选框（管理模式 + 选择模式下显示） -->
                        <div v-if="managementMode && selectionMode"
                             class="absolute top-2 left-2 z-10"
                             @click.stop="toggleImageSelection(media)">
                            <div class="w-6 h-6 rounded bg-black/50 flex items-center justify-center">
                                <i v-if="selectedImages.includes(media.url)"
                                   class="fas fa-check-circle text-purple-500 text-lg"></i>
                                <i v-else class="far fa-circle text-white text-lg"></i>
                            </div>
                        </div>

                        <!-- 删除按钮（管理模式 + 非选择模式下显示） -->
                        <button v-if="managementMode && !selectionMode && !deletingImages.has(media.url)"
                            @click.stop="confirmDeleteSingle(media)"
                            class="absolute top-2 right-2 z-10 w-8 h-8 bg-black/70 rounded-full flex items-center justify-center text-red-500 opacity-0 group-hover:opacity-100 transition hover:bg-red-600 hover:text-white">
                            <i class="fas fa-trash text-sm"></i>
                        </button>

                        <!-- 删除中加载图标 -->
                        <div v-if="deletingImages.has(media.url)"
                             class="absolute inset-0 bg-black/70 flex items-center justify-center z-20">
                            <div class="w-8 h-8 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                        </div>

                        <img v-if="media.type === 'image'"
                             :src="media.url"
                             class="w-full h-full object-cover">
                        <video v-if="media.type === 'video'"
                               :src="media.url"
                               class="w-full h-full object-cover"></video>

                        <!-- 视频播放图标 -->
                        <div v-if="media.type === 'video'"
                             class="absolute inset-0 flex items-center justify-center bg-black/40 group-hover:bg-black/60 transition">
                            <i class="fas fa-play-circle text-white text-4xl"></i>
                        </div>

                        <!-- 悬停提示 -->
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition flex items-end justify-center pb-3">
                            <span class="text-white text-xs font-medium">
                                <i class="fas fa-search-plus mr-1"></i>{{ managementMode && !selectionMode ? '预览/删除' : '点击预览' }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- 加载更多提示 -->
                <div v-if="allUploadLoading" class="text-center py-4">
                    <div class="inline-flex items-center gap-2 text-gray-500 text-sm">
                        <div class="w-4 h-4 border-2 border-gray-500 border-t-transparent rounded-full animate-spin"></div>
                        <span>加载中...</span>
                    </div>
                </div>

                <!-- 没有更多提示 -->
                <div v-else-if="allUploadPage >= allUploadTotalPages && allUploadImages.length > 0"
                     class="text-center py-4 text-gray-500 text-sm">
                    没有更多图片了
                </div>
            </div>

            <!-- 空状态 -->
            <div v-else class="flex-1 flex items-center justify-center">
                <div class="text-center text-gray-500">
                    <i class="fas fa-image text-5xl mb-4 opacity-30"></i>
                    <p>暂无上传图片</p>
                </div>
            </div>

            <!-- 批量操作栏（管理模式 + 选择模式 + 有选中项时显示） -->
            <div v-if="managementMode && selectionMode && selectedImages.length > 0"
                 class="px-6 py-4 bg-[#1a1a1d] border-t border-gray-800">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-400">
                        已选中 <span class="text-white font-bold">{{ selectedImages.length }}</span> 张
                        <span v-if="selectedImages.length >= 50" class="text-yellow-500 ml-2">
                            （已达单次删除上限）
                        </span>
                    </div>
                    <div class="flex gap-2">
                        <button @click="selectAll"
                            class="px-4 py-2 bg-gray-700 text-white text-sm rounded-lg hover:bg-gray-600 transition">
                            {{ selectedImages.length === allUploadImages.length ? '取消全选' : '全选当前页' }}
                        </button>
                        <button @click="confirmBatchDelete"
                            :disabled="selectedImages.length === 0 || selectedImages.length > 50"
                            class="px-4 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                            <i class="fas fa-trash"></i>
                            <span>批量删除</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 底部提示 -->
            <div class="px-6 py-4 border-t border-gray-800 text-center text-xs text-gray-500">
                {{ managementMode ? '提示：点击图片预览，悬停显示删除按钮' : '点击图片将重新上传至服务器，然后可发送' }}
            </div>
        </div>
    </div>

    <!-- === 删除确认对话框 === -->
    <div v-if="showMediaDeleteConfirm"
         class="fixed inset-0 z-[95] bg-black/60 flex items-center justify-center"
         @click="showMediaDeleteConfirm = false">
        <div class="w-96 bg-[#18181b] rounded-2xl p-6 shadow-2xl" @click.stop>
            <div class="text-center mb-4">
                <i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-3"></i>
                <h3 class="text-xl font-bold text-white mb-2">确认删除</h3>

                <!-- 单个删除 -->
                <div v-if="deleteTargets.length === 1">
                    <p class="text-sm text-gray-400 mb-2">确定要删除这张{{ deleteTargets[0].type === 'image' ? '图片' : '视频' }}吗？</p>
                    <div class="text-xs text-gray-500 bg-[#27272a] rounded-lg p-3 mt-3">
                        <p class="truncate">{{ extractFileName(deleteTargets[0].url) }}</p>
                    </div>
                </div>

                <!-- 批量删除 -->
                <div v-else>
                    <p class="text-sm text-gray-400 mb-2">确定要删除选中的 <span class="text-red-500 font-bold">{{ deleteTargets.length }}</span> 张图片吗？</p>
                    <div class="text-xs text-gray-500 bg-[#27272a] rounded-lg p-3 mt-3 max-h-32 overflow-y-auto">
                        <p v-for="(target, idx) in deleteTargets.slice(0, 5)" :key="idx" class="truncate">
                            {{ idx + 1 }}. {{ extractFileName(target.url) }}
                        </p>
                        <p v-if="deleteTargets.length > 5" class="text-gray-600 mt-1">
                            ... 还有 {{ deleteTargets.length - 5 }} 张
                        </p>
                    </div>
                </div>

                <p class="text-xs text-red-400 mt-3">
                    <i class="fas fa-info-circle mr-1"></i>删除后无法恢复！
                </p>
            </div>

            <!-- 按钮 -->
            <div class="flex gap-3">
                <button @click="showMediaDeleteConfirm = false"
                    class="flex-1 py-3 bg-[#27272a] text-gray-400 rounded-xl border border-gray-700 hover:bg-[#333] transition">
                    取消
                </button>
                <button @click="executeDelete"
                    :disabled="deleting"
                    class="flex-1 py-3 bg-red-600 text-white rounded-xl font-medium hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                    <span v-if="deleting" class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
                    <span>{{ deleting ? '删除中...' : '确认删除' }}</span>
                </button>
            </div>
        </div>
    </div>

    <!-- === 切换身份确认对话框 === -->
    <div v-if="showSwitchIdentityDialog"
         class="fixed inset-0 z-[90] bg-black/60 flex items-center justify-center"
         @click="cancelSwitchIdentity">
        <div class="w-80 bg-[#18181b] rounded-2xl p-6 shadow-2xl" @click.stop>
            <div class="text-center mb-4">
                <i class="fas fa-exchange-alt text-4xl text-indigo-500 mb-3"></i>
                <h3 class="text-lg font-bold text-white mb-2">确认切换身份</h3>
                <p class="text-sm text-gray-400">切换身份后，当前聊天会话将关闭</p>
                <p class="text-xs text-gray-500 mt-1">聊天记录不会丢失</p>
            </div>

            <div class="flex gap-3">
                <button @click="cancelSwitchIdentity"
                    class="flex-1 py-3 bg-[#27272a] text-gray-400 rounded-xl border border-gray-700 hover:bg-[#333] transition">
                    取消
                </button>
                <button @click="confirmSwitchIdentity"
                    class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-medium hover:bg-indigo-700 transition">
                    确认切换
                </button>
            </div>
        </div>
    </div>

    <!-- === 断开所有连接确认对话框 === -->
    <div v-if="showDisconnectAllDialog"
         class="fixed inset-0 z-[90] bg-black/60 flex items-center justify-center"
         @click="showDisconnectAllDialog = false">
        <div class="w-80 bg-[#18181b] rounded-2xl p-6 shadow-2xl" @click.stop>
            <div class="text-center mb-4">
                <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-3"></i>
                <h3 class="text-lg font-bold text-white mb-2">确认断开所有连接</h3>
                <p class="text-sm text-gray-400">此操作将断开所有客户端的连接</p>
                <p class="text-xs text-gray-500 mt-1">包括上游和下游的所有WebSocket连接</p>
            </div>

            <div class="flex gap-3">
                <button @click="showDisconnectAllDialog = false"
                    class="flex-1 py-3 bg-[#27272a] text-gray-400 rounded-xl border border-gray-700 hover:bg-[#333] transition">
                    取消
                </button>
                <button @click="executeDisconnectAll"
                    class="flex-1 py-3 bg-red-600 text-white rounded-xl font-medium hover:bg-red-700 transition">
                    确认断开
                </button>
            </div>
        </div>
    </div>

    <!-- === 匹配蒙层 (模拟匹配过程) === -->
    <div v-if="isMatching" class="fixed inset-0 z-[60] bg-black/90 flex flex-col items-center justify-center text-center">
        <div class="relative w-32 h-32 mb-8">
            <div class="absolute inset-0 border-4 border-blue-500/30 rounded-full animate-ping"></div>
            <div class="absolute inset-0 border-4 border-blue-500 rounded-full flex items-center justify-center">
                <i class="fas fa-satellite-dish text-4xl text-blue-400"></i>
            </div>
        </div>
        <h2 class="text-xl font-bold mb-2">正在寻找有缘人...</h2>
        <p class="text-gray-400 text-sm">匹配完全匿名</p>
        <button @click="cancelMatch" class="mt-8 px-6 py-2 border border-gray-600 rounded-full text-gray-400 text-sm">取消</button>
    </div>

    <!-- === 页面 1: 会话列表 / 收藏列表 === -->
    <div class="page-container" v-if="!showIdentityPicker && !currentChatUser" @click.self="showTopMenu = false">
        
        <!-- 顶部切换栏 -->
        <div class="flex items-center justify-between pt-4 pb-2 px-4 bg-[#0f0f13] z-10">
            <!-- 左侧：菜单按钮（下拉） -->
            <div class="relative">
                <button @click.stop="showTopMenu = !showTopMenu"
                    class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-white transition">
                    <i class="fas fa-bars text-xl"></i>
                </button>

                <!-- 下拉菜单 -->
                <div v-if="showTopMenu"
                     @click.stop
                     class="absolute left-0 top-12 w-48 bg-[#18181b] rounded-xl shadow-2xl border border-gray-700 z-50">
                    <button @click="openIdentitySettings"
                        class="w-full px-4 py-3 text-left hover:bg-[#27272a] text-white flex items-center gap-3 rounded-t-xl transition">
                        <i class="fas fa-user-edit text-blue-400"></i>
                        <span>身份信息</span>
                    </button>
                    <button @click="openSystemSettings"
                        class="w-full px-4 py-3 text-left hover:bg-[#27272a] text-white flex items-center gap-3 border-t border-gray-700 transition">
                        <i class="fas fa-cog text-gray-400"></i>
                        <span>系统设置</span>
                    </button>
                    <button @click="showSwitchIdentityConfirm"
                        class="w-full px-4 py-3 text-left hover:bg-[#27272a] text-white flex items-center gap-3 border-t border-gray-700 rounded-b-xl transition">
                        <i class="fas fa-user-circle text-indigo-400"></i>
                        <span>切换身份</span>
                    </button>
                </div>
            </div>

            <!-- 中间：切换栏 -->
            <div class="flex bg-[#1f1f22] p-1 rounded-full">
                <button
                    @click="switchTab('history')"
                    :class="activeTab === 'history' ? 'bg-[#2d2d33] text-white shadow-md' : 'text-gray-500'"
                    class="px-6 py-1.5 rounded-full text-sm font-medium transition-all duration-300">
                    消息
                </button>
                <button
                    @click="switchTab('favorites')"
                    :class="activeTab === 'favorites' ? 'bg-[#2d2d33] text-white shadow-md' : 'text-gray-500'"
                    class="px-6 py-1.5 rounded-full text-sm font-medium transition-all duration-300">
                    收藏
                </button>
            </div>

            <!-- 右侧：连接状态 -->
            <div class="flex items-center gap-1">
                <span class="w-2 h-2 rounded-full" :class="wsConnected ? 'bg-green-500' : 'bg-red-500'"></span>
            </div>
        </div>

        <!-- 列表内容 -->
        <div ref="listArea" class="list-area no-scrollbar px-4 pt-2">
            <div v-for="user in displayList" :key="user.id" @click="enterChat(user)" 
                 class="flex items-center p-4 mb-3 bg-[#18181b] rounded-2xl active:scale-[0.98] transition-transform duration-100">
                
                <!-- 纯色块代替头像 -->
                <div :class="user.colorClass" class="w-12 h-12 rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-lg shrink-0">
                    {{ user.name.charAt(0) }}
                </div>

                <!-- 文本信息 -->
                <div class="ml-4 flex-1 min-w-0">
                    <div class="flex justify-between items-baseline mb-1">
                        <span class="font-bold text-base truncate">{{ user.name }}</span>
                        <span class="text-xs text-gray-500">{{ user.lastTime }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <p class="text-sm text-gray-400 truncate pr-2">{{ user.lastMsg }}</p>
                        <!-- 收藏标识 -->
                        <i v-if="user.isFavorite && activeTab === 'history'" class="fas fa-star text-xs text-yellow-500"></i>
                    </div>
                </div>

                <!-- 未读消息数气泡 -->
                <span v-if="user.unreadCount > 0"
                    class="px-2 py-0.5 bg-red-500 text-white text-xs rounded-full min-w-[20px] text-center font-medium ml-2">
                    {{ user.unreadCount }}
                </span>
            </div>

            <!-- 空状态提示 -->
            <div v-if="!displayList || displayList.length === 0" class="flex flex-col items-center justify-center mt-20 text-gray-600">
                <i class="far fa-comments text-5xl mb-4 opacity-50"></i>
                <p class="text-sm">暂无{{ activeTab === 'history' ? '消息' : '收藏' }}</p>
            </div>
        </div>

        <!-- 底部悬浮匹配按钮 -->
        <div class="match-btn-container">
            <button @click="startMatch" class="match-btn flex items-center px-6 py-3 rounded-full text-white font-bold">
                <i class="fas fa-random mr-2"></i> 匹配新用户
            </button>
        </div>
    </div>

    <!-- === 页面 2: 聊天界面 === -->
    <div class="page-container bg-[#0f0f13] absolute inset-0 z-50" v-if="!showIdentityPicker && currentChatUser">

        <!-- 聊天头部 -->
        <div class="bg-[#18181b]/90 backdrop-blur-sm border-b border-gray-800 sticky top-0 z-20 px-4 py-3">
            <div class="flex items-center justify-between mb-2">
                <button @click="exitChat" class="w-10 h-10 flex items-center justify-start text-gray-300">
                    <i class="fas fa-chevron-left text-xl"></i>
                </button>
                <div class="font-bold text-base">{{ currentChatUser.name }}</div>
                <button @click="toggleFavorite(currentChatUser)" class="w-10 h-10 flex items-center justify-end">
                    <i :class="currentChatUser.isFavorite ? 'fas fa-star text-yellow-500' : 'far fa-star text-gray-400'"></i>
                </button>
            </div>
            <div class="flex items-center justify-center gap-3 text-xs text-gray-400">
                <div class="flex items-center gap-1" v-if="currentChatUser.sex">
                    <i class="fas fa-venus-mars"></i>
                    <span>{{ currentChatUser.sex }}</span>
                </div>
                <div class="flex items-center gap-1" v-if="currentChatUser.age && currentChatUser.age !== '0'">
                    <i class="fas fa-birthday-cake"></i>
                    <span>{{ currentChatUser.age }}岁</span>
                </div>
                <div class="flex items-center gap-1" v-if="currentChatUser.address">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>{{ currentChatUser.address }}</span>
                </div>
                <div class="flex items-center gap-1" :class="wsConnected ? 'text-green-500' : 'text-red-500'">
                    <span class="w-1.5 h-1.5 rounded-full" :class="wsConnected ? 'bg-green-500' : 'bg-red-500'"></span>
                    <span>{{ wsConnected ? '已连接' : '未连接' }}</span>
                </div>
            </div>
        </div>

        <!-- 聊天内容 (无头像) -->
        <div class="chat-area flex flex-col no-scrollbar" ref="chatBox" @click="closeAllPanels">
            <!-- 加载更多历史消息按钮 -->
            <div class="flex justify-center py-3">
                <button @click="loadMoreHistory" :disabled="loadingMore" class="px-4 py-2 bg-[#27272a] text-gray-400 text-sm rounded-full active:bg-[#3a3a3f] disabled:opacity-50">
                    <span v-if="loadingMore">加载中...</span>
                    <span v-else>查看历史消息</span>
                </button>
            </div>

            <div v-for="(msg, index) in chatHistory[currentChatUser.id] || []" :key="index"
                 class="flex flex-col w-full mb-3" :class="msg.isSelf ? 'items-end' : 'items-start'">

                <!-- 昵称 + 时间 -->
                <div class="text-xs text-gray-500 mb-1 flex items-center gap-2" :class="msg.isSelf ? 'mr-1 justify-end' : 'ml-1'">
                    <span v-if="msg.nickname" class="font-medium">{{ msg.nickname }}</span>
                    <span v-if="msg.time">{{ formatTime(msg.time) }}</span>
                </div>

                <div class="msg-bubble" :class="msg.isSelf ? 'msg-right' : 'msg-left'">
                    <!-- 文本（支持表情解析） -->
                    <span v-if="msg.type === 'text'" v-html="parseEmoji(msg.content)"></span>

                    <!-- 图片 -->
                    <img v-if="msg.type === 'image'" :src="msg.content" class="rounded-lg max-w-full block" @click="previewMedia(msg.content)">

                    <!-- 视频 -->
                    <video v-if="msg.type === 'video'" :src="msg.content" controls class="rounded-lg max-w-full block"></video>
                </div>
            </div>

            <!-- 正在输入提示 -->
            <div v-if="isTyping" class="flex w-full justify-start mb-3">
                <div class="msg-bubble msg-left flex items-center gap-2">
                    <span class="text-gray-400">正在输入</span>
                    <div class="flex gap-1">
                        <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0s"></span>
                        <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                        <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 上传菜单面板 -->
        <div v-if="showUploadMenu" class="bg-[#1a1a1d] border-t border-gray-800 p-4 max-h-96 overflow-y-auto" @click.stop>

            <!-- 区域1：已上传的文件（点击发送） -->
            <div v-if="uploadedMedia && uploadedMedia.length > 0" class="mb-4">
                <div class="text-xs text-gray-500 mb-2">
                    <i class="fas fa-check-circle text-indigo-500 mr-1"></i>已上传的文件（点击发送）
                </div>
                <div class="flex flex-wrap gap-2">
                    <div v-for="(media, idx) in uploadedMedia" :key="idx"
                        @click="sendMediaMessage(media)"
                        class="w-16 h-16 rounded-lg overflow-hidden cursor-pointer border border-gray-700 hover:border-indigo-500 transition relative">
                        <img v-if="media.type === 'image'" :src="media.url" class="w-full h-full object-cover">
                        <video v-if="media.type === 'video'" :src="media.url" class="w-full h-full object-cover"></video>
                        <div v-if="media.type === 'video'" class="absolute inset-0 flex items-center justify-center bg-black/30">
                            <i class="fas fa-play-circle text-white text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 空状态提示 -->
            <div v-if="!uploadedMedia || uploadedMedia.length === 0" class="text-xs text-gray-500 mb-3">
                暂无已上传的文件
            </div>

            <!-- 选择文件按钮 -->
            <button @click="triggerFileSelect" class="w-full py-3 bg-[#27272a] text-white rounded-xl hover:bg-[#333] transition">
                <i class="fas fa-folder-open mr-2"></i>选择文件上传
            </button>

            <!-- 历史聊天图片按钮 -->
            <button @click="openHistoryImageModal"
                    v-if="currentChatUser"
                    class="w-full py-3 bg-[#27272a] text-white rounded-xl hover:bg-[#333] transition mt-2">
                <i class="fas fa-history mr-2 text-green-500"></i>历史聊天图片
            </button>

            <!-- 所有上传图片按钮 -->
            <button @click="openAllUploadImageModal"
                    class="w-full py-3 bg-[#27272a] text-white rounded-xl hover:bg-[#333] transition mt-2">
                <i class="fas fa-images mr-2 text-blue-500"></i>所有上传图片
            </button>
        </div>

        <!-- 表情选择面板 -->
        <div v-if="showEmojiPanel" class="bg-[#1a1a1d] border-t border-gray-800 p-4 max-h-60 overflow-y-auto" @click.stop>
            <div class="text-xs text-gray-500 mb-3">选择表情</div>
            <div class="grid grid-cols-10 gap-1.5">
                <div v-for="(url, name) in emojiMap" :key="name"
                    @click="insertEmoji(name)"
                    class="cursor-pointer hover:bg-[#27272a] rounded p-1 transition flex items-center justify-center">
                    <img :src="url" class="w-5 h-5">
                </div>
            </div>
        </div>

        <!-- 底部输入框 -->
        <div class="bg-[#18181b] px-4 py-3 pb-safe flex items-end border-t border-gray-800">
            <div class="flex items-center gap-2 mr-3 mb-1">
                <i class="fas fa-plus-circle text-2xl text-gray-400 active:text-white transition" @click.stop="selectFile"></i>
                <i class="fas fa-smile text-2xl text-gray-400 active:text-yellow-400 transition" @click.stop="toggleEmojiPanel"></i>
                <input type="file" ref="fileInput" class="hidden" @change="handleFileUpload">
            </div>

            <div class="flex-1 bg-[#27272a] rounded-2xl min-h-[40px] flex items-center px-4 py-2 mr-3">
                <textarea
                    v-model="inputText"
                    placeholder="发消息..."
                    class="w-full bg-transparent text-white outline-none text-base resize-none overflow-hidden h-6 leading-6"
                    rows="1"
                    @input="autoResize"
                    @keydown.enter.exact.prevent="sendMessage"
                ></textarea>
            </div>

            <button @click="sendMessage"
                class="mb-1 w-9 h-9 rounded-full bg-indigo-600 flex items-center justify-center text-white disabled:opacity-50 disabled:bg-gray-700 transition"
                :disabled="!inputText.trim()">
                <i class="fas fa-paper-plane text-xs"></i>
            </button>

            <!-- 匹配新用户按钮 -->
            <button @click="startMatch"
                class="ml-2 mb-1 w-9 h-9 rounded-full bg-purple-600 flex items-center justify-center text-white transition hover:bg-purple-700 active:scale-95"
                title="匹配新用户">
                <i class="fas fa-random text-xs"></i>
            </button>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, nextTick } = Vue;

    createApp({
        setup() {
            // 动态获取服务器地址
            const SERVER_HOST = window.location.host;
            const API_BASE = `http://${SERVER_HOST}/api`;
            const WS_URL = `ws://${SERVER_HOST}/ws`;

            // 随机颜色池
            const colors = ['bg-color-1', 'bg-color-2', 'bg-color-3', 'bg-color-4', 'bg-color-5'];
            const getRandomColor = () => colors[Math.floor(Math.random() * colors.length)];

            // 随机生成 IP 地址
            const generateRandomIP = () => {
                const part1 = Math.floor(Math.random() * 256);
                const part2 = Math.floor(Math.random() * 256);
                const part3 = Math.floor(Math.random() * 256);
                const part4 = Math.floor(Math.random() * 256);
                return `${part1}.${part2}.${part3}.${part4}`;
            };

            // 生成随机 Session ID
            const generateSessionId = () => {
                const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
                let result = '';
                for (let i = 0; i < 24; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            };

            // 生成随机32位ID（用于 randomOut 等消息）
            const generateRandomId = () => {
                const chars = 'abcdef0123456789';
                let result = '';
                for (let i = 0; i < 32; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            };

            // 生成 Cookie 字符串
            const generateCookie = (userid, nickname) => {
                const sessionId = generateSessionId();
                const encodedNickname = encodeURIComponent(nickname);
                return `room_name_random=%E5%85%AC%E5%85%B1%E5%9C%BA%E6%89%80; room_psw_random=; userAge=0; switchvipsex=0; switchVipAddress=0; switchHealthMode=0; isMoon=-1; ASP.NET_SessionId=${sessionId}; user_id=${userid}; user_nickname_random=${encodedNickname}; SlideSysInfos=0`;
            };

            // 状态管理
            const activeTab = ref('history'); // 默认显示历史 tab，但不自动加载
            const isMatching = ref(false);
            const currentChatUser = ref(null);
            const inputText = ref('');
            const fileInput = ref(null);
            const chatBox = ref(null);
            const listArea = ref(null); // 列表区域引用
            const savedScrollPosition = ref(0); // 保存的滚动位置
            const showSettings = ref(false); // 显示设置面板
            const editMode = ref(false); // 编辑模式
            const isTyping = ref(false); // 对方是否正在输入
            const toastMessage = ref(''); // Toast 消息

            // 身份选择相关状态
            const showIdentityPicker = ref(true); // 是否显示身份选择页
            const identityList = ref([]); // 身份列表
            const identityLoading = ref(false); // 加载状态
            const showCreateForm = ref(false); // 显示创建表单
            const newIdentity = ref({ name: '', sex: '' }); // 新建身份表单数据
            const deleteConfirmIdentity = ref(null); // 待删除的身份（用于确认对话框）

            // 登录认证相关状态
            const showLoginPage = ref(true); // 是否显示登录页
            const loginAccessCode = ref(''); // 输入的访问码
            const loginLoading = ref(false); // 登录加载中
            const authToken = ref(''); // JWT Token

            // Toast 显示方法
            const showToast = (message, duration = 2000) => {
                toastMessage.value = message;
                setTimeout(() => { toastMessage.value = ''; }, duration);
            };

            // 当前用户信息
            const currentUser = ref({
                id: '3cfbecb0a6224f9693315eeb3c89cde4',
                name: '哎吃',
                sex: '女',
                ip: '188.253.116.115',
                address: '美国'
            });

            // 编辑用户信息（副本）
            const editUserInfo = ref({
                id: '',
                name: '',
                sex: ''
            });

            // WebSocket 连接
            let ws = null;
            const wsConnected = ref(false);
            const waitingForResponse = ref(false); // 等待服务器响应
            const imgServer = ref(''); // 图片服务器地址
            // ==================== 临时禁用动态端口检测，使用固定端口 ====================
            // const detectedImagePort = ref('9006'); // 缓存检测到的图片端口（动态检测）
            // const detectedVideoPort = ref('8006'); // 缓存检测到的视频端口（动态检测）
            const uploadedMedia = ref([]); // 已上传的媒体列表 [{url: 'xxx', type: 'image/video'}]
            const chatHistoryImages = ref([]); // 聊天历史图片列表（新增）
            const showUploadMenu = ref(false); // 显示上传菜单
            const showHistoryImageModal = ref(false); // 显示历史图片弹出框
            const historyImageLoading = ref(false); // 历史图片加载状态
            const showAllUploadImageModal = ref(false);  // 显示所有上传图片弹框
            const allUploadImages = ref([]);             // 所有上传的图片列表
            const allUploadLoading = ref(false);         // 加载状态
            const allUploadPage = ref(1);                // 当前页码
            const allUploadPageSize = ref(20);           // 每页数量
            const allUploadTotal = ref(0);               // 总数
            const allUploadTotalPages = ref(0);          // 总页数
            const allUploadScrollContainer = ref(null);  // 滚动容器引用
            const showMediaPreview = ref(false); // 显示媒体预览
            const previewMediaUrl = ref(''); // 预览媒体地址
            const previewMediaType = ref('image'); // 预览媒体类型
            const previewMediaCanUpload = ref(false); // 预览是否允许上传
            const previewUploadTarget = ref(null); // 预览上传目标
            const showEmojiPanel = ref(false); // 显示表情面板
            const showTopMenu = ref(false); // 顶部菜单显示状态
            const showSwitchIdentityDialog = ref(false); // 切换身份确认对话框
            const settingsMode = ref('identity'); // 设置模式: 'identity' | 'system'
            const showDisconnectAllDialog = ref(false); // 断开所有连接确认对话框
            const disconnectAllLoading = ref(false); // 断开连接加载状态
            const connectionStats = ref({ active: 0, upstream: 0, downstream: 0 }); // 连接统计
            const loadingMore = ref(false); // 加载更多历史消息中
            const firstTidMap = ref({}); // 存储每个聊天的最早消息Tid

            // 媒体管理相关状态
            const managementMode = ref(false); // 管理模式（true=可删除，false=只读）
            const selectionMode = ref(false); // 选择模式
            const selectedImages = ref([]); // 已选图片列表
            const deletingImages = ref(new Set()); // 删除中的图片集合
            const showMediaDeleteConfirm = ref(false); // 显示媒体删除确认对话框
            const deleteTargets = ref([]); // 待删除目标
            const deleting = ref(false); // 删除进行中

            // 数据源
            const historyUsers = ref([]); // 历史用户列表
            const favoriteUsers = ref([]); // 收藏用户列表
            const historyLoaded = ref(false); // 历史列表是否已加载
            const favoriteLoaded = ref(false); // 收藏列表是否已加载

            const chatHistory = ref({});

            // 计算属性：列表显示
            const displayList = computed(() => {
                if (activeTab.value === 'favorites') {
                    return favoriteUsers.value;
                }
                return historyUsers.value;
            });

            // 表情数据
            const emojiMap = {
                "[最右]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/c8/lxhzuiyou_thumb.gif",
                "[泪流满面]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/64/lxhtongku_thumb.gif",
                "[江南style]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/67/gangnamstyle_thumb.gif",
                "[偷乐]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/fa/lxhtouxiao_thumb.gif",
                "[加油啊]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/03/lxhjiayou_thumb.gif",
                "[doge]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/b6/doge_thumb.gif",
                "[喵喵]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/4a/mm_thumb.gif",
                "[笑cry]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/34/xiaoku_thumb.gif",
                "[xkl转圈]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/f4/xklzhuanquan_thumb.gif",
                "[微笑]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/5c/huanglianwx_thumb.gif",
                "[嘻嘻]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/0b/tootha_thumb.gif",
                "[哈哈]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6a/laugh.gif",
                "[可爱]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/14/tza_thumb.gif",
                "[可怜]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/af/kl_thumb.gif",
                "[挖鼻]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/0b/wabi_thumb.gif",
                "[吃惊]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/f4/cj_thumb.gif",
                "[害羞]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6e/shamea_thumb.gif",
                "[挤眼]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/c3/zy_thumb.gif",
                "[闭嘴]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/29/bz_thumb.gif",
                "[鄙视]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/71/bs2_thumb.gif",
                "[爱你]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6d/lovea_thumb.gif",
                "[泪]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/9d/sada_thumb.gif",
                "[偷笑]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/19/heia_thumb.gif",
                "[亲亲]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/8f/qq_thumb.gif",
                "[生病]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/b6/sb_thumb.gif",
                "[太开心]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/58/mb_thumb.gif",
                "[白眼]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d9/landeln_thumb.gif",
                "[右哼哼]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/98/yhh_thumb.gif",
                "[左哼哼]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6d/zhh_thumb.gif",
                "[嘘]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/a6/x_thumb.gif",
                "[衰]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/af/cry.gif",
                "[委屈]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/73/wq_thumb.gif",
                "[吐]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/9e/t_thumb.gif",
                "[哈欠]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/cc/haqianv2_thumb.gif",
                "[抱抱]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/27/bba_thumb.gif",
                "[怒]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/7c/angrya_thumb.gif",
                "[疑问]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/5c/yw_thumb.gif",
                "[馋嘴]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/a5/cza_thumb.gif",
                "[拜拜]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/70/88_thumb.gif",
                "[思考]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/e9/sk_thumb.gif",
                "[汗]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/24/sweata_thumb.gif",
                "[困]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/40/kunv2_thumb.gif",
                "[睡]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/96/huangliansj_thumb.gif",
                "[钱]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/90/money_thumb.gif",
                "[失望]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/0c/sw_thumb.gif",
                "[酷]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/40/cool_thumb.gif",
                "[色]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/20/huanglianse_thumb.gif",
                "[哼]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/49/hatea_thumb.gif",
                "[鼓掌]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/36/gza_thumb.gif",
                "[晕]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d9/dizzya_thumb.gif",
                "[悲伤]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/1a/bs_thumb.gif",
                "[抓狂]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/62/crazya_thumb.gif",
                "[黑线]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/91/h_thumb.gif",
                "[阴险]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6d/yx_thumb.gif",
                "[怒骂]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/60/numav2_thumb.gif",
                "[互粉]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/89/hufen_thumb.gif",
                "[心]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/40/hearta_thumb.gif",
                "[伤心]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/ea/unheart.gif",
                "[猪头]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/58/pig.gif",
                "[熊猫]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6e/panda_thumb.gif",
                "[兔子]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/81/rabbit_thumb.gif",
                "[ok]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d6/ok_thumb.gif",
                "[耶]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d9/ye_thumb.gif",
                "[good]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d8/good_thumb.gif",
                "[no]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/ae/buyao_org.gif",
                "[赞]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d0/z2_thumb.gif",
                "[来]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/40/come_thumb.gif",
                "[弱]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d8/sad_thumb.gif",
                "[草泥马]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/7a/shenshou_thumb.gif",
                "[神马]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/60/horse2_thumb.gif",
                "[囧]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/15/j_thumb.gif",
                "[浮云]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/bc/fuyun_thumb.gif",
                "[给力]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/1e/geiliv2_thumb.gif",
                "[围观]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/f2/wg_thumb.gif",
                "[威武]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/70/vw_thumb.gif",
                "[奥特曼]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/bc/otm_thumb.gif",
                "[礼物]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/c4/liwu_thumb.gif",
                "[钟]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d3/clock_thumb.gif",
                "[话筒]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/9f/huatongv2_thumb.gif",
                "[蜡烛]": "https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d9/lazhuv2_thumb.gif"
            };

            // --- 功能逻辑 ---

            // 获取颜色类（用于身份卡片）
            const getColorClass = (id) => {
                const colors = ['bg-color-1', 'bg-color-2', 'bg-color-3', 'bg-color-4', 'bg-color-5'];
                const hash = id.charCodeAt(0) + id.charCodeAt(1);
                return colors[hash % colors.length];
            };

            // ============== 登录认证相关方法 ==============
            // 带Token的fetch请求
            const fetchWithToken = (url, options = {}) => {
                const token = authToken.value || localStorage.getItem('authToken');

                if (token) {
                    options.headers = {
                        ...options.headers,
                        'Authorization': `Bearer ${token}`
                    };
                }

                return fetch(url, options);
            };

            // 处理登录
            const handleLogin = async () => {
                if (!loginAccessCode.value || loginLoading.value) return;

                loginLoading.value = true;

                try {
                    const response = await fetch(`${API_BASE}/auth/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `accessCode=${encodeURIComponent(loginAccessCode.value)}`
                    });

                    const result = await response.json();

                    if (result.code === 0) {
                        // 登录成功，保存Token
                        authToken.value = result.token;
                        localStorage.setItem('authToken', result.token);

                        console.log('登录成功，Token已保存');
                        showToast('登录成功');

                        // 隐藏登录页，显示身份选择页
                        showLoginPage.value = false;
                        showIdentityPicker.value = true;

                        // 加载身份列表
                        await loadIdentityList();
                    } else {
                        showToast(result.msg || '登录失败');
                    }
                } catch (error) {
                    console.error('登录失败:', error);
                    showToast('登录失败: ' + error.message);
                } finally {
                    loginLoading.value = false;
                }
            };

            // 检查Token有效性
            const checkToken = async () => {
                const savedToken = localStorage.getItem('authToken');

                if (!savedToken) {
                    console.log('没有保存的Token，显示登录页');
                    showLoginPage.value = true;
                    return false;
                }

                try {
                    const response = await fetch(`${API_BASE}/auth/verify`, {
                        headers: {
                            'Authorization': `Bearer ${savedToken}`
                        }
                    });

                    const result = await response.json();

                    if (result.code === 0 && result.valid) {
                        console.log('Token有效，跳过登录');
                        authToken.value = savedToken;
                        showLoginPage.value = false;
                        return true;
                    } else {
                        console.log('Token无效，显示登录页');
                        localStorage.removeItem('authToken');
                        showLoginPage.value = true;
                        return false;
                    }
                } catch (error) {
                    console.error('Token验证失败:', error);
                    showLoginPage.value = true;
                    return false;
                }
            };

            // 退出登录
            const handleLogout = () => {
                localStorage.removeItem('authToken');
                authToken.value = '';
                showLoginPage.value = true;
                showIdentityPicker.value = false;

                // 断开WebSocket
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.close();
                }

                showToast('已退出登录');
            };

            // 加载身份列表
            const loadIdentityList = async () => {
                identityLoading.value = true;
                try {
                    const response = await fetchWithToken(`${API_BASE}/getIdentityList`);
                    const result = await response.json();
                    if (result.code === 0) {
                        identityList.value = result.data || [];
                        console.log('加载身份列表成功:', identityList.value.length, '个身份');
                    } else {
                        console.error('加载身份列表失败:', result.msg);
                    }
                } catch (error) {
                    console.error('加载身份列表出错:', error);
                } finally {
                    identityLoading.value = false;
                }
            };

            // 选择身份
            const selectIdentity = async (identity) => {
                console.log('选择身份:', identity);

                // 更新当前用户信息
                currentUser.value.id = identity.id;
                currentUser.value.name = identity.name;
                currentUser.value.sex = identity.sex;

                // 通知后端更新使用时间
                try {
                    await fetchWithToken(`${API_BASE}/selectIdentity?id=${identity.id}`, { method: 'POST' });
                } catch (error) {
                    console.error('更新身份使用时间失败:', error);
                }

                // 隐藏身份选择页，进入主页面
                showIdentityPicker.value = false;

                // 连接WebSocket
                connectWebSocket();

                // 自动加载历史用户列表
                loadHistoryUsers();
            };

            // 打开身份信息设置
            const openIdentitySettings = () => {
                showTopMenu.value = false;
                settingsMode.value = 'identity';
                showSettings.value = true;
            };

            // 打开系统设置
            const openSystemSettings = () => {
                showTopMenu.value = false;
                settingsMode.value = 'system';
                showSettings.value = true;
                // 加载连接统计
                loadConnectionStats();
            };

            // 加载连接统计
            const loadConnectionStats = async () => {
                try {
                    const response = await fetchWithToken(`${API_BASE}/getConnectionStats`);
                    const data = await response.json();
                    if (data.code === 0) {
                        connectionStats.value = data.data;
                        console.log('连接统计:', data.data);
                    }
                } catch (error) {
                    console.error('加载连接统计失败:', error);
                }
            };

            // 显示断开确认对话框
            const confirmDisconnectAll = () => {
                showDisconnectAllDialog.value = true;
            };

            // 执行断开所有连接
            const executeDisconnectAll = async () => {
                disconnectAllLoading.value = true;
                showDisconnectAllDialog.value = false;

                try {
                    const response = await fetchWithToken(`${API_BASE}/disconnectAllConnections`, {
                        method: 'POST'
                    });

                    const data = await response.json();
                    if (data.code === 0) {
                        showToast('所有连接已断开');
                        // 刷新统计
                        await loadConnectionStats();
                    } else {
                        showToast('操作失败: ' + data.msg);
                    }
                } catch (error) {
                    console.error('断开连接失败:', error);
                    showToast('操作失败，请重试');
                } finally {
                    disconnectAllLoading.value = false;
                }
            };

            // 显示切换身份确认对话框
            const showSwitchIdentityConfirm = () => {
                showTopMenu.value = false;

                if (currentChatUser.value) {
                    // 正在聊天，显示确认对话框
                    showSwitchIdentityDialog.value = true;
                } else {
                    // 没在聊天，直接切换
                    confirmSwitchIdentity();
                }
            };

            // 确认切换身份（核心逻辑）
            const confirmSwitchIdentity = () => {
                console.log('用户确认切换身份');

                // 1. 设置手动关闭标志并断开 WebSocket
                if (ws) {
                    console.log('断开 WebSocket 连接');
                    manualClose = true;
                    ws.close();
                    ws = null;
                }

                // 2. 清空所有状态
                currentChatUser.value = null;
                chatHistory.value = {};
                historyUsers.value = [];
                favoriteUsers.value = [];
                uploadedMedia.value = [];
                chatHistoryImages.value = [];

                // 3. 重置加载标志
                historyLoaded.value = false;
                favoriteLoaded.value = false;
                firstTidMap.value = {};

                // 4. 清空输入框和面板状态
                inputText.value = '';
                showUploadMenu.value = false;
                showEmojiPanel.value = false;
                isMatching.value = false;
                isTyping.value = false;

                // 5. 返回身份选择页
                showIdentityPicker.value = true;
                showSwitchIdentityDialog.value = false;

                // 6. 重新加载身份列表
                loadIdentityList();

                console.log('已切换到身份选择页');
            };

            // 取消切换身份
            const cancelSwitchIdentity = () => {
                showSwitchIdentityDialog.value = false;
            };

            // 创建新身份
            const createIdentity = async () => {
                if (!newIdentity.value.name || !newIdentity.value.sex) {
                    showToast('请填写完整信息');
                    return;
                }

                try {
                    const params = new URLSearchParams();
                    params.append('name', newIdentity.value.name);
                    params.append('sex', newIdentity.value.sex);

                    const response = await fetchWithToken(`${API_BASE}/createIdentity`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: params
                    });

                    const result = await response.json();
                    if (result.code === 0) {
                        console.log('创建身份成功:', result.data);
                        showCreateForm.value = false;
                        newIdentity.value = { name: '', sex: '' };

                        // 选择刚创建的身份
                        selectIdentity(result.data);
                    } else {
                        showToast(result.msg || '创建失败');
                    }
                } catch (error) {
                    console.error('创建身份出错:', error);
                    showToast('创建失败，请重试');
                }
            };

            // 快速创建随机身份
            const quickCreateIdentity = async () => {
                identityLoading.value = true;
                try {
                    const response = await fetchWithToken(`${API_BASE}/quickCreateIdentity`, { method: 'POST' });
                    const result = await response.json();

                    if (result.code === 0) {
                        console.log('快速创建身份成功:', result.data);
                        // 选择刚创建的身份
                        selectIdentity(result.data);
                    } else {
                        showToast(result.msg || '创建失败');
                    }
                } catch (error) {
                    console.error('快速创建身份出错:', error);
                    showToast('创建失败，请重试');
                } finally {
                    identityLoading.value = false;
                }
            };

            // 显示删除确认对话框
            const showDeleteConfirm = (identity) => {
                console.log('准备删除身份:', identity);
                deleteConfirmIdentity.value = identity;
            };

            // 确认删除身份
            const confirmDeleteIdentity = async () => {
                const identity = deleteConfirmIdentity.value;
                if (!identity) return;

                try {
                    const params = new URLSearchParams();
                    params.append('id', identity.id);

                    const response = await fetchWithToken(`${API_BASE}/deleteIdentity`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: params
                    });

                    const result = await response.json();
                    console.log('删除身份响应:', result);

                    if (result.code === 0) {
                        // 从列表中移除
                        identityList.value = identityList.value.filter(item => item.id !== identity.id);
                        deleteConfirmIdentity.value = null;
                        showToast('已删除');
                    } else {
                        alert('删除失败: ' + (result.msg || '未知错误'));
                    }
                } catch (error) {
                    console.error('删除身份出错:', error);
                    alert('删除失败，请重试');
                }
            };

            // 0. 上报访问记录
            const reportReferrer = async () => {
                try {
                    console.log('上报访问记录...');

                    const referrerUrl = document.referrer || '';
                    const currUrl = encodeURIComponent('http://v1.chat2019.cn/randomdeskrynewjc46ko.html?v=jc46ko');
                    const userid = currentUser.value.id;
                    const cookieData = generateCookie(userid, currentUser.value.name);
                    const referer = 'http://v1.chat2019.cn/randomdeskrynewjc46ko.html?v=jc46ko';
                    const userAgent = navigator.userAgent;

                    const params = new URLSearchParams();
                    params.append('referrerUrl', referrerUrl);
                    params.append('currUrl', currUrl);
                    params.append('userid', userid);
                    params.append('cookieData', cookieData);
                    params.append('referer', referer);
                    params.append('userAgent', userAgent);

                    const response = await fetchWithToken(`${API_BASE}/reportReferrer`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: params
                    });

                    const result = await response.text();
                    console.log('上报成功:', result);

                    // 上报完成后获取图片服务器地址
                    await getImgServer();

                    return true;

                } catch (error) {
                    console.error('上报访问记录失败:', error);
                    return false;
                }
            };

            // 获取图片服务器地址
            const getImgServer = async () => {
                try {
                    console.log('获取图片服务器地址...');

                    const response = await fetchWithToken(`${API_BASE}/getImgServer`);

                    if (!response.ok) {
                        console.warn('图片服务器接口返回错误:', response.status);
                        return;
                    }

                    const data = await response.json();
                    console.log('图片服务器数据:', data);

                    // 解析并保存图片服务器地址
                    if (data.state === 'OK' && data.msg && data.msg.server) {
                        imgServer.value = data.msg.server;
                        console.log('图片服务器地址:', imgServer.value);

                        // 通知后端更新图片服务器地址
                        const params = new URLSearchParams();
                        params.append('server', imgServer.value);

                        await fetchWithToken(`${API_BASE}/updateImgServer`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: params
                        });

                        console.log('已通知后端更新图片服务器地址');

                        // 获取缓存的图片列表
                        await loadCachedImages();
                    }

                } catch (error) {
                    console.error('获取图片服务器地址失败:', error);
                }
            };

            // 加载缓存的图片列表（根据聊天对象智能加载）
            const loadCachedImages = async () => {
                try {
                    console.log('加载图片列表...');

                    // 1. 始终加载已上传缓存（3小时内上传的）
                    const cacheResponse = await fetchWithToken(`${API_BASE}/getCachedImages?userid=${currentUser.value.id}`);
                    if (cacheResponse.ok) {
                        const cacheResult = await cacheResponse.json();

                        // ==================== 临时使用固定端口 ====================
                        // const serverPort = cacheResult.port || '9006';
                        const serverPort = '9006';  // 临时使用固定端口
                        const cacheData = cacheResult.data || cacheResult;  // 兼容旧格式

                        console.log('使用固定端口:', serverPort);

                        // 临时禁用动态端口缓存
                        // if (cacheResult.port) {
                        //     detectedImagePort.value = cacheResult.port;
                        //     console.log('更新全局图片端口缓存:', detectedImagePort.value);
                        // }

                        if (Array.isArray(cacheData)) {
                            uploadedMedia.value = cacheData
                                .filter(url => url && typeof url === 'string')  // 过滤掉 null/undefined
                                .map(url => {
                                    // 将本地URL转换为上游URL
                                    let displayUrl = url;
                                    const fileType = url.toLowerCase().endsWith('.mp4') ? 'video' : 'image';

                                    // 从本地URL提取路径：/upload/images/2025/12/19/xxx.jpg
                                    const localPattern = /\/upload\/(.+)$/;
                                    const match = url.match(localPattern);

                                    if (match && imgServer.value) {
                                        // 提取到相对路径：images/2025/12/19/xxx.jpg
                                        const relativePath = match[1];
                                        // 移除 images/ 前缀，得到：2025/12/19/xxx.jpg
                                        const uploadPath = relativePath.replace(/^images\//, '');
                                        // ==================== 临时使用固定端口（根据文件类型） ====================
                                        const fixedPort = fileType === 'video' ? '8006' : '9006';
                                        displayUrl = `http://${imgServer.value}:${fixedPort}/img/Upload/${uploadPath}`;
                                        console.log('URL转换:', url, '→', displayUrl, '端口:', fixedPort, '(固定)');
                                    }

                                    return {
                                        url: displayUrl,
                                        type: fileType
                                    };
                                });
                            console.log('加载了', uploadedMedia.value.length, '个已上传文件');
                        } else {
                            uploadedMedia.value = [];  // 确保始终是数组
                        }
                    } else {
                        uploadedMedia.value = [];  // 请求失败时也设为空数组
                    }

                    // 不再自动加载聊天历史图片，改为点击按钮时加载
                    chatHistoryImages.value = [];

                } catch (error) {
                    console.error('加载图片失败:', error);
                    // 确保出错时也设置为空数组，避免 undefined
                    uploadedMedia.value = uploadedMedia.value || [];
                    chatHistoryImages.value = chatHistoryImages.value || [];
                }
            };

            // 1. 数据加载逻辑
            const loadHistoryUsers = async () => {
                if (historyLoaded.value) {
                    console.log('历史用户列表已加载，跳过');
                    return;
                }

                try {
                    console.log('加载历史用户列表...');

                    // 准备参数
                    const userid = currentUser.value.id;
                    const cookieData = generateCookie(userid, currentUser.value.name);
                    const referer = 'http://v1.chat2019.cn/randomdeskrynewjc46ko.html?v=jc46ko';
                    const userAgent = navigator.userAgent;

                    const params = new URLSearchParams();
                    params.append('myUserID', userid);
                    params.append('vipcode', '');
                    params.append('serverPort', '1001');
                    params.append('cookieData', cookieData);
                    params.append('referer', referer);
                    params.append('userAgent', userAgent);

                    const response = await fetchWithToken(`${API_BASE}/getHistoryUserList`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: params
                    });

                    if (!response.ok) {
                        console.warn('历史用户列表接口返回错误:', response.status);
                        historyUsers.value = [];
                        historyLoaded.value = true;
                        return;
                    }

                    const data = await response.json();
                    console.log('历史用户数据:', data);

                    // 检查是否有错误
                    if (data.error) {
                        console.warn('历史用户列表加载失败:', data.error);
                        historyUsers.value = [];
                        historyLoaded.value = true;
                        return;
                    }

                    // 转换数据格式，并过滤掉自己
                    historyUsers.value = data
                        .filter(user => user.id !== currentUser.value.id)  // 过滤掉自己
                        .map(user => ({
                            id: user.id,
                            name: user.nickname,
                            lastMsg: '暂无消息',
                            lastTime: '刚刚',
                            isFavorite: false,
                            colorClass: getRandomColor(),
                            sex: user.sex || user.userSex || '未知',
                            age: user.age || user.userAge || '0',
                            address: user.address || user.userAddress || '未知',
                            unreadCount: 0  // 未读消息数
                        }));

                    historyLoaded.value = true;
                    console.log('历史用户列表加载完成（已过滤自己）:', historyUsers.value.length);
                } catch (error) {
                    console.error('加载历史用户失败:', error);
                    historyUsers.value = [];
                    historyLoaded.value = true;
                }
            };

            const loadFavoriteUsers = async () => {
                if (favoriteLoaded.value) {
                    console.log('收藏用户列表已加载，跳过');
                    return;
                }

                try {
                    console.log('加载收藏用户列表...');

                    // 准备参数
                    const userid = currentUser.value.id;
                    const cookieData = generateCookie(userid, currentUser.value.name);
                    const referer = 'http://v1.chat2019.cn/randomdeskrynewjc46ko.html?v=jc46ko';
                    const userAgent = navigator.userAgent;

                    const params = new URLSearchParams();
                    params.append('myUserID', userid);
                    params.append('vipcode', '');
                    params.append('serverPort', '1001');
                    params.append('cookieData', cookieData);
                    params.append('referer', referer);
                    params.append('userAgent', userAgent);

                    const response = await fetchWithToken(`${API_BASE}/getFavoriteUserList`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: params
                    });

                    if (!response.ok) {
                        console.warn('收藏用户列表接口返回错误:', response.status);
                        favoriteUsers.value = [];
                        favoriteLoaded.value = true;
                        return;
                    }

                    const data = await response.json();
                    console.log('收藏用户数据:', data);

                    // 检查是否有错误
                    if (data.error) {
                        console.warn('收藏用户列表加载失败:', data.error);
                        favoriteUsers.value = [];
                        favoriteLoaded.value = true;
                        return;
                    }

                    // 转换数据格式，并过滤掉自己
                    favoriteUsers.value = data
                        .filter(user => user.id !== currentUser.value.id)  // 过滤掉自己
                        .map(user => ({
                            id: user.id,
                            name: user.nickname,
                            lastMsg: '暂无消息',
                            lastTime: '刚刚',
                            isFavorite: true,
                            colorClass: getRandomColor(),
                            sex: user.sex || user.userSex || '未知',
                            age: user.age || user.userAge || '0',
                            address: user.address || user.userAddress || '未知',
                            unreadCount: 0  // 未读消息数
                        }));

                    favoriteLoaded.value = true;
                    console.log('收藏用户列表加载完成（已过滤自己）:', favoriteUsers.value.length);
                } catch (error) {
                    console.error('加载收藏用户失败:', error);
                    favoriteUsers.value = [];
                    favoriteLoaded.value = true;
                }
            };

            // 切换 Tab 时加载对应数据
            const switchTab = (tab) => {
                console.log('切换到 Tab:', tab);

                // 如果点击的是当前Tab，强制刷新
                if (activeTab.value === tab) {
                    console.log('点击当前Tab，强制刷新');
                    if (tab === 'history') {
                        historyLoaded.value = false;
                        loadHistoryUsers();
                    } else if (tab === 'favorites') {
                        favoriteLoaded.value = false;
                        loadFavoriteUsers();
                    }
                } else {
                    // 切换到不同Tab，不强制刷新（首次会自动加载）
                    console.log('切换到不同Tab');
                    activeTab.value = tab;
                    if (tab === 'history') {
                        loadHistoryUsers(); // 内部检查 historyLoaded
                    } else if (tab === 'favorites') {
                        loadFavoriteUsers(); // 内部检查 favoriteLoaded
                    }
                }
            };

            // 强制刷新列表
            const refreshCurrentList = () => {
                if (activeTab.value === 'history') {
                    historyLoaded.value = false;
                    loadHistoryUsers();
                } else if (activeTab.value === 'favorites') {
                    favoriteLoaded.value = false;
                    loadFavoriteUsers();
                }
            };

            // 加载消息历史
            const loadMessageHistory = async (userToID) => {
                console.log('=== 开始加载消息历史 ===');
                console.log('userToID=', userToID);
                console.log('myUserID=', currentUser.value.id);

                try {
                    // 准备参数
                    const myUserID = currentUser.value.id;
                    const cookieData = generateCookie(myUserID, currentUser.value.name);
                    const referer = 'http://v1.chat2019.cn/randomdeskrynewjc46ko.html?v=jc46ko';
                    const userAgent = navigator.userAgent;

                    const params = new URLSearchParams();
                    params.append('myUserID', myUserID);
                    params.append('UserToID', userToID);
                    params.append('isFirst', '1');
                    params.append('firstTid', '0');
                    params.append('vipcode', '');
                    params.append('serverPort', '1001');
                    params.append('cookieData', cookieData);
                    params.append('referer', referer);
                    params.append('userAgent', userAgent);

                    console.log('发送请求到 /api/getMessageHistory');

                    const response = await fetchWithToken(`${API_BASE}/getMessageHistory`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: params
                    });

                    console.log('接口响应状态:', response.status);

                    if (!response.ok) {
                        console.warn('消息历史接口返回错误:', response.status);
                        // 初始化为空数组
                        if (!chatHistory.value[userToID]) {
                            chatHistory.value[userToID] = [];
                        }
                        return;
                    }

                    const data = await response.json();
                    console.log('消息历史数据:', data);

                    // 检查是否有错误
                    if (data.error) {
                        console.warn('消息历史加载失败:', data.error);
                        if (!chatHistory.value[userToID]) {
                            chatHistory.value[userToID] = [];
                        }
                        return;
                    }

                    // 解析消息历史数据
                    if (data.code === 0 && data.contents_list && Array.isArray(data.contents_list)) {
                        // 转换消息格式，contents_list 是倒序的（最新在前），需要反转
                        const messages = data.contents_list.reverse().map(msg => {
                            // 判断逻辑：如果发送者不是对方，就是我发送的
                            const isSelf = msg.id !== userToID;
                            console.log('消息:', msg.content, '| msg.id=', msg.id, '| userToID=', userToID, '| isSelf=', isSelf);

                            // 检查是否是图片消息（格式：[path/to/image.jpg]）
                            let content = msg.content;
                            let type = 'text';

                            // 检查是否是图片消息
                            if (content.startsWith('[') && content.endsWith(']') &&
                                (content.includes('.jpg') || content.includes('.png') || content.includes('.jpeg') || content.includes('.gif'))) {
                                // 提取图片路径
                                const imagePath = content.substring(1, content.length - 1);
                                // ==================== 临时使用固定端口9006 ====================
                                content = `http://${imgServer.value}:9006/img/Upload/${imagePath}`;
                                type = 'image';
                                console.log('图片消息，拼接URL:', content, '(固定端口9006)');
                            }
                            // 检查是否是视频消息
                            else if (content.startsWith('[') && content.endsWith(']') && content.includes('.mp4')) {
                                // 提取视频路径
                                const videoPath = content.substring(1, content.length - 1);
                                // ==================== 临时使用固定端口8006 ====================
                                content = `http://${imgServer.value}:8006/img/Upload/${videoPath}`;
                                type = 'video';
                                console.log('视频消息，拼接URL:', content, '(固定端口8006)');
                            }

                            return {
                                type: type,
                                content: content,
                                isSelf: isSelf,
                                time: msg.time,
                                nickname: msg.nickname,
                                tid: msg.Tid
                            };
                        });

                        chatHistory.value[userToID] = messages;
                        // 保存最早消息的 Tid 用于加载更多
                        if (messages.length > 0) {
                            firstTidMap.value[userToID] = messages[0].tid;
                        }
                        console.log('消息历史加载完成:', messages.length, '条消息, firstTid=', firstTidMap.value[userToID]);
                    } else {
                        // 如果没有历史消息或返回格式不对，初始化为空数组
                        if (!chatHistory.value[userToID]) {
                            chatHistory.value[userToID] = [];
                        }
                        console.log('没有历史消息');
                    }

                } catch (error) {
                    console.error('加载消息历史失败:', error);
                    // 初始化为空数组
                    if (!chatHistory.value[userToID]) {
                        chatHistory.value[userToID] = [];
                    }
                }
            };

            // 加载更多历史消息
            const loadMoreHistory = async () => {
                if (!currentChatUser.value || loadingMore.value) return;

                const userToID = currentChatUser.value.id;
                const firstTid = firstTidMap.value[userToID] || '0';

                console.log('=== 加载更多历史消息 ===');
                console.log('userToID=', userToID, 'firstTid=', firstTid);

                loadingMore.value = true;

                try {
                    const myUserID = currentUser.value.id;
                    const cookieData = generateCookie(myUserID, currentUser.value.name);
                    const referer = 'http://v1.chat2019.cn/randomdeskrynewjc46ko.html?v=jc46ko';
                    const userAgent = navigator.userAgent;

                    const params = new URLSearchParams();
                    params.append('myUserID', myUserID);
                    params.append('UserToID', userToID);
                    params.append('isFirst', '0');
                    params.append('firstTid', firstTid);
                    params.append('vipcode', '');
                    params.append('serverPort', '1001');
                    params.append('cookieData', cookieData);
                    params.append('referer', referer);
                    params.append('userAgent', userAgent);

                    const response = await fetchWithToken(`${API_BASE}/getMessageHistory`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: params
                    });

                    if (!response.ok) {
                        console.warn('加载更多历史消息失败:', response.status);
                        loadingMore.value = false;
                        return;
                    }

                    const data = await response.json();
                    console.log('更多历史消息数据:', data);

                    if (data.code === 0 && data.contents_list && Array.isArray(data.contents_list) && data.contents_list.length > 0) {
                        const newMessages = data.contents_list.reverse().map(msg => {
                            const isSelf = msg.id !== userToID;
                            let content = msg.content;
                            let type = 'text';

                            // 检查是否是图片消息
                            if (content.startsWith('[') && content.endsWith(']') &&
                                (content.includes('.jpg') || content.includes('.png') || content.includes('.jpeg') || content.includes('.gif'))) {
                                const imagePath = content.substring(1, content.length - 1);
                                // ==================== 临时使用固定端口9006 ====================
                                content = `http://${imgServer.value}:9006/img/Upload/${imagePath}`;
                                type = 'image';
                            }
                            // 检查是否是视频消息
                            else if (content.startsWith('[') && content.endsWith(']') && content.includes('.mp4')) {
                                const videoPath = content.substring(1, content.length - 1);
                                // ==================== 临时使用固定端口8006 ====================
                                content = `http://${imgServer.value}:8006/img/Upload/${videoPath}`;
                                type = 'video';
                            }

                            return { type, content, isSelf, time: msg.time, nickname: msg.nickname, tid: msg.Tid };
                        });

                        // 将新消息插入到现有消息的前面
                        chatHistory.value[userToID] = [...newMessages, ...chatHistory.value[userToID]];

                        // 更新最早消息的 Tid
                        if (newMessages.length > 0) {
                            firstTidMap.value[userToID] = newMessages[0].tid;
                        }

                        console.log('加载更多完成:', newMessages.length, '条消息');
                        showToast(`加载了 ${newMessages.length} 条历史消息`);
                    } else {
                        showToast('没有更多历史消息了');
                    }

                } catch (error) {
                    console.error('加载更多历史消息失败:', error);
                    showToast('加载失败');
                } finally {
                    loadingMore.value = false;
                }
            };

            // 2. 匹配逻辑
            const startMatch = () => {
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    alert('WebSocket 未连接，无法匹配');
                    return;
                }

                isMatching.value = true;

                // 发送随机匹配消息
                const randomMessage = {
                    "act": "random",
                    "id": currentUser.value.id,
                    "userAge": "0"
                };

                ws.send(JSON.stringify(randomMessage));
                console.log('发送随机匹配消息:', randomMessage);
            };

            const cancelMatch = () => {
                isMatching.value = false;

                // 发送取消匹配消息
                if (ws && ws.readyState === WebSocket.OPEN) {
                    const cancelMessage = {
                        "act": "randomOut",
                        "id": currentUser.value.id,
                        "msg": generateRandomId()  // 使用随机32位ID
                    };
                    ws.send(JSON.stringify(cancelMessage));
                    console.log('发送取消匹配消息:', cancelMessage);
                }
            };

            // 2. 聊天室逻辑
            const enterChat = async (user, loadHistory = true) => {
                console.log('进入聊天界面, user=', user, 'loadHistory=', loadHistory);

                // 保存当前列表的滚动位置
                if (listArea.value) {
                    savedScrollPosition.value = listArea.value.scrollTop;
                    console.log('保存滚动位置:', savedScrollPosition.value);
                }

                // 清零未读消息数
                if (user.unreadCount && user.unreadCount > 0) {
                    console.log('清零未读消息数:', user.unreadCount, '→ 0');
                    user.unreadCount = 0;
                }

                currentChatUser.value = user;
                isTyping.value = false; // 清除正在输入状态

                // 加载该用户的聊天图片历史
                await loadCachedImages();

                // 根据参数决定是否加载历史消息
                if (loadHistory) {
                    console.log('加载消息历史, user.id=', user.id);
                    await loadMessageHistory(user.id);
                }

                // 直接滚动到最新消息
                scrollToBottom();
            };

            const exitChat = () => {
                currentChatUser.value = null;
                isTyping.value = false; // 清除正在输入状态

                // 恢复列表的滚动位置
                nextTick(() => {
                    if (listArea.value && savedScrollPosition.value > 0) {
                        listArea.value.scrollTop = savedScrollPosition.value;
                        console.log('恢复滚动位置:', savedScrollPosition.value);
                    }
                });
            };

            const toggleFavorite = async (user) => {
                try {
                    const myUserID = currentUser.value.id;
                    const cookieData = generateCookie(myUserID, currentUser.value.name);
                    const referer = 'http://v1.chat2019.cn/randomdeskrynewjc46ko.html?v=jc46ko';
                    const userAgent = navigator.userAgent;

                    const params = new URLSearchParams();
                    params.append('myUserID', myUserID);
                    params.append('UserToID', user.id);
                    params.append('vipcode', '');
                    params.append('serverPort', '1001');
                    params.append('cookieData', cookieData);
                    params.append('referer', referer);
                    params.append('userAgent', userAgent);

                    // 根据当前收藏状态选择接口
                    const apiUrl = user.isFavorite ? `${API_BASE}/cancelFavorite` : `${API_BASE}/toggleFavorite`;
                    console.log('调用接口:', apiUrl, 'isFavorite=', user.isFavorite);

                    const response = await fetchWithToken(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: params
                    });

                    const data = await response.json();
                    console.log('收藏操作结果:', data);

                    if (data.code === '0' || data.status === 'true') {
                        user.isFavorite = !user.isFavorite;
                        showToast(user.isFavorite ? '收藏成功' : '取消收藏成功');
                    } else {
                        showToast('操作失败: ' + (data.msg || '未知错误'));
                    }
                } catch (error) {
                    console.error('收藏操作失败:', error);
                    showToast('操作失败');
                }
            };

            // 3. 发送消息逻辑
            const sendMessage = () => {
                if (!inputText.value.trim()) return;

                const message = inputText.value;

                // 通过 WebSocket 发送消息
                if (ws && ws.readyState === WebSocket.OPEN) {
                    // 构造发送消息格式
                    const toUserMessage = {
                        "act": `touser_${currentChatUser.value.id}_${currentChatUser.value.name}`,
                        "id": currentUser.value.id,
                        "msg": message
                    };

                    ws.send(JSON.stringify(toUserMessage));
                    console.log('发送消息，等待服务器回显:', toUserMessage);
                } else {
                    console.error('WebSocket 未连接');
                    alert('连接已断开，请刷新页面重试');
                    return;
                }

                // 清空输入框
                inputText.value = '';
            };

            // 4. 文件发送逻辑
            const selectFile = async () => {
                console.log('切换上传菜单');
                showUploadMenu.value = !showUploadMenu.value;
                // 关闭表情面板
                if (showUploadMenu.value) {
                    showEmojiPanel.value = false;
                    // 打开上传菜单时，刷新图片列表
                    await loadCachedImages();
                }
            };

            const triggerFileSelect = () => {
                console.log('选择上传文件');
                fileInput.value.click();
            };

            // 切换表情面板
            const toggleEmojiPanel = () => {
                console.log('切换表情面板');
                showEmojiPanel.value = !showEmojiPanel.value;
                // 关闭上传菜单
                if (showEmojiPanel.value) {
                    showUploadMenu.value = false;
                }
            };

            // 插入表情到输入框
            const insertEmoji = (emojiName) => {
                console.log('插入表情:', emojiName);
                inputText.value += emojiName;
                showEmojiPanel.value = false;
            };

            // 关闭所有面板
            const closeAllPanels = () => {
                showUploadMenu.value = false;
                showEmojiPanel.value = false;
            };

            // 解析文本中的表情为HTML
            const parseEmoji = (text) => {
                if (!text) return '';
                let result = text;
                // 替换所有[表情名]为<img>标签
                for (const [name, url] of Object.entries(emojiMap)) {
                    const regex = new RegExp(name.replace(/[[\]]/g, '\\$&'), 'g');
                    result = result.replace(regex, `<img src="${url}" class="inline-block w-6 h-6" alt="${name}">`);
                }
                return result;
            };

            const handleFileUpload = async (e) => {
                console.log('handleFileUpload 被调用');
                const file = e.target.files[0];
                if (!file) {
                    console.log('没有选择文件');
                    return;
                }

                console.log('选择文件:', file.name, file.type, file.size);

                // 关闭上传菜单
                showUploadMenu.value = false;

                // 判断文件类型并上传
                if (file.type.startsWith('image/')) {
                    // 图片文件 - 上传到服务器
                    await uploadImage(file, 'image');
                } else if (file.type.startsWith('video/')) {
                    // 视频文件 - 上传到服务器
                    await uploadImage(file, 'video');
                } else {
                    // 其他文件类型 - 作为图片上传尝试
                    await uploadImage(file, 'image');
                }

                e.target.value = ''; // 重置 input
            };

            // 上传图片/视频
            const uploadImage = async (file, fileType = 'image') => {
                try {
                    console.log('=== 开始上传文件 ===');
                    console.log('文件名:', file.name);
                    console.log('文件大小:', file.size);
                    console.log('文件类型:', fileType);
                    console.log('图片服务器地址:', imgServer.value);

                    if (!imgServer.value) {
                        alert('图片服务器地址未获取，请刷新页面重试');
                        return;
                    }

                    // 构造 FormData
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('userid', currentUser.value.id);

                    // 添加 headers 参数
                    const cookieData = generateCookie(currentUser.value.id, currentUser.value.name);
                    const referer = 'http://v1.chat2019.cn/randomdeskrynewjc46ko.html?v=jc46ko';
                    const userAgent = navigator.userAgent;

                    formData.append('cookieData', cookieData);
                    formData.append('referer', referer);
                    formData.append('userAgent', userAgent);

                    console.log('发送上传请求...');

                    // 调用后端上传接口
                    const response = await fetchWithToken(`${API_BASE}/uploadMedia`, {
                        method: 'POST',
                        body: formData
                    });

                    console.log('上传响应状态:', response.status);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('文件上传失败:', response.status, errorText);
                        alert('文件上传失败: ' + errorText);
                        return;
                    }

                    const data = await response.json();
                    console.log('文件上传返回:', data);

                    // 检查上传结果
                    if (data.state === 'OK' && data.msg) {
                        // ==================== 临时使用固定端口 ====================
                        const port = fileType === 'video' ? '8006' : '9006';
                        const mediaUrl = `http://${imgServer.value}:${port}/img/Upload/${data.msg}`;
                        console.log('文件服务器URL:', mediaUrl, '端口:', port, '(固定端口)');

                        // ==================== 临时禁用端口缓存 ====================
                        // if (data.port) {
                        //     if (fileType === 'video') {
                        //         detectedVideoPort.value = data.port;
                        //         console.log('更新全局视频端口缓存:', detectedVideoPort.value);
                        //     } else {
                        //         detectedImagePort.value = data.port;
                        //         console.log('更新全局图片端口缓存:', detectedImagePort.value);
                        //     }
                        // }

                        // 添加到已上传媒体列表开头（最新在前）
                        uploadedMedia.value.unshift({ url: mediaUrl, type: fileType });
                        console.log('已保存到上传历史，当前共', uploadedMedia.value.length, '个文件');

                        // 显示上传成功提示
                        const fileTypeName = fileType === 'image' ? '图片' : fileType === 'video' ? '视频' : '文件';
                        showToast(`${fileTypeName}上传成功`);

                    } else {
                        showToast('文件上传失败: ' + (data.error || '未知错误'));
                    }

                } catch (error) {
                    console.error('上传文件异常:', error);
                    showToast('文件上传异常: ' + error.message);
                }
            };

            // 辅助函数
            const pushMessage = (type, content, isSelf, time = null, nickname = null) => {
                const uid = currentChatUser.value.id;
                if (!chatHistory.value[uid]) chatHistory.value[uid] = [];
                // 如果没有传入时间，使用当前时间
                const msgTime = time || new Date().toISOString().replace('T', ' ').substring(0, 23);
                chatHistory.value[uid].push({ type, content, isSelf, time: msgTime, nickname });
                scrollToBottom();
            };

            const scrollToBottom = () => {
                nextTick(() => {
                    if (chatBox.value) {
                        chatBox.value.scrollTop = chatBox.value.scrollHeight;
                    }
                });
            };

            // 格式化时间显示
            const formatTime = (timeStr) => {
                if (!timeStr) return '';
                // 格式: 2025-12-18 03:02:11.721 → 2025-12-18 03:02:11
                const match = timeStr.match(/(\d{4}-\d{2}-\d{2})\s+(\d{2}:\d{2}:\d{2})/);
                return match ? `${match[1]} ${match[2]}` : timeStr;
            };

            const autoResize = (e) => {
                // 简单的输入框高度自适应
                e.target.style.height = 'auto';
                e.target.style.height = (e.target.scrollHeight) + 'px';
            };

            const openMediaPreview = (media, canUpload = false) => {
                if (!media) return;
                const url = typeof media === 'string' ? media : media.url;
                if (!url) return;

                previewMediaUrl.value = url;
                previewMediaType.value = typeof media === 'string' ? 'image' : (media.type || 'image');
                previewMediaCanUpload.value = canUpload;
                previewUploadTarget.value = canUpload ? media : null;
                showMediaPreview.value = true;
            };

            const previewMedia = (src) => {
                openMediaPreview(src, false);
            };

            const previewUploadMedia = (media) => {
                openMediaPreview(media, true);
            };

            const closeMediaPreview = () => {
                showMediaPreview.value = false;
                previewMediaUrl.value = '';
                previewMediaType.value = 'image';
                previewMediaCanUpload.value = false;
                previewUploadTarget.value = null;
            };

            const confirmPreviewUpload = async () => {
                if (!previewUploadTarget.value) return;
                const target = previewUploadTarget.value;
                closeMediaPreview();
                await reuploadHistoryImageFromModal(target);
            };

            // 发送已上传的图片/视频
            const sendMediaMessage = (media) => {
                console.log('发送已上传的媒体:', media);

                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    alert('WebSocket 未连接，无法发送');
                    return;
                }

                if (!currentChatUser.value) {
                    alert('请先选择聊天对象');
                    return;
                }

                // 从完整URL中提取文件路径
                // 例如：http://149.88.79.98:9006/img/Upload/2025/12/18/Random/xxx.jpg
                // 提取：2025/12/18/Random/xxx.jpg
                const urlPattern = /\/img\/Upload\/(.+)$/;
                const match = media.url.match(urlPattern);

                if (!match) {
                    console.error('无法提取文件路径:', media.url);
                    alert('文件路径格式错误');
                    return;
                }

                const filePath = match[1];
                console.log('提取文件路径:', filePath);

                // 构造消息（用方括号包裹路径）
                const message = {
                    "act": `touser_${currentChatUser.value.id}_${currentChatUser.value.name}`,
                    "id": currentUser.value.id,
                    "msg": `[${filePath}]`
                };

                // 发送到 WebSocket
                ws.send(JSON.stringify(message));
                console.log('发送媒体消息，等待服务器回显:', message);

                // 记录发送关系到数据库
                fetchWithToken(`${API_BASE}/recordImageSend`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        remoteUrl: media.url,
                        fromUserId: currentUser.value.id,
                        toUserId: currentChatUser.value.id
                    })
                }).then(response => {
                    if (response.ok) {
                        console.log('发送记录已保存');
                    } else {
                        console.error('记录发送失败:', response.status);
                    }
                }).catch(error => {
                    console.error('记录发送异常:', error);
                });

                // 关闭菜单
                showUploadMenu.value = false;
            };

            // 发送已上传的图片（兼容旧调用）
            const sendImageMessage = (imageUrl) => {
                sendMediaMessage({ url: imageUrl, type: 'image' });
            };

            // 重新上传历史图片到上游服务器
            const reuploadHistoryImage = async (historyImage) => {
                console.log('重新上传历史图片:', historyImage);

                try {
                    // 从本地URL提取 local_path
                    // 例如：http://localhost:8080/upload/images/2025/12/19/xxx.jpg
                    // 提取：/images/2025/12/19/xxx.jpg
                    const urlPattern = /\/upload(.+)$/;
                    const match = historyImage.url.match(urlPattern);

                    if (!match) {
                        console.error('无法提取本地路径:', historyImage.url);
                        alert('文件路径格式错误');
                        return;
                    }

                    const localPath = match[1];
                    console.log('提取本地路径:', localPath);

                    // 构造请求参数
                    const formData = new FormData();
                    formData.append('userId', currentUser.value.id);
                    formData.append('localPath', localPath);

                    const cookieData = generateCookie(currentUser.value.id, currentUser.value.name);
                    formData.append('cookieData', cookieData);
                    formData.append('referer', 'http://v1.chat2019.cn/randomdeskrynewjc46ko.html?v=jc46ko');
                    formData.append('userAgent', navigator.userAgent);

                    console.log('发送重新上传请求...');

                    // 调用后端接口
                    const response = await fetchWithToken(`${API_BASE}/reuploadHistoryImage`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('重新上传失败:', response.status, errorText);
                        alert('重新上传失败: ' + errorText);
                        return;
                    }

                    const data = await response.json();
                    console.log('重新上传返回:', data);

                    // 检查上传结果
                    if (data.state === 'OK' && data.msg) {
                        // ==================== 临时使用固定端口 ====================
                        const port = historyImage.type === 'video' ? '8006' : '9006';
                        const mediaUrl = `http://${imgServer.value}:${port}/img/Upload/${data.msg}`;
                        console.log('上游文件URL:', mediaUrl, '端口:', port, '(固定端口)');

                        // 添加到已上传列表开头（预览）
                        uploadedMedia.value.unshift({
                            url: mediaUrl,
                            type: historyImage.type
                        });

                        console.log('已添加到上传列表，可以点击发送');
                        showToast('图片已加载，点击可发送');
                    } else {
                        showToast('重新上传失败: ' + (data.msg || '未知错误'));
                    }

                } catch (error) {
                    console.error('重新上传历史图片异常:', error);
                    showToast('重新上传异常: ' + error.message);
                }
            };

            // 打开历史图片弹出框
            const openHistoryImageModal = async () => {
                showHistoryImageModal.value = true;
                historyImageLoading.value = true;

                try {
                    // 加载聊天历史图片
                    console.log('加载与', currentChatUser.value.name, '的聊天历史图片');
                    const historyResponse = await fetchWithToken(
                        `${API_BASE}/getChatImages?userId1=${currentUser.value.id}&userId2=${currentChatUser.value.id}&limit=50`
                    );

                    if (historyResponse.ok) {
                        const historyData = await historyResponse.json();
                        console.log('弹出框加载历史图片数据:', historyData);

                        if (Array.isArray(historyData)) {
                            chatHistoryImages.value = historyData
                                .filter(url => url && typeof url === 'string')
                                .map(url => ({
                                    url: url,
                                    type: url.toLowerCase().endsWith('.mp4') ? 'video' : 'image'
                                }));
                            console.log('弹出框中加载了', chatHistoryImages.value.length, '张聊天历史图片');
                        } else {
                            chatHistoryImages.value = [];
                        }
                    } else {
                        chatHistoryImages.value = [];
                        showToast('加载历史图片失败');
                    }
                } catch (error) {
                    console.error('加载历史图片异常:', error);
                    chatHistoryImages.value = [];
                    showToast('加载异常: ' + error.message);
                } finally {
                    historyImageLoading.value = false;
                }
            };

            // 关闭历史图片弹出框
            const closeHistoryImageModal = () => {
                showHistoryImageModal.value = false;
            };

            // 从弹出框重新上传历史图片
            const reuploadHistoryImageFromModal = async (historyImage) => {
                console.log('从弹出框重新上传历史图片:', historyImage);

                // 调用现有的重新上传逻辑
                await reuploadHistoryImage(historyImage);

                // 上传成功后关闭弹出框，显示上传菜单
                showHistoryImageModal.value = false;
                showAllUploadImageModal.value = false;
                showUploadMenu.value = true;
            };

            // 打开所有上传图片弹框
            const openAllUploadImageModal = async () => {
                showAllUploadImageModal.value = true;
                allUploadImages.value = [];
                allUploadPage.value = 1;
                allUploadTotal.value = 0;
                allUploadTotalPages.value = 0;

                // 加载第一页
                await loadAllUploadImages(1);
            };

            // 打开媒体管理弹框（从设置面板）
            const openMediaManagementModal = async () => {
                console.log('打开媒体管理弹框');
                managementMode.value = true;  // 启用管理模式
                showAllUploadImageModal.value = true;
                allUploadImages.value = [];
                allUploadPage.value = 1;
                allUploadTotal.value = 0;
                allUploadTotalPages.value = 0;
                selectionMode.value = false;
                selectedImages.value = [];

                // 加载第一页
                await loadAllUploadImages(1);
            };

            // 关闭所有上传图片弹框
            const closeAllUploadImageModal = () => {
                showAllUploadImageModal.value = false;
                managementMode.value = false;
                selectionMode.value = false;
                selectedImages.value = [];
                deletingImages.value.clear();
            };

            // 加载所有上传图片（分页）
            const loadAllUploadImages = async (page) => {
                if (allUploadLoading.value) return;  // 防止重复加载

                allUploadLoading.value = true;

                try {
                    console.log(`加载所有上传图片，第${page}页`);

                    const response = await fetchWithToken(
                        `${API_BASE}/getAllUploadImages?userId=${currentUser.value.id}&page=${page}&pageSize=${allUploadPageSize.value}`
                    );

                    if (response.ok) {
                        const result = await response.json();
                        console.log('所有上传图片数据:', result);

                        if (result.data && Array.isArray(result.data)) {
                            // 直接使用本地URL，不转换为上游URL
                            const newImages = result.data
                                .filter(url => url && typeof url === 'string')
                                .map(url => {
                                    const fileType = url.toLowerCase().endsWith('.mp4') ? 'video' : 'image';
                                    return { url: url, type: fileType };  // 直接使用本地URL
                                });

                            // 追加到列表
                            if (page === 1) {
                                allUploadImages.value = newImages;
                            } else {
                                allUploadImages.value.push(...newImages);
                            }

                            // 更新分页信息
                            allUploadTotal.value = result.total || 0;
                            allUploadTotalPages.value = result.totalPages || 0;
                            allUploadPage.value = page;

                            console.log(`加载了${newImages.length}张图片，总共${allUploadTotal.value}张`);
                        }
                    } else {
                        showToast('加载失败');
                    }
                } catch (error) {
                    console.error('加载所有上传图片异常:', error);
                    showToast('加载异常: ' + error.message);
                } finally {
                    allUploadLoading.value = false;
                }
            };

            // 处理所有上传图片的滚动事件（自动加载下一页）
            const handleAllUploadScroll = (event) => {
                const container = event.target;
                const scrollTop = container.scrollTop;
                const scrollHeight = container.scrollHeight;
                const clientHeight = container.clientHeight;

                // 距离底部100px时触发加载
                if (scrollTop + clientHeight >= scrollHeight - 100) {
                    // 还有更多页，且不在加载中
                    if (allUploadPage.value < allUploadTotalPages.value && !allUploadLoading.value) {
                        console.log('滚动到底部，加载下一页');
                        loadAllUploadImages(allUploadPage.value + 1);
                    }
                }
            };

            // ============== 媒体管理相关方法 ==============

            // 切换选择模式
            const toggleSelectionMode = () => {
                console.log('切换选择模式');
                selectionMode.value = !selectionMode.value;
                if (!selectionMode.value) {
                    // 退出选择模式时清空选中项
                    selectedImages.value = [];
                }
            };

            // 切换单个图片选择
            const toggleImageSelection = (media) => {
                const index = selectedImages.value.indexOf(media.url);
                if (index > -1) {
                    // 已选中，取消选中
                    selectedImages.value.splice(index, 1);
                    console.log('取消选中图片:', media.url);
                } else {
                    // 未选中，添加选中（检查上限）
                    if (selectedImages.value.length >= 50) {
                        showToast('最多选择50张图片');
                        return;
                    }
                    selectedImages.value.push(media.url);
                    console.log('选中图片:', media.url, '已选', selectedImages.value.length);
                }
            };

            // 全选/取消全选
            const selectAll = () => {
                if (selectedImages.value.length === allUploadImages.value.length) {
                    // 已全选，取消全选
                    selectedImages.value = [];
                    console.log('取消全选');
                } else {
                    // 全选当前页（最多50张）
                    const toSelect = allUploadImages.value.slice(0, 50);
                    selectedImages.value = toSelect.map(img => img.url);
                    console.log('全选当前页:', selectedImages.value.length, '张');
                    if (allUploadImages.value.length > 50) {
                        showToast('已选中前50张图片（上限）');
                    }
                }
            };

            // 处理图片点击（根据模式和状态决定行为）
            const handleImageClick = (media) => {
                if (managementMode.value && selectionMode.value) {
                    // 管理模式 + 选择模式：切换选中状态
                    toggleImageSelection(media);
                } else {
                    // 其他情况：预览图片
                    previewUploadMedia(media);
                }
            };

            // 确认删除单个图片
            const confirmDeleteSingle = (media) => {
                console.log('准备删除单个图片:', media);
                deleteTargets.value = [media];
                showMediaDeleteConfirm.value = true;
            };

            // 确认批量删除
            const confirmBatchDelete = () => {
                if (selectedImages.value.length === 0) {
                    showToast('请先选择要删除的图片');
                    return;
                }

                if (selectedImages.value.length > 50) {
                    showToast('单次最多删除50张图片');
                    return;
                }

                console.log('准备批量删除:', selectedImages.value.length, '张');

                // 构造删除目标列表
                deleteTargets.value = allUploadImages.value.filter(
                    img => selectedImages.value.includes(img.url)
                );
                showMediaDeleteConfirm.value = true;
            };

            // 执行删除
            const executeDelete = async () => {
                console.log('开始执行删除:', deleteTargets.value.length, '张');
                deleting.value = true;

                try {
                    if (deleteTargets.value.length === 1) {
                        // 单个删除
                        await deleteSingleImage(deleteTargets.value[0]);
                    } else {
                        // 批量删除
                        await batchDeleteImages(deleteTargets.value);
                    }

                    // 关闭确认对话框
                    showMediaDeleteConfirm.value = false;
                    deleteTargets.value = [];

                    // 退出选择模式
                    selectionMode.value = false;
                    selectedImages.value = [];

                    // 刷新列表
                    await loadAllUploadImages(allUploadPage.value);

                } catch (error) {
                    console.error('删除失败:', error);
                    showToast('删除失败: ' + error.message);
                } finally {
                    deleting.value = false;
                }
            };

            // 删除单个图片
            const deleteSingleImage = async (media) => {
                try {
                    // 提取本地路径（从URL中）
                    const localPath = extractLocalPath(media.url);
                    console.log('删除图片，localPath=', localPath);

                    // 标记为删除中
                    deletingImages.value.add(media.url);

                    const params = new URLSearchParams();
                    params.append('localPath', localPath);
                    params.append('userId', currentUser.value.id);

                    const response = await fetchWithToken(`${API_BASE}/deleteMedia`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: params
                    });

                    const result = await response.json();
                    console.log('删除响应:', result);

                    if (result.code === 0) {
                        // 从列表中移除
                        allUploadImages.value = allUploadImages.value.filter(
                            img => img.url !== media.url
                        );
                        allUploadTotal.value--;

                        showToast('删除成功');
                        console.log('删除成功，剩余', allUploadImages.value.length, '张');
                    } else {
                        throw new Error(result.msg || '删除失败');
                    }

                } catch (error) {
                    console.error('删除图片失败:', error);
                    throw error;
                } finally {
                    // 移除删除中标记
                    deletingImages.value.delete(media.url);
                }
            };

            // 批量删除图片
            const batchDeleteImages = async (mediaList) => {
                try {
                    // 提取所有本地路径
                    const localPaths = mediaList.map(media => extractLocalPath(media.url));
                    console.log('批量删除，count=', localPaths.length, 'localPaths=', localPaths);

                    // 标记所有为删除中
                    mediaList.forEach(media => deletingImages.value.add(media.url));

                    const response = await fetchWithToken(`${API_BASE}/batchDeleteMedia`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            userId: currentUser.value.id,
                            localPaths: localPaths
                        })
                    });

                    const result = await response.json();
                    console.log('批量删除响应:', result);

                    if (result.code === 0) {
                        const { successCount, failCount, failedItems } = result.data;

                        // 从列表中移除成功删除的项
                        const failedUrls = failedItems.map(item => {
                            // 根据localPath找到对应的URL
                            return mediaList.find(m => extractLocalPath(m.url) === item.localPath)?.url;
                        }).filter(Boolean);

                        allUploadImages.value = allUploadImages.value.filter(
                            img => !mediaList.map(m => m.url).includes(img.url) || failedUrls.includes(img.url)
                        );

                        allUploadTotal.value -= successCount;

                        // 显示结果
                        if (failCount > 0) {
                            showToast(`删除完成：成功${successCount}张，失败${failCount}张`);
                            console.warn('失败项:', failedItems);
                        } else {
                            showToast(`批量删除成功（${successCount}张）`);
                            console.log('批量删除成功:', successCount, '张');
                        }
                    } else {
                        throw new Error(result.msg || '批量删除失败');
                    }

                } catch (error) {
                    console.error('批量删除失败:', error);
                    throw error;
                } finally {
                    // 移除所有删除中标记
                    mediaList.forEach(media => deletingImages.value.delete(media.url));
                }
            };

            // 从URL中提取本地路径
            const extractLocalPath = (url) => {
                // URL格式：http://localhost:8080/upload/images/2025/12/19/xxx.jpg
                // 提取：/images/2025/12/19/xxx.jpg
                const urlPattern = /\/upload(\/?.+)$/;
                const match = url.match(urlPattern);
                return match ? match[1] : url;
            };

            // 从URL中提取文件名
            const extractFileName = (url) => {
                const parts = url.split('/');
                return parts[parts.length - 1];
            };

            // 在弹框内触发上传
            const triggerUploadInModal = () => {
                console.log('在弹框内触发文件选择');
                fileInput.value.click();
            };

            // ============== 媒体管理方法结束 ==============

            // 保存用户信息
            const saveUserInfo = async () => {
                const idChanged = editUserInfo.value.id !== currentUser.value.id;
                const nameChanged = editUserInfo.value.name !== currentUser.value.name;
                const sexChanged = editUserInfo.value.sex !== currentUser.value.sex;

                if (!idChanged && !nameChanged && !sexChanged) {
                    alert('没有任何修改');
                    editMode.value = false;
                    return;
                }

                // 设置等待响应标志
                waitingForResponse.value = true;

                try {
                    // 如果 ID 改变了，调用更新ID接口
                    if (idChanged) {
                        console.log('ID改变，调用 updateIdentityId API');

                        const params = new URLSearchParams();
                        params.append('oldId', currentUser.value.id);
                        params.append('newId', editUserInfo.value.id);
                        params.append('name', editUserInfo.value.name);
                        params.append('sex', editUserInfo.value.sex);

                        const response = await fetchWithToken(`${API_BASE}/updateIdentityId`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: params
                        });

                        const data = await response.json();
                        console.log('updateIdentityId 响应:', data);

                        if (data.code !== 0) {
                            alert('更新失败: ' + (data.msg || '未知错误'));
                            waitingForResponse.value = false;
                            return;
                        }

                        // 更新成功，更新本地数据
                        currentUser.value.id = editUserInfo.value.id;
                        currentUser.value.name = editUserInfo.value.name;
                        currentUser.value.sex = editUserInfo.value.sex;

                        // 断开当前 WebSocket
                        if (ws) {
                            ws.close();
                        }

                        // 清空聊天历史和列表
                        chatHistory.value = {};
                        historyUsers.value = [];
                        favoriteUsers.value = [];
                        historyLoaded.value = false;
                        favoriteLoaded.value = false;
                        firstTidMap.value = {};

                        // 重新连接
                        connectWebSocket();

                        editMode.value = false;
                        showSettings.value = false;
                        waitingForResponse.value = false;
                        showToast('用户ID已更新，正在重新连接...');
                        return;
                    }

                    // 如果名字或性别改变（ID不变），调用更新接口
                    if (nameChanged || sexChanged) {
                        console.log('名字/性别改变，调用 updateIdentity API');

                        const params = new URLSearchParams();
                        params.append('id', currentUser.value.id);
                        params.append('name', editUserInfo.value.name);
                        params.append('sex', editUserInfo.value.sex);

                        const response = await fetchWithToken(`${API_BASE}/updateIdentity`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: params
                        });

                        const data = await response.json();
                        console.log('updateIdentity 响应:', data);

                        if (data.code !== 0) {
                            alert('更新失败: ' + (data.msg || '未知错误'));
                            waitingForResponse.value = false;
                            return;
                        }

                        // 检查 WebSocket 连接
                        if (!ws || ws.readyState !== WebSocket.OPEN) {
                            alert('数据库已更新，但WebSocket未连接，无法同步聊天状态');
                            waitingForResponse.value = false;
                            editMode.value = false;
                            return;
                        }

                        // 数据库更新成功，发送 WebSocket 消息

                        // 如果性别修改了，发送修改性别消息
                        if (sexChanged) {
                            const modInfoMessage = {
                                "act": "modinfo",
                                "id": currentUser.value.id,
                                "userSex": editUserInfo.value.sex,
                                "address_show": "false",
                                "randomhealthmode": "0",
                                "randomvipsex": "0",
                                "randomvipaddress": "0"
                            };
                            ws.send(JSON.stringify(modInfoMessage));
                            console.log('发送修改性别消息:', modInfoMessage);
                        }

                        // 如果名字修改了，发送修改名字消息
                        if (nameChanged) {
                            const chgNameMessage = {
                                "act": "chgname",
                                "id": currentUser.value.id,
                                "msg": editUserInfo.value.name
                            };
                            ws.send(JSON.stringify(chgNameMessage));
                            console.log('发送修改名字消息:', chgNameMessage);
                        }

                        // 更新本地数据
                        currentUser.value.name = editUserInfo.value.name;
                        currentUser.value.sex = editUserInfo.value.sex;

                        // 设置超时，等待服务器响应
                        setTimeout(() => {
                            if (waitingForResponse.value) {
                                waitingForResponse.value = false;
                                editMode.value = false;
                                showToast('信息已保存');
                            }
                        }, 2000);
                    }

                } catch (error) {
                    console.error('保存用户信息失败:', error);
                    alert('保存失败: ' + error.message);
                    waitingForResponse.value = false;
                }
            };

            // 监听编辑模式，初始化编辑数据
            const initEditMode = () => {
                editUserInfo.value.id = currentUser.value.id;
                editUserInfo.value.name = currentUser.value.name;
                editUserInfo.value.sex = currentUser.value.sex;
            };

            // WebSocket 连接逻辑
            let manualClose = false; // 手动关闭标志
            const connectWebSocket = () => {
                const token = authToken.value || localStorage.getItem('authToken');

                if (!token) {
                    console.error('没有Token，无法连接WebSocket');
                    showToast('认证失败，请重新登录');
                    handleLogout();
                    return;
                }

                // 在WebSocket URL中添加token参数
                const wsUrlWithToken = `${WS_URL}?token=${encodeURIComponent(token)}`;
                console.log('正在连接 WebSocket (已携带Token)');

                ws = new WebSocket(wsUrlWithToken);

                ws.onopen = () => {
                    console.log('WebSocket 连接成功');
                    wsConnected.value = true;

                    // 连接成功后先上报访问记录
                    reportReferrer().then(() => {
                        console.log('上报完成，可以开始加载列表');
                    });

                    // 连接成功后发送登录消息
                    const signMessage = {
                        "act": "sign",
                        "id": currentUser.value.id,
                        "name": currentUser.value.name,
                        "userSex": currentUser.value.sex,
                        "address_show": "false",
                        "randomhealthmode": "0",
                        "randomvipsex": "0",
                        "randomvipaddress": "0",
                        "userip": currentUser.value.ip,
                        "useraddree": currentUser.value.address,
                        "randomvipcode": ""
                    };

                    const signMsg = JSON.stringify(signMessage);
                    ws.send(signMsg);
                    console.log('已发送登录消息:', signMsg);
                };

                ws.onmessage = (event) => {
                    console.log('收到消息:', event.data);

                    try {
                        // 尝试解析 JSON
                        const data = JSON.parse(event.data);

                        // 过滤系统消息（code: 12, 13, 16, 19 等），用 toast 显示
                        if (data.code === 12 || data.code === 13 || data.code === 16 || data.code === 19) {
                            console.log('系统消息，toast显示:', data);
                            if (data.content) {
                                showToast(data.content);
                            }
                            return;
                        }

                        // 忽略特定消息（code: 18）
                        if (data.code === 18) {
                            console.log('忽略消息 code=18:', data);
                            return;
                        }

                        // 处理正在输入消息
                        if (data.act && (data.act.startsWith('inputStatusOn_') || data.act.startsWith('inputStatusOff_'))) {
                            const isOn = data.act.startsWith('inputStatusOn_');
                            // 提取用户ID（格式：inputStatusOn_userId_nickname）
                            const parts = data.act.split('_');
                            const typingUserId = parts[1];

                            console.log('正在输入状态:', isOn ? '开始' : '结束', 'userId=', typingUserId);

                            // 如果当前正在和这个用户聊天，显示/隐藏正在输入提示
                            if (currentChatUser.value && currentChatUser.value.id === typingUserId) {
                                isTyping.value = isOn;
                                console.log('更新正在输入状态:', isTyping.value);

                                // 如果显示正在输入，滚动到底部
                                if (isOn) {
                                    scrollToBottom();
                                }
                            }
                            return;
                        }

                        // 处理聊天消息 (code: 7)
                        if (data.code === 7 && data.fromuser) {
                            console.log('收到聊天消息:', data);

                            const fromUserId = data.fromuser.id;
                            const toUserId = data.touser ? data.touser.id : null;
                            let messageContent = data.fromuser.content;
                            const fromUserNickname = data.fromuser.nickname;

                            console.log('解析消息 - fromUserId=', fromUserId, 'toUserId=', toUserId, 'currentUserId=', currentUser.value.id);
                            console.log('消息内容:', messageContent);
                            console.log('当前聊天对象:', currentChatUser.value ? currentChatUser.value.id : '无');

                            // 判断是不是自己发送的消息（通过nickname判断，因为fromuser.id是随机会话ID）
                            const isSelf = data.fromuser.nickname === currentUser.value.name;
                            console.log('isSelf=', isSelf, '(通过nickname判断)');

                            // 判断是否应该显示这条消息（通过nickname判断）
                            const shouldDisplay = currentChatUser.value &&
                                (data.fromuser.nickname === currentChatUser.value.name ||
                                 (data.touser && data.touser.nickname === currentChatUser.value.name));

                            console.log('shouldDisplay=', shouldDisplay);

                            // 检查是否是图片消息
                            let messageType = 'text';
                            if (messageContent.startsWith('[') && messageContent.endsWith(']') &&
                                (messageContent.includes('.jpg') || messageContent.includes('.png') || messageContent.includes('.jpeg') || messageContent.includes('.gif'))) {
                                // 提取图片路径
                                const imagePath = messageContent.substring(1, messageContent.length - 1);
                                // ==================== 临时使用固定端口9006 ====================
                                messageContent = `http://${imgServer.value}:9006/img/Upload/${imagePath}`;
                                messageType = 'image';
                                console.log('图片消息，拼接URL:', messageContent, '端口: 9006 (固定)');
                            }
                            // 检查是否是视频消息
                            else if (messageContent.startsWith('[') && messageContent.endsWith(']') && messageContent.includes('.mp4')) {
                                // 提取视频路径
                                const videoPath = messageContent.substring(1, messageContent.length - 1);
                                // ==================== 临时使用固定端口8006 ====================
                                messageContent = `http://${imgServer.value}:8006/img/Upload/${videoPath}`;
                                messageType = 'video';
                                console.log('视频消息，拼接URL:', messageContent, '端口: 8006 (固定)');
                            }

                            // 获取消息时间
                            const msgTime = data.fromuser.time || new Date().toISOString().replace('T', ' ').substring(0, 23);

                            if (shouldDisplay) {
                                // 收到消息，隐藏正在输入提示
                                if (!isSelf) {
                                    isTyping.value = false;
                                }

                                // 显示消息
                                console.log('✓ 显示消息在聊天界面:', messageContent, 'isSelf=', isSelf, 'type=', messageType);
                                pushMessage(messageType, messageContent, isSelf, msgTime, data.fromuser.nickname);
                                currentChatUser.value.lastMsg = messageType === 'image' ? '[图片]' : (messageType === 'video' ? '[视频]' : messageContent);
                                currentChatUser.value.lastTime = '刚刚';
                            } else if (!isSelf) {
                                // 不在当前聊天界面，但收到消息 - 更新列表
                                console.log('✓ 更新列表中的消息');
                                const existingUser = historyUsers.value.find(u => u.id === fromUserId);
                                if (existingUser) {
                                    existingUser.lastMsg = messageType === 'image' ? '[图片]' : (messageType === 'video' ? '[视频]' : messageContent);
                                    existingUser.lastTime = '刚刚';
                                    existingUser.unreadCount = (existingUser.unreadCount || 0) + 1;  // 未读数+1
                                } else {
                                    // 如果列表中没有这个用户，添加到列表
                                    // 额外检查：确保不是自己（双重保险）
                                    if (fromUserId !== currentUser.value.id) {
                                        const newUser = {
                                            id: fromUserId,
                                            name: fromUserNickname,
                                            lastMsg: messageType === 'image' ? '[图片]' : (messageType === 'video' ? '[视频]' : messageContent),
                                            lastTime: '刚刚',
                                            isFavorite: false,
                                            colorClass: getRandomColor(),
                                            unreadCount: 1  // 新用户且有一条新消息
                                        };
                                        historyUsers.value.unshift(newUser);
                                    } else {
                                        console.log('忽略添加自己到列表');
                                    }
                                }

                                // 初始化聊天记录（如果不存在）
                                if (!chatHistory.value[fromUserId]) {
                                    chatHistory.value[fromUserId] = [];
                                }
                                chatHistory.value[fromUserId].push({
                                    type: messageType,
                                    content: messageContent,
                                    isSelf: false,
                                    time: msgTime
                                });
                            }
                            return;
                        }

                        // 处理匹配成功消息 (code: 15)
                        if (data.code === 15 && data.sel_userid) {
                            console.log('匹配成功:', data);
                            isMatching.value = false;

                            // 创建匹配到的用户
                            const matchedUser = {
                                id: data.sel_userid,
                                name: data.sel_userNikename || '匿名用户',
                                lastMsg: '匹配成功',
                                lastTime: '刚刚',
                                isFavorite: false,
                                colorClass: getRandomColor(),
                                sex: data.sel_userSex || '未知',
                                age: data.sel_userAge || '未知',
                                address: data.sel_userAddress || '未知',
                                unreadCount: 0  // 未读消息数
                            };

                            // 添加到历史列表并置顶
                            historyUsers.value.unshift(matchedUser);

                            // 初始化为空聊天记录
                            chatHistory.value[matchedUser.id] = [];

                            // 直接进入聊天（不加载历史记录）
                            enterChat(matchedUser, false);
                            return;
                        }

                        // 如果正在等待修改信息的响应
                        if (waitingForResponse.value) {
                            waitingForResponse.value = false;

                            // 弹出服务器返回的消息
                            if (data.content) {
                                alert('服务器响应: ' + data.content);
                            } else if (data.msg) {
                                alert('服务器响应: ' + data.msg);
                            } else {
                                alert('服务器响应: ' + event.data);
                            }

                            // 退出编辑模式
                            editMode.value = false;
                            return;
                        }

                        // 如果当前在聊天界面，显示收到的消息
                        if (currentChatUser.value) {
                            const messageContent = data.content || event.data;
                            pushMessage('text', messageContent, false, null, currentChatUser.value.name);
                            currentChatUser.value.lastMsg = messageContent;
                            currentChatUser.value.lastTime = '刚刚';
                        }
                    } catch (e) {
                        // 如果不是 JSON，直接显示
                        if (currentChatUser.value) {
                            pushMessage('text', event.data, false, null, currentChatUser.value.name);
                            currentChatUser.value.lastMsg = event.data;
                            currentChatUser.value.lastTime = '刚刚';
                        }
                    }
                };

                ws.onerror = (error) => {
                    console.error('WebSocket 错误:', error);
                    wsConnected.value = false;
                };

                ws.onclose = () => {
                    console.log('WebSocket 连接关闭');
                    wsConnected.value = false;

                    // 如果是手动关闭（切换身份），不重连
                    if (manualClose) {
                        console.log('手动关闭，跳过重连');
                        manualClose = false;
                        return;
                    }

                    // 尝试重连
                    setTimeout(() => {
                        console.log('尝试重新连接...');
                        connectWebSocket();
                    }, 3000);
                };
            };

            // 页面加载时先检查Token
            (async () => {
                const tokenValid = await checkToken();

                if (tokenValid) {
                    // Token有效，显示身份选择页并加载身份列表
                    showIdentityPicker.value = true;
                    await loadIdentityList();
                }
                // 如果Token无效，已经在checkToken中显示登录页了
            })();

            // 初始化编辑数据
            initEditMode();

            // 不再自动加载列表，等待用户点击 Tab

            return {
                activeTab, isMatching, historyUsers, favoriteUsers, displayList,
                currentChatUser, chatHistory, inputText, fileInput, chatBox, listArea,
                wsConnected, showSettings, currentUser, editMode, editUserInfo, waitingForResponse, imgServer, isTyping, uploadedMedia, toastMessage, loadingMore,
                showMediaPreview, previewMediaUrl, previewMediaType, previewMediaCanUpload, closeMediaPreview, confirmPreviewUpload,
                // 上传菜单相关
                showUploadMenu, triggerFileSelect, sendMediaMessage,
                // 历史图片弹出框相关
                showHistoryImageModal, historyImageLoading, chatHistoryImages,
                openHistoryImageModal, closeHistoryImageModal, reuploadHistoryImageFromModal,
                // 所有上传图片弹框相关
                showAllUploadImageModal, allUploadImages, allUploadLoading, allUploadPage, allUploadTotal, allUploadTotalPages, allUploadScrollContainer,
                openAllUploadImageModal, closeAllUploadImageModal, loadAllUploadImages, handleAllUploadScroll,
                // 媒体管理相关
                managementMode, selectionMode, selectedImages, deletingImages,
                showMediaDeleteConfirm, deleteTargets, deleting,
                openMediaManagementModal, toggleSelectionMode, toggleImageSelection,
                selectAll, handleImageClick, confirmDeleteSingle, confirmBatchDelete,
                executeDelete, deleteSingleImage, batchDeleteImages,
                extractLocalPath, extractFileName, triggerUploadInModal,
                // 表情相关
                emojiMap, showEmojiPanel, toggleEmojiPanel, insertEmoji, parseEmoji, closeAllPanels,
                // 登录认证相关
                showLoginPage, loginAccessCode, loginLoading, authToken,
                handleLogin, checkToken, handleLogout, fetchWithToken,
                // 身份选择相关
                showIdentityPicker, identityList, identityLoading, showCreateForm, newIdentity, deleteConfirmIdentity,
                getColorClass, loadIdentityList, selectIdentity, createIdentity, quickCreateIdentity, showDeleteConfirm, confirmDeleteIdentity,
                // 身份切换相关
                showTopMenu, showSwitchIdentityDialog,
                openIdentitySettings, openSystemSettings, showSwitchIdentityConfirm, confirmSwitchIdentity, cancelSwitchIdentity,
                // 系统设置相关
                settingsMode, showDisconnectAllDialog, disconnectAllLoading, connectionStats,
                loadConnectionStats, confirmDisconnectAll, executeDisconnectAll,
                // 原有功能
                startMatch, cancelMatch, enterChat, exitChat, toggleFavorite,
                sendMessage, selectFile, handleFileUpload, autoResize, previewMedia, previewUploadMedia, sendImageMessage, formatTime, loadMoreHistory,
                loadHistoryUsers, loadFavoriteUsers, saveUserInfo, initEditMode, switchTab, refreshCurrentList, loadMessageHistory
            };
        }
    }).mount('#app');
</script>
</body>
</html>
