<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>匿名匹配</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #0f0f13; color: #e0e0e0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow: hidden; }
        .page-container { height: 100vh; display: flex; flex-direction: column; position: relative;}
        
        /* 隐藏滚动条 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 列表区域 */
        .list-area { flex: 1; overflow-y: auto; padding-bottom: 90px; } /* 底部留白给按钮 */
        
        /* 聊天区域 */
        .chat-area { flex: 1; overflow-y: auto; padding: 15px; background-color: #0f0f13; }
        
        /* 匹配按钮特效 */
        .match-btn-container {
            position: absolute; bottom: 80px; left: 0; right: 0; 
            display: flex; justify-content: center; z-index: 10;
            pointer-events: none; /* 让容器不挡点击，只让按钮挡 */
        }
        .match-btn {
            pointer-events: auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
            transition: transform 0.2s;
        }
        .match-btn:active { transform: scale(0.95); }

        /* 气泡样式 (无头像) */
        .msg-bubble {
            padding: 12px 16px;
            border-radius: 16px;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 15px;
            line-height: 1.5;
        }
        .msg-left { 
            background-color: #27272a; 
            color: #eee; 
            border-bottom-left-radius: 2px; 
            align-self: flex-start; /* 左对齐 */
        }
        .msg-right { 
            background-color: #4f46e5; /* Indigo-600 */
            color: white; 
            border-bottom-right-radius: 2px; 
            align-self: flex-end; /* 右对齐 */
            margin-left: auto; /* 强制靠右 */
        }
        
        /* 加载动画 */
        .radar-spinner {
            width: 20px; height: 20px; border: 2px solid #fff; 
            border-top-color: transparent; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* 占位图标颜色类 */
        .bg-color-1 { background-color: #3b82f6; }
        .bg-color-2 { background-color: #10b981; }
        .bg-color-3 { background-color: #f59e0b; }
        .bg-color-4 { background-color: #ec4899; }
        .bg-color-5 { background-color: #8b5cf6; }

        /* 身份选择页样式 */
        .identity-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .identity-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .identity-card:active {
            transform: scale(0.98);
        }
        .identity-card.selected {
            border-color: #6366f1;
            background-color: rgba(99, 102, 241, 0.1);
        }
    </style>
</head>
<body>

<div id="app" class="h-full">

    <!-- === Toast 弹窗 === -->
    <div v-if="toastMessage" class="fixed top-16 left-1/2 -translate-x-1/2 z-[100] px-4 py-2 bg-[#27272a] text-white text-sm rounded-full shadow-lg animate-pulse">
        {{ toastMessage }}
    </div>

    <!-- === 身份选择页面 === -->
    <div v-if="showIdentityPicker" class="page-container">
        <!-- 顶部标题 -->
        <div class="pt-8 pb-4 px-4 text-center">
            <h1 class="text-2xl font-bold text-white mb-2">选择身份</h1>
            <p class="text-sm text-gray-400">选择一个身份开始聊天，或创建新身份</p>
        </div>

        <!-- 操作按钮区 -->
        <div class="flex gap-3 px-4 mb-4">
            <button @click="quickCreateIdentity" :disabled="identityLoading"
                class="flex-1 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-medium shadow-lg disabled:opacity-50">
                <i class="fas fa-bolt mr-2"></i>快速进入
            </button>
            <button @click="showCreateForm = true"
                class="flex-1 py-3 bg-[#27272a] text-white rounded-xl font-medium border border-gray-700">
                <i class="fas fa-plus mr-2"></i>创建身份
            </button>
        </div>

        <!-- 身份列表 -->
        <div class="list-area no-scrollbar px-4">
            <!-- 加载中 -->
            <div v-if="identityLoading" class="flex flex-col items-center justify-center mt-20">
                <div class="radar-spinner"></div>
                <p class="text-gray-500 text-sm mt-4">加载中...</p>
            </div>

            <!-- 身份卡片列表 -->
            <div v-else-if="identityList.length > 0">
                <div v-for="identity in identityList" :key="identity.id"
                    @click="selectIdentity(identity)"
                    class="identity-card flex items-center p-4 mb-3 bg-[#18181b] rounded-2xl border border-transparent">

                    <!-- 头像 -->
                    <div :class="getColorClass(identity.id)"
                        class="w-14 h-14 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg shrink-0">
                        {{ identity.name.charAt(0) }}
                    </div>

                    <!-- 信息 -->
                    <div class="ml-4 flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-bold text-lg text-white">{{ identity.name }}</span>
                            <span class="px-2 py-0.5 text-xs rounded-full"
                                :class="identity.sex === '男' ? 'bg-blue-500/20 text-blue-400' : 'bg-pink-500/20 text-pink-400'">
                                {{ identity.sex }}
                            </span>
                        </div>
                        <p class="text-xs text-gray-500">ID: {{ identity.id.substring(0, 8) }}...</p>
                        <p v-if="identity.lastUsedAt" class="text-xs text-gray-600 mt-1">
                            最后使用: {{ identity.lastUsedAt }}
                        </p>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="flex items-center gap-2">
                        <button @click.stop="showDeleteConfirm(identity)"
                            class="w-8 h-8 flex items-center justify-center text-red-500 hover:bg-red-500/10 rounded-lg transition">
                            <i class="fas fa-trash-alt text-sm"></i>
                        </button>
                        <i class="fas fa-chevron-right text-gray-600"></i>
                    </div>
                </div>
            </div>

            <!-- 空状态 -->
            <div v-else class="flex flex-col items-center justify-center mt-20 text-gray-600">
                <i class="fas fa-user-plus text-5xl mb-4 opacity-50"></i>
                <p class="text-sm">还没有身份，点击上方按钮创建</p>
            </div>
        </div>

        <!-- 创建身份弹窗 -->
        <div v-if="showCreateForm" class="fixed inset-0 z-[80] bg-black/60 flex items-center justify-center" @click="showCreateForm = false">
            <div class="w-80 bg-[#18181b] rounded-2xl p-6 shadow-2xl" @click.stop>
                <h3 class="text-lg font-bold text-white mb-4 text-center">创建新身份</h3>

                <div class="space-y-4">
                    <!-- 名字输入 -->
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">名字</label>
                        <input v-model="newIdentity.name" type="text" placeholder="输入名字"
                            class="w-full bg-[#27272a] text-white px-4 py-3 rounded-xl border border-gray-700 focus:border-indigo-500 focus:outline-none">
                    </div>

                    <!-- 性别选择 -->
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">性别</label>
                        <div class="flex gap-3">
                            <button @click="newIdentity.sex = '男'"
                                :class="newIdentity.sex === '男' ? 'bg-blue-600 border-blue-600' : 'bg-[#27272a] border-gray-700'"
                                class="flex-1 py-3 rounded-xl border text-white font-medium">
                                <i class="fas fa-mars mr-2"></i>男
                            </button>
                            <button @click="newIdentity.sex = '女'"
                                :class="newIdentity.sex === '女' ? 'bg-pink-600 border-pink-600' : 'bg-[#27272a] border-gray-700'"
                                class="flex-1 py-3 rounded-xl border text-white font-medium">
                                <i class="fas fa-venus mr-2"></i>女
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 按钮 -->
                <div class="flex gap-3 mt-6">
                    <button @click="showCreateForm = false"
                        class="flex-1 py-3 bg-[#27272a] text-gray-400 rounded-xl border border-gray-700">
                        取消
                    </button>
                    <button @click="createIdentity" :disabled="!newIdentity.name || !newIdentity.sex"
                        class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                        创建
                    </button>
                </div>
            </div>
        </div>

        <!-- 删除确认对话框 -->
        <div v-if="deleteConfirmIdentity" class="fixed inset-0 z-[90] bg-black/60 flex items-center justify-center" @click="deleteConfirmIdentity = null">
            <div class="w-80 bg-[#18181b] rounded-2xl p-6 shadow-2xl" @click.stop>
                <div class="text-center mb-4">
                    <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-3"></i>
                    <h3 class="text-lg font-bold text-white mb-2">确认删除</h3>
                    <p class="text-sm text-gray-400">确定要删除身份 <span class="text-white font-medium">{{ deleteConfirmIdentity.name }}</span> 吗？</p>
                    <p class="text-xs text-gray-500 mt-1">此操作无法撤销</p>
                </div>

                <!-- 按钮 -->
                <div class="flex gap-3">
                    <button @click="deleteConfirmIdentity = null"
                        class="flex-1 py-3 bg-[#27272a] text-gray-400 rounded-xl border border-gray-700">
                        取消
                    </button>
                    <button @click="confirmDeleteIdentity"
                        class="flex-1 py-3 bg-red-600 text-white rounded-xl font-medium">
                        删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- === 用户配置抽屉 === -->
    <div v-if="showSettings" class="fixed inset-0 z-[70] bg-black/50" @click="showSettings = false">
        <div class="absolute right-0 top-0 bottom-0 w-80 bg-[#18181b] shadow-2xl overflow-y-auto" @click.stop>
            <!-- 头部 -->
            <div class="h-14 flex items-center justify-between px-4 border-b border-gray-800">
                <h2 class="text-lg font-bold">用户信息</h2>
                <div class="flex items-center gap-2">
                    <button v-if="!editMode" @click="editMode = true; initEditMode()" class="px-3 py-1 bg-indigo-600 text-white text-sm rounded-lg">
                        编辑
                    </button>
                    <button v-else @click="saveUserInfo" :disabled="waitingForResponse" class="px-3 py-1 bg-green-600 text-white text-sm rounded-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                        <span v-if="waitingForResponse" class="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
                        <span>{{ waitingForResponse ? '保存中...' : '保存' }}</span>
                    </button>
                    <button @click="showSettings = false; editMode = false; waitingForResponse = false" class="w-10 h-10 flex items-center justify-center text-gray-400">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- 用户信息内容 -->
            <div class="p-6 space-y-6">
                <!-- 头像占位 -->
                <div class="flex justify-center">
                    <div class="w-24 h-24 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-3xl font-bold shadow-lg">
                        {{ currentUser.name.charAt(0) }}
                    </div>
                </div>

                <!-- 用户信息列表 -->
                <div class="space-y-4">
                    <!-- 用户名 -->
                    <div class="bg-[#27272a] rounded-xl p-4">
                        <div class="text-xs text-gray-500 mb-2">用户名</div>
                        <input
                            v-if="editMode"
                            v-model="editUserInfo.name"
                            type="text"
                            class="w-full bg-[#18181b] text-white px-3 py-2 rounded-lg border border-gray-700 focus:border-indigo-500 focus:outline-none"
                            placeholder="输入用户名"
                        />
                        <div v-else class="text-base text-white font-medium">{{ currentUser.name }}</div>
                    </div>

                    <!-- 用户ID -->
                    <div class="bg-[#27272a] rounded-xl p-4">
                        <div class="text-xs text-gray-500 mb-2">用户ID</div>
                        <input
                            v-if="editMode"
                            v-model="editUserInfo.id"
                            type="text"
                            class="w-full bg-[#18181b] text-white px-3 py-2 rounded-lg border border-gray-700 focus:border-indigo-500 focus:outline-none font-mono text-sm"
                            placeholder="输入用户ID"
                        />
                        <div v-else class="text-base text-white font-mono text-sm break-all">{{ currentUser.id }}</div>
                    </div>

                    <!-- 性别 -->
                    <div class="bg-[#27272a] rounded-xl p-4">
                        <div class="text-xs text-gray-500 mb-2">性别</div>
                        <select
                            v-if="editMode"
                            v-model="editUserInfo.sex"
                            class="w-full bg-[#18181b] text-white px-3 py-2 rounded-lg border border-gray-700 focus:border-indigo-500 focus:outline-none"
                        >
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                        <div v-else class="text-base text-white">{{ currentUser.sex }}</div>
                    </div>

                    <!-- IP地址（不可修改） -->
                    <div class="bg-[#27272a] rounded-xl p-4">
                        <div class="text-xs text-gray-500 mb-1">IP地址</div>
                        <div class="text-base text-white">{{ currentUser.ip }}</div>
                    </div>

                    <!-- 地区（不可修改） -->
                    <div class="bg-[#27272a] rounded-xl p-4">
                        <div class="text-xs text-gray-500 mb-1">地区</div>
                        <div class="text-base text-white">{{ currentUser.address }}</div>
                    </div>
                </div>

                <!-- 连接状态 -->
                <div class="bg-[#27272a] rounded-xl p-4 flex items-center justify-between">
                    <span class="text-sm text-gray-400">WebSocket 状态</span>
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full" :class="wsConnected ? 'bg-green-500' : 'bg-red-500'"></span>
                        <span class="text-sm" :class="wsConnected ? 'text-green-500' : 'text-red-500'">
                            {{ wsConnected ? '已连接' : '未连接' }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === 匹配蒙层 (模拟匹配过程) === -->
    <div v-if="isMatching" class="fixed inset-0 z-[60] bg-black/90 flex flex-col items-center justify-center text-center">
        <div class="relative w-32 h-32 mb-8">
            <div class="absolute inset-0 border-4 border-blue-500/30 rounded-full animate-ping"></div>
            <div class="absolute inset-0 border-4 border-blue-500 rounded-full flex items-center justify-center">
                <i class="fas fa-satellite-dish text-4xl text-blue-400"></i>
            </div>
        </div>
        <h2 class="text-xl font-bold mb-2">正在寻找有缘人...</h2>
        <p class="text-gray-400 text-sm">匹配完全匿名</p>
        <button @click="cancelMatch" class="mt-8 px-6 py-2 border border-gray-600 rounded-full text-gray-400 text-sm">取消</button>
    </div>

    <!-- === 页面 1: 会话列表 / 收藏列表 === -->
    <div class="page-container" v-if="!showIdentityPicker && !currentChatUser">
        
        <!-- 顶部切换栏 -->
        <div class="flex items-center justify-between pt-4 pb-2 px-4 bg-[#0f0f13] z-10">
            <!-- 左侧：设置按钮 -->
            <button @click="showSettings = true" class="w-10 h-10 flex items-center justify-center text-gray-400">
                <i class="fas fa-cog text-xl"></i>
            </button>

            <!-- 中间：切换栏 -->
            <div class="flex bg-[#1f1f22] p-1 rounded-full">
                <button
                    @click="switchTab('history')"
                    :class="activeTab === 'history' ? 'bg-[#2d2d33] text-white shadow-md' : 'text-gray-500'"
                    class="px-6 py-1.5 rounded-full text-sm font-medium transition-all duration-300">
                    消息
                </button>
                <button
                    @click="switchTab('favorites')"
                    :class="activeTab === 'favorites' ? 'bg-[#2d2d33] text-white shadow-md' : 'text-gray-500'"
                    class="px-6 py-1.5 rounded-full text-sm font-medium transition-all duration-300">
                    收藏
                </button>
            </div>

            <!-- 右侧：连接状态 -->
            <div class="flex items-center gap-1">
                <span class="w-2 h-2 rounded-full" :class="wsConnected ? 'bg-green-500' : 'bg-red-500'"></span>
            </div>
        </div>

        <!-- 列表内容 -->
        <div ref="listArea" class="list-area no-scrollbar px-4 pt-2">
            <div v-for="user in displayList" :key="user.id" @click="enterChat(user)" 
                 class="flex items-center p-4 mb-3 bg-[#18181b] rounded-2xl active:scale-[0.98] transition-transform duration-100">
                
                <!-- 纯色块代替头像 -->
                <div :class="user.colorClass" class="w-12 h-12 rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-lg shrink-0">
                    {{ user.name.charAt(0) }}
                </div>

                <!-- 文本信息 -->
                <div class="ml-4 flex-1 min-w-0">
                    <div class="flex justify-between items-baseline mb-1">
                        <span class="font-bold text-base truncate">{{ user.name }}</span>
                        <span class="text-xs text-gray-500">{{ user.lastTime }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <p class="text-sm text-gray-400 truncate pr-2">{{ user.lastMsg }}</p>
                        <!-- 收藏标识 -->
                        <i v-if="user.isFavorite && activeTab === 'history'" class="fas fa-star text-xs text-yellow-500"></i>
                    </div>
                </div>

                <!-- 未读消息数气泡 -->
                <span v-if="user.unreadCount > 0"
                    class="px-2 py-0.5 bg-red-500 text-white text-xs rounded-full min-w-[20px] text-center font-medium ml-2">
                    {{ user.unreadCount }}
                </span>
            </div>

            <!-- 空状态提示 -->
            <div v-if="displayList.length === 0" class="flex flex-col items-center justify-center mt-20 text-gray-600">
                <i class="far fa-comments text-5xl mb-4 opacity-50"></i>
                <p class="text-sm">暂无{{ activeTab === 'history' ? '消息' : '收藏' }}</p>
            </div>
        </div>

        <!-- 底部悬浮匹配按钮 -->
        <div class="match-btn-container">
            <button @click="startMatch" class="match-btn flex items-center px-6 py-3 rounded-full text-white font-bold">
                <i class="fas fa-random mr-2"></i> 匹配新用户
            </button>
        </div>
    </div>

    <!-- === 页面 2: 聊天界面 === -->
    <div class="page-container bg-[#0f0f13] absolute inset-0 z-50" v-if="!showIdentityPicker && currentChatUser">

        <!-- 聊天头部 -->
        <div class="bg-[#18181b]/90 backdrop-blur-sm border-b border-gray-800 sticky top-0 z-20 px-4 py-3">
            <div class="flex items-center justify-between mb-2">
                <button @click="exitChat" class="w-10 h-10 flex items-center justify-start text-gray-300">
                    <i class="fas fa-chevron-left text-xl"></i>
                </button>
                <div class="font-bold text-base">{{ currentChatUser.name }}</div>
                <button @click="toggleFavorite(currentChatUser)" class="w-10 h-10 flex items-center justify-end">
                    <i :class="currentChatUser.isFavorite ? 'fas fa-star text-yellow-500' : 'far fa-star text-gray-400'"></i>
                </button>
            </div>
            <div class="flex items-center justify-center gap-3 text-xs text-gray-400">
                <div class="flex items-center gap-1" v-if="currentChatUser.sex">
                    <i class="fas fa-venus-mars"></i>
                    <span>{{ currentChatUser.sex }}</span>
                </div>
                <div class="flex items-center gap-1" v-if="currentChatUser.age && currentChatUser.age !== '0'">
                    <i class="fas fa-birthday-cake"></i>
                    <span>{{ currentChatUser.age }}岁</span>
                </div>
                <div class="flex items-center gap-1" v-if="currentChatUser.address">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>{{ currentChatUser.address }}</span>
                </div>
                <div class="flex items-center gap-1" :class="wsConnected ? 'text-green-500' : 'text-red-500'">
                    <span class="w-1.5 h-1.5 rounded-full" :class="wsConnected ? 'bg-green-500' : 'bg-red-500'"></span>
                    <span>{{ wsConnected ? '已连接' : '未连接' }}</span>
                </div>
            </div>
        </div>

        <!-- 聊天内容 (无头像) -->
        <div class="chat-area flex flex-col no-scrollbar" ref="chatBox">
            <!-- 加载更多历史消息按钮 -->
            <div class="flex justify-center py-3">
                <button @click="loadMoreHistory" :disabled="loadingMore" class="px-4 py-2 bg-[#27272a] text-gray-400 text-sm rounded-full active:bg-[#3a3a3f] disabled:opacity-50">
                    <span v-if="loadingMore">加载中...</span>
                    <span v-else>查看历史消息</span>
                </button>
            </div>

            <div v-for="(msg, index) in chatHistory[currentChatUser.id] || []" :key="index"
                 class="flex flex-col w-full mb-3" :class="msg.isSelf ? 'items-end' : 'items-start'">

                <div v-if="msg.time" class="text-xs text-gray-500 mb-1" :class="msg.isSelf ? 'mr-1' : 'ml-1'">{{ formatTime(msg.time) }}</div>
                <div class="msg-bubble" :class="msg.isSelf ? 'msg-right' : 'msg-left'">
                    <!-- 文本 -->
                    <span v-if="msg.type === 'text'">{{ msg.content }}</span>

                    <!-- 图片 -->
                    <img v-if="msg.type === 'image'" :src="msg.content" class="rounded-lg max-w-full block" @click="previewMedia(msg.content)">

                    <!-- 视频 -->
                    <video v-if="msg.type === 'video'" :src="msg.content" controls class="rounded-lg max-w-full block"></video>
                </div>
            </div>

            <!-- 正在输入提示 -->
            <div v-if="isTyping" class="flex w-full justify-start mb-3">
                <div class="msg-bubble msg-left flex items-center gap-2">
                    <span class="text-gray-400">正在输入</span>
                    <div class="flex gap-1">
                        <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0s"></span>
                        <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                        <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 上传菜单面板 -->
        <div v-if="showUploadMenu" class="bg-[#1a1a1d] border-t border-gray-800 p-4 max-h-60 overflow-y-auto">
            <!-- 已上传媒体列表 -->
            <div v-if="uploadedMedia.length > 0" class="mb-3">
                <div class="text-xs text-gray-500 mb-2">已上传的文件（点击发送）</div>
                <div class="flex flex-wrap gap-2">
                    <div v-for="(media, idx) in uploadedMedia" :key="idx"
                        @click="sendMediaMessage(media)"
                        class="w-16 h-16 rounded-lg overflow-hidden cursor-pointer border border-gray-700 hover:border-indigo-500 transition relative">
                        <!-- 图片预览 -->
                        <img v-if="media.type === 'image'" :src="media.url" class="w-full h-full object-cover">
                        <!-- 视频预览 -->
                        <video v-if="media.type === 'video'" :src="media.url" class="w-full h-full object-cover">
                        </video>
                        <!-- 视频图标标识 -->
                        <div v-if="media.type === 'video'" class="absolute inset-0 flex items-center justify-center bg-black/30">
                            <i class="fas fa-play-circle text-white text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div v-else class="text-xs text-gray-500 mb-3">暂无已上传的文件</div>
            <!-- 选择文件按钮 -->
            <button @click="triggerFileSelect" class="w-full py-3 bg-[#27272a] text-white rounded-xl hover:bg-[#333] transition">
                <i class="fas fa-folder-open mr-2"></i>选择文件上传
            </button>
        </div>

        <!-- 底部输入框 -->
        <div class="bg-[#18181b] px-4 py-3 pb-safe flex items-end border-t border-gray-800">
            <div class="mr-3 mb-1">
                <i class="fas fa-plus-circle text-2xl text-gray-400 active:text-white transition" @click="selectFile"></i>
                <input type="file" ref="fileInput" class="hidden" @change="handleFileUpload">
            </div>

            <div class="flex-1 bg-[#27272a] rounded-2xl min-h-[40px] flex items-center px-4 py-2 mr-3">
                <textarea
                    v-model="inputText"
                    placeholder="发消息..."
                    class="w-full bg-transparent text-white outline-none text-base resize-none overflow-hidden h-6 leading-6"
                    rows="1"
                    @input="autoResize"
                    @keydown.enter.exact.prevent="sendMessage"
                ></textarea>
            </div>

            <button @click="sendMessage"
                class="mb-1 w-9 h-9 rounded-full bg-indigo-600 flex items-center justify-center text-white disabled:opacity-50 disabled:bg-gray-700 transition"
                :disabled="!inputText.trim()">
                <i class="fas fa-paper-plane text-xs"></i>
            </button>

            <!-- 匹配新用户按钮 -->
            <button @click="startMatch"
                class="ml-2 mb-1 w-9 h-9 rounded-full bg-purple-600 flex items-center justify-center text-white transition hover:bg-purple-700 active:scale-95"
                title="匹配新用户">
                <i class="fas fa-random text-xs"></i>
            </button>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, nextTick } = Vue;

    createApp({
        setup() {
            // 动态获取服务器地址
            const SERVER_HOST = window.location.host;
            const API_BASE = `http://${SERVER_HOST}/api`;
            const WS_URL = `ws://${SERVER_HOST}/ws`;

            // 随机颜色池
            const colors = ['bg-color-1', 'bg-color-2', 'bg-color-3', 'bg-color-4', 'bg-color-5'];
            const getRandomColor = () => colors[Math.floor(Math.random() * colors.length)];

            // 随机生成 IP 地址
            const generateRandomIP = () => {
                const part1 = Math.floor(Math.random() * 256);
                const part2 = Math.floor(Math.random() * 256);
                const part3 = Math.floor(Math.random() * 256);
                const part4 = Math.floor(Math.random() * 256);
                return `${part1}.${part2}.${part3}.${part4}`;
            };

            // 生成随机 Session ID
            const generateSessionId = () => {
                const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
                let result = '';
                for (let i = 0; i < 24; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            };

            // 生成随机32位ID（用于 randomOut 等消息）
            const generateRandomId = () => {
                const chars = 'abcdef0123456789';
                let result = '';
                for (let i = 0; i < 32; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            };

            // 生成 Cookie 字符串
            const generateCookie = (userid, nickname) => {
                const sessionId = generateSessionId();
                const encodedNickname = encodeURIComponent(nickname);
                return `room_name_random=%E5%85%AC%E5%85%B1%E5%9C%BA%E6%89%80; room_psw_random=; userAge=0; switchvipsex=0; switchVipAddress=0; switchHealthMode=0; isMoon=-1; ASP.NET_SessionId=${sessionId}; user_id=${userid}; user_nickname_random=${encodedNickname}; SlideSysInfos=0`;
            };

            // 状态管理
            const activeTab = ref('history'); // 默认显示历史 tab，但不自动加载
            const isMatching = ref(false);
            const currentChatUser = ref(null);
            const inputText = ref('');
            const fileInput = ref(null);
            const chatBox = ref(null);
            const listArea = ref(null); // 列表区域引用
            const savedScrollPosition = ref(0); // 保存的滚动位置
            const showSettings = ref(false); // 显示设置面板
            const editMode = ref(false); // 编辑模式
            const isTyping = ref(false); // 对方是否正在输入
            const toastMessage = ref(''); // Toast 消息

            // 身份选择相关状态
            const showIdentityPicker = ref(true); // 是否显示身份选择页
            const identityList = ref([]); // 身份列表
            const identityLoading = ref(false); // 加载状态
            const showCreateForm = ref(false); // 显示创建表单
            const newIdentity = ref({ name: '', sex: '' }); // 新建身份表单数据
            const deleteConfirmIdentity = ref(null); // 待删除的身份（用于确认对话框）

            // Toast 显示方法
            const showToast = (message, duration = 2000) => {
                toastMessage.value = message;
                setTimeout(() => { toastMessage.value = ''; }, duration);
            };

            // 当前用户信息
            const currentUser = ref({
                id: '3cfbecb0a6224f9693315eeb3c89cde4',
                name: '哎吃',
                sex: '女',
                ip: '188.253.116.115',
                address: '美国'
            });

            // 编辑用户信息（副本）
            const editUserInfo = ref({
                id: '',
                name: '',
                sex: ''
            });

            // WebSocket 连接
            let ws = null;
            const wsConnected = ref(false);
            const waitingForResponse = ref(false); // 等待服务器响应
            const imgServer = ref(''); // 图片服务器地址
            const uploadedMedia = ref([]); // 已上传的媒体列表 [{url: 'xxx', type: 'image/video'}]
            const showUploadMenu = ref(false); // 显示上传菜单
            const loadingMore = ref(false); // 加载更多历史消息中
            const firstTidMap = ref({}); // 存储每个聊天的最早消息Tid

            // 数据源
            const historyUsers = ref([]); // 历史用户列表
            const favoriteUsers = ref([]); // 收藏用户列表
            const historyLoaded = ref(false); // 历史列表是否已加载
            const favoriteLoaded = ref(false); // 收藏列表是否已加载

            const chatHistory = ref({});

            // 计算属性：列表显示
            const displayList = computed(() => {
                if (activeTab.value === 'favorites') {
                    return favoriteUsers.value;
                }
                return historyUsers.value;
            });

            // --- 功能逻辑 ---

            // 获取颜色类（用于身份卡片）
            const getColorClass = (id) => {
                const colors = ['bg-color-1', 'bg-color-2', 'bg-color-3', 'bg-color-4', 'bg-color-5'];
                const hash = id.charCodeAt(0) + id.charCodeAt(1);
                return colors[hash % colors.length];
            };

            // 加载身份列表
            const loadIdentityList = async () => {
                identityLoading.value = true;
                try {
                    const response = await fetch(`${API_BASE}/getIdentityList`);
                    const result = await response.json();
                    if (result.code === 0) {
                        identityList.value = result.data || [];
                        console.log('加载身份列表成功:', identityList.value.length, '个身份');
                    } else {
                        console.error('加载身份列表失败:', result.msg);
                    }
                } catch (error) {
                    console.error('加载身份列表出错:', error);
                } finally {
                    identityLoading.value = false;
                }
            };

            // 选择身份
            const selectIdentity = async (identity) => {
                console.log('选择身份:', identity);

                // 更新当前用户信息
                currentUser.value.id = identity.id;
                currentUser.value.name = identity.name;
                currentUser.value.sex = identity.sex;

                // 通知后端更新使用时间
                try {
                    await fetch(`${API_BASE}/selectIdentity?id=${identity.id}`, { method: 'POST' });
                } catch (error) {
                    console.error('更新身份使用时间失败:', error);
                }

                // 隐藏身份选择页，进入主页面
                showIdentityPicker.value = false;

                // 连接WebSocket
                connectWebSocket();
            };

            // 创建新身份
            const createIdentity = async () => {
                if (!newIdentity.value.name || !newIdentity.value.sex) {
                    showToast('请填写完整信息');
                    return;
                }

                try {
                    const params = new URLSearchParams();
                    params.append('name', newIdentity.value.name);
                    params.append('sex', newIdentity.value.sex);

                    const response = await fetch(`${API_BASE}/createIdentity`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: params
                    });

                    const result = await response.json();
                    if (result.code === 0) {
                        console.log('创建身份成功:', result.data);
                        showCreateForm.value = false;
                        newIdentity.value = { name: '', sex: '' };

                        // 选择刚创建的身份
                        selectIdentity(result.data);
                    } else {
                        showToast(result.msg || '创建失败');
                    }
                } catch (error) {
                    console.error('创建身份出错:', error);
                    showToast('创建失败，请重试');
                }
            };

            // 快速创建随机身份
            const quickCreateIdentity = async () => {
                identityLoading.value = true;
                try {
                    const response = await fetch(`${API_BASE}/quickCreateIdentity`, { method: 'POST' });
                    const result = await response.json();

                    if (result.code === 0) {
                        console.log('快速创建身份成功:', result.data);
                        // 选择刚创建的身份
                        selectIdentity(result.data);
                    } else {
                        showToast(result.msg || '创建失败');
                    }
                } catch (error) {
                    console.error('快速创建身份出错:', error);
                    showToast('创建失败，请重试');
                } finally {
                    identityLoading.value = false;
                }
            };

            // 显示删除确认对话框
            const showDeleteConfirm = (identity) => {
                console.log('准备删除身份:', identity);
                deleteConfirmIdentity.value = identity;
            };

            // 确认删除身份
            const confirmDeleteIdentity = async () => {
                const identity = deleteConfirmIdentity.value;
                if (!identity) return;

                try {
                    const params = new URLSearchParams();
                    params.append('id', identity.id);

                    const response = await fetch(`${API_BASE}/deleteIdentity`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: params
                    });

                    const result = await response.json();
                    console.log('删除身份响应:', result);

                    if (result.code === 0) {
                        // 从列表中移除
                        identityList.value = identityList.value.filter(item => item.id !== identity.id);
                        deleteConfirmIdentity.value = null;
                        showToast('已删除');
                    } else {
                        alert('删除失败: ' + (result.msg || '未知错误'));
                    }
                } catch (error) {
                    console.error('删除身份出错:', error);
                    alert('删除失败，请重试');
                }
            };

            // 0. 上报访问记录
            const reportReferrer = async () => {
                try {
                    console.log('上报访问记录...');

                    const referrerUrl = document.referrer || '';
                    const currUrl = encodeURIComponent('http://v1.chat2019.cn/randomdeskrynewjc46ko.html?v=jc46ko');
                    const userid = currentUser.value.id;
                    const cookieData = generateCookie(userid, currentUser.value.name);
                    const referer = 'http://v1.chat2019.cn/randomdeskrynewjc46ko.html?v=jc46ko';
                    const userAgent = navigator.userAgent;

                    const params = new URLSearchParams();
                    params.append('referrerUrl', referrerUrl);
                    params.append('currUrl', currUrl);
                    params.append('userid', userid);
                    params.append('cookieData', cookieData);
                    params.append('referer', referer);
                    params.append('userAgent', userAgent);

                    const response = await fetch(`${API_BASE}/reportReferrer`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: params
                    });

                    const result = await response.text();
                    console.log('上报成功:', result);

                    // 上报完成后获取图片服务器地址
                    await getImgServer();

                    return true;

                } catch (error) {
                    console.error('上报访问记录失败:', error);
                    return false;
                }
            };

            // 获取图片服务器地址
            const getImgServer = async () => {
                try {
                    console.log('获取图片服务器地址...');

                    const response = await fetch(`${API_BASE}/getImgServer`);

                    if (!response.ok) {
                        console.warn('图片服务器接口返回错误:', response.status);
                        return;
                    }

                    const data = await response.json();
                    console.log('图片服务器数据:', data);

                    // 解析并保存图片服务器地址
                    if (data.state === 'OK' && data.msg && data.msg.server) {
                        imgServer.value = data.msg.server;
                        console.log('图片服务器地址:', imgServer.value);

                        // 通知后端更新图片服务器地址
                        const params = new URLSearchParams();
                        params.append('server', imgServer.value);

                        await fetch(`${API_BASE}/updateImgServer`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: params
                        });

                        console.log('已通知后端更新图片服务器地址');

                        // 获取缓存的图片列表
                        await loadCachedImages();
                    }

                } catch (error) {
                    console.error('获取图片服务器地址失败:', error);
                }
            };

            // 加载缓存的图片列表
            const loadCachedImages = async () => {
                try {
                    console.log('加载缓存图片列表...');

                    const response = await fetch(`${API_BASE}/getCachedImages?userid=${currentUser.value.id}`);

                    if (!response.ok) {
                        console.warn('获取缓存图片失败:', response.status);
                        return;
                    }

                    const data = await response.json();
                    console.log('缓存图片数据:', data);

                    if (Array.isArray(data)) {
                        // 将URL数组转换为媒体对象数组（根据扩展名判断类型）
                        // 倒序排列，最新上传的在前面
                        uploadedMedia.value = data.reverse().map(url => ({
                            url: url,
                            type: url.toLowerCase().endsWith('.mp4') ? 'video' : 'image'
                        }));
                        console.log('加载了', data.length, '个缓存文件（倒序显示）');
                    }

                } catch (error) {
                    console.error('加载缓存图片失败:', error);
                }
            };

            // 1. 数据加载逻辑
            const loadHistoryUsers = async () => {
                if (historyLoaded.value) {
                    console.log('历史用户列表已加载，跳过');
                    return;
                }

                try {
                    console.log('加载历史用户列表...');

                    // 准备参数
                    const userid = currentUser.value.id;
                    const cookieData = generateCookie(userid, currentUser.value.name);
                    const referer = 'http://v1.chat2019.cn/randomdeskrynewjc46ko.html?v=jc46ko';
                    const userAgent = navigator.userAgent;

                    const params = new URLSearchParams();
                    params.append('myUserID', userid);
                    params.append('vipcode', '');
                    params.append('serverPort', '1001');
                    params.append('cookieData', cookieData);
                    params.append('referer', referer);
                    params.append('userAgent', userAgent);

                    const response = await fetch(`${API_BASE}/getHistoryUserList`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: params
                    });

                    if (!response.ok) {
                        console.warn('历史用户列表接口返回错误:', response.status);
                        historyUsers.value = [];
                        historyLoaded.value = true;
                        return;
                    }

                    const data = await response.json();
                    console.log('历史用户数据:', data);

                    // 检查是否有错误
                    if (data.error) {
                        console.warn('历史用户列表加载失败:', data.error);
                        historyUsers.value = [];
                        historyLoaded.value = true;
                        return;
                    }

                    // 转换数据格式，并过滤掉自己
                    historyUsers.value = data
                        .filter(user => user.id !== currentUser.value.id)  // 过滤掉自己
                        .map(user => ({
                            id: user.id,
                            name: user.nickname,
                            lastMsg: '暂无消息',
                            lastTime: '刚刚',
                            isFavorite: false,
                            colorClass: getRandomColor(),
                            sex: user.sex || user.userSex || '未知',
                            age: user.age || user.userAge || '0',
                            address: user.address || user.userAddress || '未知',
                            unreadCount: 0  // 未读消息数
                        }));

                    historyLoaded.value = true;
                    console.log('历史用户列表加载完成（已过滤自己）:', historyUsers.value.length);
                } catch (error) {
                    console.error('加载历史用户失败:', error);
                    historyUsers.value = [];
                    historyLoaded.value = true;
                }
            };

            const loadFavoriteUsers = async () => {
                if (favoriteLoaded.value) {
                    console.log('收藏用户列表已加载，跳过');
                    return;
                }

                try {
                    console.log('加载收藏用户列表...');

                    // 准备参数
                    const userid = currentUser.value.id;
                    const cookieData = generateCookie(userid, currentUser.value.name);
                    const referer = 'http://v1.chat2019.cn/randomdeskrynewjc46ko.html?v=jc46ko';
                    const userAgent = navigator.userAgent;

                    const params = new URLSearchParams();
                    params.append('myUserID', userid);
                    params.append('vipcode', '');
                    params.append('serverPort', '1001');
                    params.append('cookieData', cookieData);
                    params.append('referer', referer);
                    params.append('userAgent', userAgent);

                    const response = await fetch(`${API_BASE}/getFavoriteUserList`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: params
                    });

                    if (!response.ok) {
                        console.warn('收藏用户列表接口返回错误:', response.status);
                        favoriteUsers.value = [];
                        favoriteLoaded.value = true;
                        return;
                    }

                    const data = await response.json();
                    console.log('收藏用户数据:', data);

                    // 检查是否有错误
                    if (data.error) {
                        console.warn('收藏用户列表加载失败:', data.error);
                        favoriteUsers.value = [];
                        favoriteLoaded.value = true;
                        return;
                    }

                    // 转换数据格式，并过滤掉自己
                    favoriteUsers.value = data
                        .filter(user => user.id !== currentUser.value.id)  // 过滤掉自己
                        .map(user => ({
                            id: user.id,
                            name: user.nickname,
                            lastMsg: '暂无消息',
                            lastTime: '刚刚',
                            isFavorite: true,
                            colorClass: getRandomColor(),
                            sex: user.sex || user.userSex || '未知',
                            age: user.age || user.userAge || '0',
                            address: user.address || user.userAddress || '未知',
                            unreadCount: 0  // 未读消息数
                        }));

                    favoriteLoaded.value = true;
                    console.log('收藏用户列表加载完成（已过滤自己）:', favoriteUsers.value.length);
                } catch (error) {
                    console.error('加载收藏用户失败:', error);
                    favoriteUsers.value = [];
                    favoriteLoaded.value = true;
                }
            };

            // 切换 Tab 时加载对应数据
            const switchTab = (tab) => {
                console.log('切换到 Tab:', tab);

                // 如果点击的是当前Tab，强制刷新
                if (activeTab.value === tab) {
                    console.log('点击当前Tab，强制刷新');
                    if (tab === 'history') {
                        historyLoaded.value = false;
                        loadHistoryUsers();
                    } else if (tab === 'favorites') {
                        favoriteLoaded.value = false;
                        loadFavoriteUsers();
                    }
                } else {
                    // 切换到不同Tab，不强制刷新（首次会自动加载）
                    console.log('切换到不同Tab');
                    activeTab.value = tab;
                    if (tab === 'history') {
                        loadHistoryUsers(); // 内部检查 historyLoaded
                    } else if (tab === 'favorites') {
                        loadFavoriteUsers(); // 内部检查 favoriteLoaded
                    }
                }
            };

            // 强制刷新列表
            const refreshCurrentList = () => {
                if (activeTab.value === 'history') {
                    historyLoaded.value = false;
                    loadHistoryUsers();
                } else if (activeTab.value === 'favorites') {
                    favoriteLoaded.value = false;
                    loadFavoriteUsers();
                }
            };

            // 加载消息历史
            const loadMessageHistory = async (userToID) => {
                console.log('=== 开始加载消息历史 ===');
                console.log('userToID=', userToID);
                console.log('myUserID=', currentUser.value.id);

                try {
                    // 准备参数
                    const myUserID = currentUser.value.id;
                    const cookieData = generateCookie(myUserID, currentUser.value.name);
                    const referer = 'http://v1.chat2019.cn/randomdeskrynewjc46ko.html?v=jc46ko';
                    const userAgent = navigator.userAgent;

                    const params = new URLSearchParams();
                    params.append('myUserID', myUserID);
                    params.append('UserToID', userToID);
                    params.append('isFirst', '1');
                    params.append('firstTid', '0');
                    params.append('vipcode', '');
                    params.append('serverPort', '1001');
                    params.append('cookieData', cookieData);
                    params.append('referer', referer);
                    params.append('userAgent', userAgent);

                    console.log('发送请求到 /api/getMessageHistory');

                    const response = await fetch(`${API_BASE}/getMessageHistory`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: params
                    });

                    console.log('接口响应状态:', response.status);

                    if (!response.ok) {
                        console.warn('消息历史接口返回错误:', response.status);
                        // 初始化为空数组
                        if (!chatHistory.value[userToID]) {
                            chatHistory.value[userToID] = [];
                        }
                        return;
                    }

                    const data = await response.json();
                    console.log('消息历史数据:', data);

                    // 检查是否有错误
                    if (data.error) {
                        console.warn('消息历史加载失败:', data.error);
                        if (!chatHistory.value[userToID]) {
                            chatHistory.value[userToID] = [];
                        }
                        return;
                    }

                    // 解析消息历史数据
                    if (data.code === 0 && data.contents_list && Array.isArray(data.contents_list)) {
                        // 转换消息格式，contents_list 是倒序的（最新在前），需要反转
                        const messages = data.contents_list.reverse().map(msg => {
                            // 判断逻辑：如果发送者不是对方，就是我发送的
                            const isSelf = msg.id !== userToID;
                            console.log('消息:', msg.content, '| msg.id=', msg.id, '| userToID=', userToID, '| isSelf=', isSelf);

                            // 检查是否是图片消息（格式：[path/to/image.jpg]）
                            let content = msg.content;
                            let type = 'text';

                            // 检查是否是图片消息
                            if (content.startsWith('[') && content.endsWith(']') &&
                                (content.includes('.jpg') || content.includes('.png') || content.includes('.jpeg') || content.includes('.gif'))) {
                                // 提取图片路径
                                const imagePath = content.substring(1, content.length - 1);
                                // 拼接完整URL
                                content = `http://${imgServer.value}:9006/img/Upload/${imagePath}`;
                                type = 'image';
                                console.log('图片消息，拼接URL:', content);
                            }
                            // 检查是否是视频消息
                            else if (content.startsWith('[') && content.endsWith(']') && content.includes('.mp4')) {
                                // 提取视频路径
                                const videoPath = content.substring(1, content.length - 1);
                                // 拼接完整URL
                                content = `http://${imgServer.value}:9006/img/Upload/${videoPath}`;
                                type = 'video';
                                console.log('视频消息，拼接URL:', content);
                            }

                            return {
                                type: type,
                                content: content,
                                isSelf: isSelf,
                                time: msg.time,
                                nickname: msg.nickname,
                                tid: msg.Tid
                            };
                        });

                        chatHistory.value[userToID] = messages;
                        // 保存最早消息的 Tid 用于加载更多
                        if (messages.length > 0) {
                            firstTidMap.value[userToID] = messages[0].tid;
                        }
                        console.log('消息历史加载完成:', messages.length, '条消息, firstTid=', firstTidMap.value[userToID]);
                    } else {
                        // 如果没有历史消息或返回格式不对，初始化为空数组
                        if (!chatHistory.value[userToID]) {
                            chatHistory.value[userToID] = [];
                        }
                        console.log('没有历史消息');
                    }

                } catch (error) {
                    console.error('加载消息历史失败:', error);
                    // 初始化为空数组
                    if (!chatHistory.value[userToID]) {
                        chatHistory.value[userToID] = [];
                    }
                }
            };

            // 加载更多历史消息
            const loadMoreHistory = async () => {
                if (!currentChatUser.value || loadingMore.value) return;

                const userToID = currentChatUser.value.id;
                const firstTid = firstTidMap.value[userToID] || '0';

                console.log('=== 加载更多历史消息 ===');
                console.log('userToID=', userToID, 'firstTid=', firstTid);

                loadingMore.value = true;

                try {
                    const myUserID = currentUser.value.id;
                    const cookieData = generateCookie(myUserID, currentUser.value.name);
                    const referer = 'http://v1.chat2019.cn/randomdeskrynewjc46ko.html?v=jc46ko';
                    const userAgent = navigator.userAgent;

                    const params = new URLSearchParams();
                    params.append('myUserID', myUserID);
                    params.append('UserToID', userToID);
                    params.append('isFirst', '0');
                    params.append('firstTid', firstTid);
                    params.append('vipcode', '');
                    params.append('serverPort', '1001');
                    params.append('cookieData', cookieData);
                    params.append('referer', referer);
                    params.append('userAgent', userAgent);

                    const response = await fetch(`${API_BASE}/getMessageHistory`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: params
                    });

                    if (!response.ok) {
                        console.warn('加载更多历史消息失败:', response.status);
                        loadingMore.value = false;
                        return;
                    }

                    const data = await response.json();
                    console.log('更多历史消息数据:', data);

                    if (data.code === 0 && data.contents_list && Array.isArray(data.contents_list) && data.contents_list.length > 0) {
                        const newMessages = data.contents_list.reverse().map(msg => {
                            const isSelf = msg.id !== userToID;
                            let content = msg.content;
                            let type = 'text';

                            if (content.startsWith('[') && content.endsWith(']') &&
                                (content.includes('.jpg') || content.includes('.png') || content.includes('.jpeg') || content.includes('.gif'))) {
                                const imagePath = content.substring(1, content.length - 1);
                                content = `http://${imgServer.value}:9006/img/Upload/${imagePath}`;
                                type = 'image';
                            }

                            return { type, content, isSelf, time: msg.time, nickname: msg.nickname, tid: msg.Tid };
                        });

                        // 将新消息插入到现有消息的前面
                        chatHistory.value[userToID] = [...newMessages, ...chatHistory.value[userToID]];

                        // 更新最早消息的 Tid
                        if (newMessages.length > 0) {
                            firstTidMap.value[userToID] = newMessages[0].tid;
                        }

                        console.log('加载更多完成:', newMessages.length, '条消息');
                        showToast(`加载了 ${newMessages.length} 条历史消息`);
                    } else {
                        showToast('没有更多历史消息了');
                    }

                } catch (error) {
                    console.error('加载更多历史消息失败:', error);
                    showToast('加载失败');
                } finally {
                    loadingMore.value = false;
                }
            };

            // 2. 匹配逻辑
            const startMatch = () => {
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    alert('WebSocket 未连接，无法匹配');
                    return;
                }

                isMatching.value = true;

                // 发送随机匹配消息
                const randomMessage = {
                    "act": "random",
                    "id": currentUser.value.id,
                    "userAge": "0"
                };

                ws.send(JSON.stringify(randomMessage));
                console.log('发送随机匹配消息:', randomMessage);
            };

            const cancelMatch = () => {
                isMatching.value = false;

                // 发送取消匹配消息
                if (ws && ws.readyState === WebSocket.OPEN) {
                    const cancelMessage = {
                        "act": "randomOut",
                        "id": currentUser.value.id,
                        "msg": generateRandomId()  // 使用随机32位ID
                    };
                    ws.send(JSON.stringify(cancelMessage));
                    console.log('发送取消匹配消息:', cancelMessage);
                }
            };

            // 2. 聊天室逻辑
            const enterChat = async (user, loadHistory = true) => {
                console.log('进入聊天界面, user=', user, 'loadHistory=', loadHistory);

                // 保存当前列表的滚动位置
                if (listArea.value) {
                    savedScrollPosition.value = listArea.value.scrollTop;
                    console.log('保存滚动位置:', savedScrollPosition.value);
                }

                // 清零未读消息数
                if (user.unreadCount && user.unreadCount > 0) {
                    console.log('清零未读消息数:', user.unreadCount, '→ 0');
                    user.unreadCount = 0;
                }

                currentChatUser.value = user;
                isTyping.value = false; // 清除正在输入状态

                // 根据参数决定是否加载历史消息
                if (loadHistory) {
                    console.log('加载消息历史, user.id=', user.id);
                    await loadMessageHistory(user.id);
                }

                // 直接滚动到最新消息
                scrollToBottom();
            };

            const exitChat = () => {
                currentChatUser.value = null;
                isTyping.value = false; // 清除正在输入状态

                // 恢复列表的滚动位置
                nextTick(() => {
                    if (listArea.value && savedScrollPosition.value > 0) {
                        listArea.value.scrollTop = savedScrollPosition.value;
                        console.log('恢复滚动位置:', savedScrollPosition.value);
                    }
                });
            };

            const toggleFavorite = async (user) => {
                try {
                    const myUserID = currentUser.value.id;
                    const cookieData = generateCookie(myUserID, currentUser.value.name);
                    const referer = 'http://v1.chat2019.cn/randomdeskrynewjc46ko.html?v=jc46ko';
                    const userAgent = navigator.userAgent;

                    const params = new URLSearchParams();
                    params.append('myUserID', myUserID);
                    params.append('UserToID', user.id);
                    params.append('vipcode', '');
                    params.append('serverPort', '1001');
                    params.append('cookieData', cookieData);
                    params.append('referer', referer);
                    params.append('userAgent', userAgent);

                    const response = await fetch(`${API_BASE}/toggleFavorite`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: params
                    });

                    const data = await response.json();
                    console.log('收藏操作结果:', data);

                    if (data.state === 'OK') {
                        user.isFavorite = !user.isFavorite;
                        showToast(user.isFavorite ? '已收藏' : '已取消收藏');
                    } else {
                        showToast('操作失败: ' + (data.msg || '未知错误'));
                    }
                } catch (error) {
                    console.error('收藏操作失败:', error);
                    showToast('操作失败');
                }
            };

            // 3. 发送消息逻辑
            const sendMessage = () => {
                if (!inputText.value.trim()) return;

                const message = inputText.value;

                // 通过 WebSocket 发送消息
                if (ws && ws.readyState === WebSocket.OPEN) {
                    // 构造发送消息格式
                    const toUserMessage = {
                        "act": `touser_${currentChatUser.value.id}_${currentChatUser.value.name}`,
                        "id": currentUser.value.id,
                        "msg": message
                    };

                    ws.send(JSON.stringify(toUserMessage));
                    console.log('发送消息，等待服务器回显:', toUserMessage);
                } else {
                    console.error('WebSocket 未连接');
                    alert('连接已断开，请刷新页面重试');
                    return;
                }

                // 清空输入框
                inputText.value = '';
            };

            // 4. 文件发送逻辑
            const selectFile = () => {
                console.log('切换上传菜单');
                showUploadMenu.value = !showUploadMenu.value;
            };

            const triggerFileSelect = () => {
                console.log('选择上传文件');
                fileInput.value.click();
            };

            const handleFileUpload = async (e) => {
                console.log('handleFileUpload 被调用');
                const file = e.target.files[0];
                if (!file) {
                    console.log('没有选择文件');
                    return;
                }

                console.log('选择文件:', file.name, file.type, file.size);

                // 关闭上传菜单
                showUploadMenu.value = false;

                // 判断文件类型并上传
                if (file.type.startsWith('image/')) {
                    // 图片文件 - 上传到服务器
                    await uploadImage(file, 'image');
                } else if (file.type.startsWith('video/')) {
                    // 视频文件 - 上传到服务器
                    await uploadImage(file, 'video');
                } else {
                    // 其他文件类型 - 作为图片上传尝试
                    await uploadImage(file, 'image');
                }

                e.target.value = ''; // 重置 input
            };

            // 上传图片/视频
            const uploadImage = async (file, fileType = 'image') => {
                try {
                    console.log('=== 开始上传文件 ===');
                    console.log('文件名:', file.name);
                    console.log('文件大小:', file.size);
                    console.log('文件类型:', fileType);
                    console.log('图片服务器地址:', imgServer.value);

                    if (!imgServer.value) {
                        alert('图片服务器地址未获取，请刷新页面重试');
                        return;
                    }

                    // 构造 FormData
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('userid', currentUser.value.id);

                    // 添加 headers 参数
                    const cookieData = generateCookie(currentUser.value.id, currentUser.value.name);
                    const referer = 'http://v1.chat2019.cn/randomdeskrynewjc46ko.html?v=jc46ko';
                    const userAgent = navigator.userAgent;

                    formData.append('cookieData', cookieData);
                    formData.append('referer', referer);
                    formData.append('userAgent', userAgent);

                    console.log('发送上传请求...');

                    // 调用后端上传接口
                    const response = await fetch(`${API_BASE}/uploadImage`, {
                        method: 'POST',
                        body: formData
                    });

                    console.log('上传响应状态:', response.status);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('文件上传失败:', response.status, errorText);
                        alert('文件上传失败: ' + errorText);
                        return;
                    }

                    const data = await response.json();
                    console.log('文件上传返回:', data);

                    // 检查上传结果
                    if (data.state === 'OK' && data.msg) {
                        // 构造文件完整URL（端口9006，路径前缀 /img/Upload/）
                        const mediaUrl = `http://${imgServer.value}:9006/img/Upload/${data.msg}`;
                        console.log('文件服务器URL:', mediaUrl);

                        // 添加到已上传媒体列表开头（最新在前）
                        uploadedMedia.value.unshift({ url: mediaUrl, type: fileType });
                        console.log('已保存到上传历史，当前共', uploadedMedia.value.length, '个文件');

                        // 不关闭菜单，让用户预览并选择是否发送
                        console.log('文件上传成功，保持在上传菜单预览');

                    } else {
                        alert('文件上传失败: ' + (data.error || '未知错误'));
                    }

                } catch (error) {
                    console.error('上传文件异常:', error);
                    alert('文件上传异常: ' + error.message);
                }
            };

            // 辅助函数
            const pushMessage = (type, content, isSelf, time = null) => {
                const uid = currentChatUser.value.id;
                if (!chatHistory.value[uid]) chatHistory.value[uid] = [];
                // 如果没有传入时间，使用当前时间
                const msgTime = time || new Date().toISOString().replace('T', ' ').substring(0, 23);
                chatHistory.value[uid].push({ type, content, isSelf, time: msgTime });
                scrollToBottom();
            };

            const scrollToBottom = () => {
                nextTick(() => {
                    if (chatBox.value) {
                        chatBox.value.scrollTop = chatBox.value.scrollHeight;
                    }
                });
            };

            // 格式化时间显示
            const formatTime = (timeStr) => {
                if (!timeStr) return '';
                // 格式: 2025-12-18 03:02:11.721 → 2025-12-18 03:02:11
                const match = timeStr.match(/(\d{4}-\d{2}-\d{2})\s+(\d{2}:\d{2}:\d{2})/);
                return match ? `${match[1]} ${match[2]}` : timeStr;
            };

            const autoResize = (e) => {
                // 简单的输入框高度自适应
                e.target.style.height = 'auto';
                e.target.style.height = (e.target.scrollHeight) + 'px';
            };

            const previewMedia = (src) => {
                console.log("预览图片:", src);
            };

            // 发送已上传的图片/视频
            const sendMediaMessage = (media) => {
                console.log('发送已上传的媒体:', media);

                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    alert('WebSocket 未连接，无法发送');
                    return;
                }

                if (!currentChatUser.value) {
                    alert('请先选择聊天对象');
                    return;
                }

                // 从完整URL中提取文件路径
                // 例如：http://149.88.79.98:9006/img/Upload/2025/12/18/Random/xxx.jpg
                // 提取：2025/12/18/Random/xxx.jpg
                const urlPattern = /\/img\/Upload\/(.+)$/;
                const match = media.url.match(urlPattern);

                if (!match) {
                    console.error('无法提取文件路径:', media.url);
                    alert('文件路径格式错误');
                    return;
                }

                const filePath = match[1];
                console.log('提取文件路径:', filePath);

                // 构造消息（用方括号包裹路径）
                const message = {
                    "act": `touser_${currentChatUser.value.id}_${currentChatUser.value.name}`,
                    "id": currentUser.value.id,
                    "msg": `[${filePath}]`
                };

                // 发送到 WebSocket
                ws.send(JSON.stringify(message));
                console.log('发送媒体消息，等待服务器回显:', message);

                // 关闭菜单
                showUploadMenu.value = false;
            };

            // 发送已上传的图片（兼容旧调用）
            const sendImageMessage = (imageUrl) => {
                sendMediaMessage({ url: imageUrl, type: 'image' });
            };

            // 保存用户信息
            const saveUserInfo = async () => {
                const idChanged = editUserInfo.value.id !== currentUser.value.id;
                const nameChanged = editUserInfo.value.name !== currentUser.value.name;
                const sexChanged = editUserInfo.value.sex !== currentUser.value.sex;

                if (!idChanged && !nameChanged && !sexChanged) {
                    alert('没有任何修改');
                    editMode.value = false;
                    return;
                }

                // 设置等待响应标志
                waitingForResponse.value = true;

                try {
                    // 如果 ID 改变了，调用更新ID接口
                    if (idChanged) {
                        console.log('ID改变，调用 updateIdentityId API');

                        const params = new URLSearchParams();
                        params.append('oldId', currentUser.value.id);
                        params.append('newId', editUserInfo.value.id);
                        params.append('name', editUserInfo.value.name);
                        params.append('sex', editUserInfo.value.sex);

                        const response = await fetch(`${API_BASE}/updateIdentityId`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: params
                        });

                        const data = await response.json();
                        console.log('updateIdentityId 响应:', data);

                        if (data.code !== 0) {
                            alert('更新失败: ' + (data.msg || '未知错误'));
                            waitingForResponse.value = false;
                            return;
                        }

                        // 更新成功，更新本地数据
                        currentUser.value.id = editUserInfo.value.id;
                        currentUser.value.name = editUserInfo.value.name;
                        currentUser.value.sex = editUserInfo.value.sex;

                        // 断开当前 WebSocket
                        if (ws) {
                            ws.close();
                        }

                        // 清空聊天历史和列表
                        chatHistory.value = {};
                        historyUsers.value = [];
                        favoriteUsers.value = [];
                        historyLoaded.value = false;
                        favoriteLoaded.value = false;
                        firstTidMap.value = {};

                        // 重新连接
                        connectWebSocket();

                        editMode.value = false;
                        showSettings.value = false;
                        waitingForResponse.value = false;
                        showToast('用户ID已更新，正在重新连接...');
                        return;
                    }

                    // 如果名字或性别改变（ID不变），调用更新接口
                    if (nameChanged || sexChanged) {
                        console.log('名字/性别改变，调用 updateIdentity API');

                        const params = new URLSearchParams();
                        params.append('id', currentUser.value.id);
                        params.append('name', editUserInfo.value.name);
                        params.append('sex', editUserInfo.value.sex);

                        const response = await fetch(`${API_BASE}/updateIdentity`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: params
                        });

                        const data = await response.json();
                        console.log('updateIdentity 响应:', data);

                        if (data.code !== 0) {
                            alert('更新失败: ' + (data.msg || '未知错误'));
                            waitingForResponse.value = false;
                            return;
                        }

                        // 检查 WebSocket 连接
                        if (!ws || ws.readyState !== WebSocket.OPEN) {
                            alert('数据库已更新，但WebSocket未连接，无法同步聊天状态');
                            waitingForResponse.value = false;
                            editMode.value = false;
                            return;
                        }

                        // 数据库更新成功，发送 WebSocket 消息

                        // 如果性别修改了，发送修改性别消息
                        if (sexChanged) {
                            const modInfoMessage = {
                                "act": "modinfo",
                                "id": currentUser.value.id,
                                "userSex": editUserInfo.value.sex,
                                "address_show": "false",
                                "randomhealthmode": "0",
                                "randomvipsex": "0",
                                "randomvipaddress": "0"
                            };
                            ws.send(JSON.stringify(modInfoMessage));
                            console.log('发送修改性别消息:', modInfoMessage);
                        }

                        // 如果名字修改了，发送修改名字消息
                        if (nameChanged) {
                            const chgNameMessage = {
                                "act": "chgname",
                                "id": currentUser.value.id,
                                "msg": editUserInfo.value.name
                            };
                            ws.send(JSON.stringify(chgNameMessage));
                            console.log('发送修改名字消息:', chgNameMessage);
                        }

                        // 更新本地数据
                        currentUser.value.name = editUserInfo.value.name;
                        currentUser.value.sex = editUserInfo.value.sex;

                        // 设置超时，等待服务器响应
                        setTimeout(() => {
                            if (waitingForResponse.value) {
                                waitingForResponse.value = false;
                                editMode.value = false;
                                showToast('信息已保存');
                            }
                        }, 2000);
                    }

                } catch (error) {
                    console.error('保存用户信息失败:', error);
                    alert('保存失败: ' + error.message);
                    waitingForResponse.value = false;
                }
            };

            // 监听编辑模式，初始化编辑数据
            const initEditMode = () => {
                editUserInfo.value.id = currentUser.value.id;
                editUserInfo.value.name = currentUser.value.name;
                editUserInfo.value.sex = currentUser.value.sex;
            };

            // WebSocket 连接逻辑
            const connectWebSocket = () => {
                console.log('正在连接 WebSocket:', WS_URL);

                ws = new WebSocket(WS_URL);

                ws.onopen = () => {
                    console.log('WebSocket 连接成功');
                    wsConnected.value = true;

                    // 连接成功后先上报访问记录
                    reportReferrer().then(() => {
                        console.log('上报完成，可以开始加载列表');
                    });

                    // 连接成功后发送登录消息
                    const signMessage = {
                        "act": "sign",
                        "id": currentUser.value.id,
                        "name": currentUser.value.name,
                        "userSex": currentUser.value.sex,
                        "address_show": "false",
                        "randomhealthmode": "0",
                        "randomvipsex": "0",
                        "randomvipaddress": "0",
                        "userip": currentUser.value.ip,
                        "useraddree": currentUser.value.address,
                        "randomvipcode": ""
                    };

                    const signMsg = JSON.stringify(signMessage);
                    ws.send(signMsg);
                    console.log('已发送登录消息:', signMsg);
                };

                ws.onmessage = (event) => {
                    console.log('收到消息:', event.data);

                    try {
                        // 尝试解析 JSON
                        const data = JSON.parse(event.data);

                        // 过滤系统消息（code: 12, 16, 18, 19 等），用 toast 显示
                        if (data.code === 12 || data.code === 16 || data.code === 18 || data.code === 19) {
                            console.log('系统消息，toast显示:', data);
                            if (data.content) {
                                showToast(data.content);
                            }
                            return;
                        }

                        // 处理正在输入消息
                        if (data.act && (data.act.startsWith('inputStatusOn_') || data.act.startsWith('inputStatusOff_'))) {
                            const isOn = data.act.startsWith('inputStatusOn_');
                            // 提取用户ID（格式：inputStatusOn_userId_nickname）
                            const parts = data.act.split('_');
                            const typingUserId = parts[1];

                            console.log('正在输入状态:', isOn ? '开始' : '结束', 'userId=', typingUserId);

                            // 如果当前正在和这个用户聊天，显示/隐藏正在输入提示
                            if (currentChatUser.value && currentChatUser.value.id === typingUserId) {
                                isTyping.value = isOn;
                                console.log('更新正在输入状态:', isTyping.value);

                                // 如果显示正在输入，滚动到底部
                                if (isOn) {
                                    scrollToBottom();
                                }
                            }
                            return;
                        }

                        // 处理聊天消息 (code: 7)
                        if (data.code === 7 && data.fromuser) {
                            console.log('收到聊天消息:', data);

                            const fromUserId = data.fromuser.id;
                            const toUserId = data.touser ? data.touser.id : null;
                            let messageContent = data.fromuser.content;
                            const fromUserNickname = data.fromuser.nickname;

                            console.log('解析消息 - fromUserId=', fromUserId, 'toUserId=', toUserId, 'currentUserId=', currentUser.value.id);
                            console.log('消息内容:', messageContent);
                            console.log('当前聊天对象:', currentChatUser.value ? currentChatUser.value.id : '无');

                            // 判断是不是自己发送的消息（通过nickname判断，因为fromuser.id是随机会话ID）
                            const isSelf = data.fromuser.nickname === currentUser.value.name;
                            console.log('isSelf=', isSelf, '(通过nickname判断)');

                            // 判断是否应该显示这条消息（通过nickname判断）
                            const shouldDisplay = currentChatUser.value &&
                                (data.fromuser.nickname === currentChatUser.value.name ||
                                 (data.touser && data.touser.nickname === currentChatUser.value.name));

                            console.log('shouldDisplay=', shouldDisplay);

                            // 检查是否是图片消息
                            let messageType = 'text';
                            if (messageContent.startsWith('[') && messageContent.endsWith(']') &&
                                (messageContent.includes('.jpg') || messageContent.includes('.png') || messageContent.includes('.jpeg') || messageContent.includes('.gif'))) {
                                // 提取图片路径
                                const imagePath = messageContent.substring(1, messageContent.length - 1);
                                // 拼接完整URL
                                messageContent = `http://${imgServer.value}:9006/img/Upload/${imagePath}`;
                                messageType = 'image';
                                console.log('图片消息，拼接URL:', messageContent);
                            }
                            // 检查是否是视频消息
                            else if (messageContent.startsWith('[') && messageContent.endsWith(']') && messageContent.includes('.mp4')) {
                                // 提取视频路径
                                const videoPath = messageContent.substring(1, messageContent.length - 1);
                                // 拼接完整URL
                                messageContent = `http://${imgServer.value}:9006/img/Upload/${videoPath}`;
                                messageType = 'video';
                                console.log('视频消息，拼接URL:', messageContent);
                            }

                            // 获取消息时间
                            const msgTime = data.fromuser.time || new Date().toISOString().replace('T', ' ').substring(0, 23);

                            if (shouldDisplay) {
                                // 收到消息，隐藏正在输入提示
                                if (!isSelf) {
                                    isTyping.value = false;
                                }

                                // 显示消息
                                console.log('✓ 显示消息在聊天界面:', messageContent, 'isSelf=', isSelf, 'type=', messageType);
                                pushMessage(messageType, messageContent, isSelf, msgTime);
                                currentChatUser.value.lastMsg = messageType === 'image' ? '[图片]' : (messageType === 'video' ? '[视频]' : messageContent);
                                currentChatUser.value.lastTime = '刚刚';
                            } else if (!isSelf) {
                                // 不在当前聊天界面，但收到消息 - 更新列表
                                console.log('✓ 更新列表中的消息');
                                const existingUser = historyUsers.value.find(u => u.id === fromUserId);
                                if (existingUser) {
                                    existingUser.lastMsg = messageType === 'image' ? '[图片]' : (messageType === 'video' ? '[视频]' : messageContent);
                                    existingUser.lastTime = '刚刚';
                                    existingUser.unreadCount = (existingUser.unreadCount || 0) + 1;  // 未读数+1
                                } else {
                                    // 如果列表中没有这个用户，添加到列表
                                    // 额外检查：确保不是自己（双重保险）
                                    if (fromUserId !== currentUser.value.id) {
                                        const newUser = {
                                            id: fromUserId,
                                            name: fromUserNickname,
                                            lastMsg: messageType === 'image' ? '[图片]' : (messageType === 'video' ? '[视频]' : messageContent),
                                            lastTime: '刚刚',
                                            isFavorite: false,
                                            colorClass: getRandomColor(),
                                            unreadCount: 1  // 新用户且有一条新消息
                                        };
                                        historyUsers.value.unshift(newUser);
                                    } else {
                                        console.log('忽略添加自己到列表');
                                    }
                                }

                                // 初始化聊天记录（如果不存在）
                                if (!chatHistory.value[fromUserId]) {
                                    chatHistory.value[fromUserId] = [];
                                }
                                chatHistory.value[fromUserId].push({
                                    type: messageType,
                                    content: messageContent,
                                    isSelf: false,
                                    time: msgTime
                                });
                            }
                            return;
                        }

                        // 处理匹配成功消息 (code: 15)
                        if (data.code === 15 && data.sel_userid) {
                            console.log('匹配成功:', data);
                            isMatching.value = false;

                            // 创建匹配到的用户
                            const matchedUser = {
                                id: data.sel_userid,
                                name: data.sel_userNikename || '匿名用户',
                                lastMsg: '匹配成功',
                                lastTime: '刚刚',
                                isFavorite: false,
                                colorClass: getRandomColor(),
                                sex: data.sel_userSex || '未知',
                                age: data.sel_userAge || '未知',
                                address: data.sel_userAddress || '未知',
                                unreadCount: 0  // 未读消息数
                            };

                            // 添加到历史列表并置顶
                            historyUsers.value.unshift(matchedUser);

                            // 初始化为空聊天记录
                            chatHistory.value[matchedUser.id] = [];

                            // 直接进入聊天（不加载历史记录）
                            enterChat(matchedUser, false);
                            return;
                        }

                        // 如果正在等待修改信息的响应
                        if (waitingForResponse.value) {
                            waitingForResponse.value = false;

                            // 弹出服务器返回的消息
                            if (data.content) {
                                alert('服务器响应: ' + data.content);
                            } else if (data.msg) {
                                alert('服务器响应: ' + data.msg);
                            } else {
                                alert('服务器响应: ' + event.data);
                            }

                            // 退出编辑模式
                            editMode.value = false;
                            return;
                        }

                        // 如果当前在聊天界面，显示收到的消息
                        if (currentChatUser.value) {
                            const messageContent = data.content || event.data;
                            pushMessage('text', messageContent, false);
                            currentChatUser.value.lastMsg = messageContent;
                            currentChatUser.value.lastTime = '刚刚';
                        }
                    } catch (e) {
                        // 如果不是 JSON，直接显示
                        if (currentChatUser.value) {
                            pushMessage('text', event.data, false);
                            currentChatUser.value.lastMsg = event.data;
                            currentChatUser.value.lastTime = '刚刚';
                        }
                    }
                };

                ws.onerror = (error) => {
                    console.error('WebSocket 错误:', error);
                    wsConnected.value = false;
                };

                ws.onclose = () => {
                    console.log('WebSocket 连接关闭');
                    wsConnected.value = false;

                    // 尝试重连
                    setTimeout(() => {
                        console.log('尝试重新连接...');
                        connectWebSocket();
                    }, 3000);
                };
            };

            // 页面加载时先加载身份列表（不自动连接WebSocket）
            loadIdentityList();

            // 初始化编辑数据
            initEditMode();

            // 不再自动加载列表，等待用户点击 Tab

            return {
                activeTab, isMatching, historyUsers, favoriteUsers, displayList,
                currentChatUser, chatHistory, inputText, fileInput, chatBox, listArea,
                wsConnected, showSettings, currentUser, editMode, editUserInfo, waitingForResponse, imgServer, isTyping, uploadedMedia, toastMessage, loadingMore,
                // 上传菜单相关
                showUploadMenu, triggerFileSelect, sendMediaMessage,
                // 身份选择相关
                showIdentityPicker, identityList, identityLoading, showCreateForm, newIdentity, deleteConfirmIdentity,
                getColorClass, loadIdentityList, selectIdentity, createIdentity, quickCreateIdentity, showDeleteConfirm, confirmDeleteIdentity,
                // 原有功能
                startMatch, cancelMatch, enterChat, exitChat, toggleFavorite,
                sendMessage, selectFile, handleFileUpload, autoResize, previewMedia, sendImageMessage, formatTime, loadMoreHistory,
                loadHistoryUsers, loadFavoriteUsers, saveUserInfo, initEditMode, switchTab, refreshCurrentList, loadMessageHistory
            };
        }
    }).mount('#app');
</script>
</body>
</html>